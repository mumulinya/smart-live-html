<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <title>æ™ºè¯„ç”Ÿæ´»</title>
  <!-- å¼•å…¥æ ·å¼ -->
  <link rel="stylesheet" href="./css/element.css">
  <link href="./css/main.css" rel="stylesheet">
  <link href="./css/info.css" rel="stylesheet">

  <style type="text/css">
      .el-tabs--bottom .el-tabs__item.is-bottom:nth-child(2), .el-tabs--bottom .el-tabs__item.is-top:nth-child(2), .el-tabs--top .el-tabs__item.is-bottom:nth-child(2), .el-tabs--top .el-tabs__item.is-top:nth-child(2) {
          padding-left: 15px;
      }
      .el-tabs, .el-tab-pane{
          height: 100%;
      }
      .el-tabs__header{
          height: 10%;
      }
      .el-tabs__content{
          height: 90%;
      }
      /* ğŸ”¥ æ›¿æ¢è¿™é‡Œçš„æ ·å¼ä»£ç  */
      .action-buttons {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-shrink: 0;
        margin-left: auto;
        padding-left: 15px;
      }

      .message-btn {
        padding: 8px 16px;
        background-color: #07c160;
        color: white;
        border-radius: 20px;
        cursor: pointer;
        font-size: 14px;
        min-width: 60px;
        text-align: center;
      }

      .message-btn:hover {
        background-color: #06a652;
      }

      .logout-btn {
        padding: 8px 16px;
        background-color: #ff6633;
        color: white;
        border-radius: 20px;
        cursor: pointer;
        font-size: 14px;
        min-width: 60px;
      }
      /* ğŸ”¥ æ–°å¢åŸºç¡€ä¿¡æ¯åŒºåŸŸæ ·å¼ */
      .basic {
        display: flex;
        align-items: flex-start;
        padding: 15px;
        position: relative;
      }

      .basic-icon {
        flex-shrink: 0;
        margin-right: 15px;
      }

      .basic-info {
        flex: 1;
        min-width: 0;
      }

      .basic-info .name {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 5px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .basic-info span {
        font-size: 14px;
        color: #666;
      }
  </style>

</head>

<body>
<div id="app">
  <div class="header">
    <div class="header-back-btn" @click="goBack"><i class="el-icon-arrow-left"></i></div>
    <div class="header-title">&nbsp;&nbsp;&nbsp;</div>
  </div>
  <div class="basic">
    <div class="basic-icon">
      <img :src="user.icon || '/imgs/icons/default-icon.png'" alt="">
    </div>
    <div class="basic-info">
      <div class="name">{{user.nickName}}</div>
      <span>æ­å·</span>
    </div>
    <div class="action-buttons">
      <div class="logout-btn" @click="follow">
        {{followed ? "å–æ¶ˆå…³æ³¨" : "å…³æ³¨"}}
      </div>
      <div class="message-btn" @click="sendPrivateMessage">
        ç§ä¿¡
      </div>
    </div>
  </div>
  <div class="introduce">
    <span v-if="info.introduce"></span>
    <span v-else>è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡æœ‰ç•™ä¸‹</span>
  </div>
  <div class="content">
    <el-tabs v-model="activeName" @tab-click="handleClick">
      <el-tab-pane label="ç¬”è®°" name="1">
        <div v-for="b in blogs" :key="b.id" class="blog-item">
          <div class="blog-img"><img :src="b.images.split(',')[0]" alt=""></div>
          <div class="blog-info">
            <div class="blog-title" v-html="b.title"></div>
            <div class="blog-liked"><img src="/imgs/thumbup.png" alt=""> {{b.liked}}</div>
            <div class="blog-comments"><i class="el-icon-chat-dot-round"></i> {{b.comments}}</div>
          </div>
        </div>
      </el-tab-pane>
      <el-tab-pane label="å…±åŒå…³æ³¨" name="2">
        <div>ä½ ä»¬éƒ½å…³æ³¨äº†ï¼š</div>
        <div class="follow-info" v-for="u in commonFollows" :key="u.id">
          <div class="follow-info-icon" @click="toOtherInfo(u.id)">
            <img :src="u.icon || '/imgs/icons/default-icon.png'" alt="">
          </div>
          <div class="follow-info-name">
            <div class="name">{{u.nickName}}</div>
          </div>
          <div class="follow-info-btn" @click="toOtherInfo(u.id)">
              å»ä¸»é¡µçœ‹çœ‹
          </div>
        </div>
      </el-tab-pane>
    </el-tabs>
  </div>
  <foot-bar :active-btn="0"></foot-bar>
</div>
<script src="./js/vue.js"></script>
<script src="./js/axios.min.js"></script>
<!-- å¼•å…¥ç»„ä»¶åº“ -->
<script src="./js/element.js"></script>
<script src="./js/common.js"></script>
<script src="./js/footer.js"></script>
<script>
  const app = new Vue({
    el: "#app",
    data: {
      util,
      user: "",
      loginUser: {},
      activeName: "1",
      sessionId: "",
      info: {},
      blogs: [],
      followed: false, // æ˜¯å¦å…³æ³¨äº†
      commonFollows: [], // å…±åŒå…³æ³¨
    },
        created() {
      this.queryUser();
      this.queryLoginUser();
    },
    methods: {
      queryBlogs() {
        axios.get("/app/blog/of/user", {
            params: {id: this.user.id, current: 1}
          })
          .then(({data}) => this.blogs = data)
          .catch(this.$message.error)
      },
      queryLoginUser() {
        // æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
        axios.get("/app/user/me")
          .then(({data}) => {
            // ä¿å­˜ç”¨æˆ·
            this.loginUser = data;
          })
          .catch(console.log)
      },
      queryUser() {
        // æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
        let id = util.getUrlParam("id")
        axios.get("/app/user/" + id)
          .then(({data}) => {
            // ä¿å­˜ç”¨æˆ·
            this.user = data;
            // æŸ¥è¯¢ç”¨æˆ·è¯¦æƒ…
            this.queryUserInfo();
            // æŸ¥è¯¢ç”¨æˆ·ç¬”è®°
            this.queryBlogs();
            // æ˜¯å¦è¢«å…³æ³¨
            this.isFollowed();
            //æ˜¯å¦å­˜åœ¨ä¼šè¯
            this.isCreateSession();
          })
          .catch(console.log)
      },
      goBack() {
        history.back();
      },
      queryUserInfo(id) {
        axios.get("/app/user/info/" + this.user.id)
          .then(({data}) => {
            if (!data) {
              return
            }
            // ä¿å­˜ç”¨æˆ·è¯¦æƒ…
            this.info = data;
            // ä¿å­˜åˆ°æœ¬åœ°
            sessionStorage.setItem("userInfo", JSON.stringify(data))
          })
          .catch(err => {
            this.$message.error(err);
          })
      },
      isFollowed(){
        axios.get("/app/user/follow/isFollow/" + this.user.id)
          .then(({data}) => this.followed = data)
          .catch(this.$message.error)
      },
      queryCommonFollow() {
        axios.get("/app/user/follow/common/" + this.user.id)
          .then(({data}) => this.commonFollows = data)
          .catch(err => {
            this.$message.error(err);
          })
      },
      follow() {
        axios.put("/app/user/follow/" + this.user.id + "/" + !this.followed)
          .then(() => {
            this.$message.success(this.followed ? "å·²å–æ¶ˆå…³æ³¨" : "å·²å…³æ³¨")
            this.followed = !this.followed
          })
          .catch(this.$message.error)
      },
      // æ–°å¢ç§ä¿¡æ–¹æ³•
      sendPrivateMessage() {
        //ä¼šè¯å­˜åœ¨ï¼Œç›´æ¥è·³è½¬
        if(this.sessionId!="" && this.sessionId!=null){
          location.href = `/chat.html?sessionId=${this.sessionId}`;
           return;
        }
       let targetUid=this.user.id
        // 1. å…ˆè·å–æˆ–åˆ›å»ºä¼šè¯
        axios.post(`/app/chat/chatSession/createSession/${targetUid}`).then(response => {
          if (response.success) {
            const sessionId = response.data;
            // è·³è½¬åˆ°èŠå¤©é¡µé¢
            location.href = `/chat.html?sessionId=${sessionId}`;
          } else {
            this.$message.error('åˆ›å»ºä¼šè¯å¤±è´¥');
          }
        }).catch(error => {
          console.error('ç§ä¿¡å¤±è´¥:', error);
          this.$message.error('ç§ä¿¡åŠŸèƒ½æš‚ä¸å¯ç”¨');
        });
      },
      isCreateSession() {
        // è·å–ä¼šè¯ID
          axios.get(`/app/chat/chatSession/getSessionId`,{
            params: {
              fromUid: this.loginUser.id,
              toUid: this.user.id
            }
          }).then(response => {
            if (response.success) {
               this.sessionId = response.data;
               console.log("ä¼šè¯idä¸º"+this.sessionId)
            }
          })
      },
      handleClick(t) {
        if (t.name === '2') {
          this.queryCommonFollow();
        }
      },
      toOtherInfo(id){
        location.href = "/other-info.html?id=" + id
      }
    },

  })
</script>
</body>

</html>