<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <title>用户主页</title>
  <!-- 优先使用CDN确保Vue及组件库正确加载 -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
  <script src="https://unpkg.com/element-ui/lib/index.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <!-- 保留本地样式文件 -->
  <link href="./css/main.css" rel="stylesheet">

  <style type="text/css">
    /* 保持之前的CSS样式不变 */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      overflow: hidden;
    }

    body {
      background-color: #f5f5f5;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      color: #333;
    }

    #app {
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }

    /* 新增：加载遮罩层样式 */
    .loading-mask {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255, 255, 255, 0.95);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.3s ease;
    }

    .loading-mask.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #07c160;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }

    .loading-text {
      font-size: 16px;
      color: #666;
      text-align: center;
    }

    .loading-subtext {
      font-size: 14px;
      color: #999;
      margin-top: 8px;
    }

    .header {
      background-color: #fff;
      height: 50px;
      display: flex;
      align-items: center;
      padding: 0 15px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      position: relative;
      z-index: 10;
      flex-shrink: 0;
    }

    .header-back-btn {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background-color 0.2s;
    }

    .header-back-btn:hover {
      background-color: #f0f0f0;
    }

    .header-back-btn i {
      font-size: 20px;
      color: #333;
    }

    .basic {
      display: flex;
      align-items: center;
      padding: 15px;
      background-color: #fff;
      flex-shrink: 0;
    }

    .basic-icon {
      flex-shrink: 0;
      margin-right: 12px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      overflow: hidden;
      border: 2px solid #f0f0f0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .basic-icon img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .basic-info {
      flex: 1;
      min-width: 0;
    }

    .basic-info .name {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 5px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: #1a1a1a;
    }

    .basic-info span {
      font-size: 13px;
      color: #666;
      display: inline-flex;
      align-items: center;
    }

    .basic-info span::before {
      content: "";
      display: inline-block;
      width: 12px;
      height: 12px;
      background: url('/imgs/icons/location.png') no-repeat center;
      background-size: contain;
      margin-right: 4px;
      opacity: 0.7;
    }

    .action-buttons {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-shrink: 0;
      margin-left: auto;
    }

    .action-btn {
      padding: 5px 12px;
      border-radius: 18px;
      cursor: pointer;
      font-size: 13px;
      min-width: 70px;
      height: 30px;
      text-align: center;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .logout-btn {
      background-color: #ff6633;
      color: white;
      box-shadow: 0 2px 4px rgba(255, 102, 51, 0.2);
    }

    .message-btn {
      background-color: #07c160;
      color: white;
      box-shadow: 0 2px 4px rgba(7, 193, 96, 0.2);
    }

    .introduce {
      padding: 12px 15px;
      background-color: #fff;
      border-top: 1px solid #f5f5f5;
      font-size: 14px;
      color: #555;
      line-height: 1.5;
      flex-shrink: 0;
    }

    .stats-card {
      display: flex;
      justify-content: space-around;
      background-color: #fff;
      padding: 15px 0;
      border-top: 1px solid #f5f5f5;
      border-bottom: 1px solid #f5f5f5;
      flex-shrink: 0;
    }

    .stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
    }

    .stat-value {
      font-size: 18px;
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 13px;
      color: #666;
    }

    /* 自定义标签页样式 */
    .custom-tabs-header {
      background-color: #fff;
      border-bottom: 1px solid #eee;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      flex-shrink: 0;
    }

    .custom-tabs-nav {
      display: flex;
      min-width: 100%;
    }

    .custom-tab-item {
      flex: 1;
      text-align: center;
      padding: 12px 0;
      cursor: pointer;
      position: relative;
    }

    .custom-tab-item.active {
      color: #07c160;
    }

    .custom-tab-item.active::after {
      content: "";
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background-color: #07c160;
    }

    .tab-text {
      font-size: 16px;
      display: inline-flex;
      align-items: center;
    }

    .count-badge {
      margin-left: 5px;
      background-color: #ff6633;
      color: white;
      border-radius: 10px;
      padding: 0 6px;
      font-size: 12px;
      height: 18px;
      line-height: 18px;
    }

    /* 关键修复：内容区域滚动容器 */
    .content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 0; /* 关键：允许内容区域收缩 */
    }

    .custom-tabs-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 0; /* 关键：允许内容区域收缩 */
    }

    .tabs-container {
      flex: 1;
      overflow: hidden;
      position: relative;
      min-height: 0; /* 关键：允许内容区域收缩 */
    }

    .tabs-content {
      display: flex;
      height: 100%;
      transition: transform 0.3s ease;
    }

    /* 关键修复：每个标签页设置为滚动容器 */
    .tab-pane {
      width: 100%;
      flex-shrink: 0;
      height: 100%;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom: 60px; /* 为底部导航留出空间 */
    }

    /* 笔记列表样式 */
    .blog-item {
      display: flex;
      padding: 12px 15px;
      background-color: #fff;
      border-bottom: 1px solid #f5f5f5;
      transition: background-color 0.2s;
    }

    .blog-item:hover {
      background-color: #fafafa;
    }

    .blog-img {
      width: 90px;
      height: 90px;
      border-radius: 6px;
      overflow: hidden;
      flex-shrink: 0;
    }

    .blog-img img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .blog-info {
      flex: 1;
      padding-left: 12px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .blog-title {
      font-size: 15px;
      color: #333;
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      max-height: 42px;
    }

    .blog-meta {
      display: flex;
      gap: 12px;
      padding-top: 3px;
    }

    .blog-liked, .blog-comments, .blog-share {
      display: flex;
      align-items: center;
      font-size: 12px;
      color: #888;
      cursor: pointer;
    }

    .blog-liked img {
      width: 14px;
      height: 14px;
      margin-right: 4px;
    }

    .blog-liked.active {
      color: #ff6633;
    }

    .blog-comments i, .blog-share i {
      margin-right: 4px;
      font-size: 14px;
    }

    /* 用户列表样式（用于共同关注） */
    .user-list {
      background-color: #fff;
    }

    .user-item {
      display: flex;
      align-items: center;
      padding: 12px 15px;
      border-bottom: 1px solid #f5f5f5;
    }

    .user-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      overflow: hidden;
      flex-shrink: 0;
    }

    .user-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .user-info {
      flex: 1;
      padding-left: 12px;
      min-width: 0;
    }

    .user-name {
      font-size: 15px;
      font-weight: 500;
      margin-bottom: 3px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .user-desc {
      font-size: 12px;
      color: #888;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .follow-btn {
      padding: 5px 12px;
      border-radius: 15px;
      font-size: 13px;
      border: 1px solid #07c160;
      color: #07c160;
      background-color: transparent;
      cursor: pointer;
      transition: all 0.2s;
    }

    .follow-btn.following {
      background-color: #07c160;
      color: white;
    }

    /* 空状态样式 */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      color: #999;
      text-align: center;
      min-height: 200px;
    }

    .empty-icon {
      font-size: 50px;
      margin-bottom: 15px;
      color: #ddd;
    }

    .empty-text {
      font-size: 14px;
    }

    /* 加载状态样式 */
    .loading-indicator, .no-more-data, .load-error {
      padding: 15px;
      text-align: center;
      font-size: 13px;
      color: #888;
    }

    .loading-indicator i {
      margin-right: 5px;
      animation: spin 1s linear infinite;
    }

    .no-more-data i {
      color: #ddd;
      margin-right: 5px;
    }

    .load-error i {
      color: #ff6633;
      margin-right: 5px;
    }

    .retry-btn {
      color: #07c160;
      margin-left: 5px;
      cursor: pointer;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* 新增：店铺列表样式 */
    .shop-item {
      display: flex;
      padding: 12px 15px;
      background-color: #fff;
      border-bottom: 1px solid #f5f5f5;
      transition: background-color 0.2s;
    }

    .shop-item:hover {
      background-color: #fafafa;
    }

    .shop-img {
      width: 90px;
      height: 90px;
      border-radius: 6px;
      overflow: hidden;
      flex-shrink: 0;
    }

    .shop-img img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .shop-info {
      flex: 1;
      padding-left: 12px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .shop-title {
      font-size: 15px;
      font-weight: 600;
      color: #333;
      line-height: 1.4;
      margin-bottom: 5px;
    }

    .shop-rate {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }

    .shop-rate .el-rate {
      margin-right: 8px;
    }

    .shop-rate span {
      font-size: 12px;
      color: #999;
    }

    .shop-area {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: #666;
      margin-bottom: 5px;
    }

    .shop-avg {
      font-size: 12px;
      color: #ff6633;
      margin-bottom: 5px;
    }

    .shop-address {
      display: flex;
      align-items: center;
      font-size: 12px;
      color: #999;
    }

    .shop-address i {
      margin-right: 4px;
      font-size: 14px;
    }

    /* 收藏操作按钮 */
    .collection-actions {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .collection-btn {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
    }

    .view-btn {
      background-color: #07c160;
      color: white;
    }

    .uncollect-btn {
      background-color: #ff6633;
      color: white;
    }

    /* 响应式调整 */
    @media (max-width: 375px) {
      .basic-icon {
        width: 50px;
        height: 50px;
      }

      .action-btn {
        padding: 4px 8px;
        font-size: 12px;
        min-width: 60px;
        height: 26px;
      }

      .blog-img, .shop-img {
        width: 70px;
        height: 70px;
      }

      .tab-text {
        font-size: 14px;
      }

      .stat-value {
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
<div id="app">
  <!-- 新增：加载遮罩层 -->
  <div class="loading-mask" :class="{ hidden: !isLoading }">
    <div class="loading-spinner"></div>
    <div class="loading-text">正在加载用户数据</div>
    <div class="loading-subtext">请稍候...</div>
  </div>

  <div class="header">
    <div class="header-back-btn" @click="goBack"><i class="el-icon-arrow-left"></i></div>
    <div class="header-title">&nbsp;&nbsp;&nbsp;</div>
  </div>

  <div class="basic">
    <div class="basic-icon">
      <img :src="user.icon || '/imgs/icons/default-icon.png'" alt="用户头像" @error="handleImgError($event)">
    </div>
    <div class="basic-info">
      <div class="name">{{ user.nickName || '未知用户' }}</div>
      <span>{{user.city||'未知城市'}}</span>
    </div>
    <div class="action-buttons">
      <div class="logout-btn action-btn" @click="follow" v-if="user.id">
        {{ user.isFollow ? "取消关注" : "关注" }}
      </div>
      <div class="message-btn action-btn" @click="sendPrivateMessage" v-if="user.id">
        私信
      </div>
    </div>
  </div>

  <div class="introduce">
    <span v-if="info.introduce">{{ info.introduce }}</span>
    <span v-else>这个人很懒，什么都没有留下</span>
  </div>

  <!-- 用户数据统计卡片 -->
  <div class="stats-card">
    <div class="stat-item">
      <div class="stat-value">{{ stats.fansCount||0 }}</div>
      <div class="stat-label">粉丝</div>
    </div>
    <div class="stat-item">
      <div class="stat-value">{{ stats.followCount||0 }}</div>
      <div class="stat-label">关注</div>
    </div>
    <div class="stat-item">
      <div class="stat-value">{{ stats.likeCount||0 }}</div>
      <div class="stat-label">获赞</div>
    </div>
  </div>

  <!-- 自定义标签页内容 -->
  <div class="content">
    <div class="custom-tabs-header">
      <div class="custom-tabs-nav">
        <div class="custom-tab-item"
             :class="{ active: activeName === 'note' }"
             @click="switchTabWithFeedback('note')">
          <div class="tab-text">
            笔记
            <span v-if="stats.blogCount > 0" class="count-badge">{{ formatCount(stats.blogCount) }}</span>
          </div>
        </div>
        <div class="custom-tab-item"
             :class="{ active: activeName === 'common' }"
             @click="switchTabWithFeedback('common')">
          <div class="tab-text">
            共同关注
            <span v-if="stats.commonFollowCount > 0" class="count-badge">{{ formatCount(stats.commonFollowCount) }}</span>
          </div>
        </div>
        <div class="custom-tab-item"
             :class="{ active: activeName === 'collection' }"
             @click="switchTabWithFeedback('collection')">
          <div class="tab-text">
            店铺收藏
            <span v-if="stats.collectCount > 0" class="count-badge">{{ formatCount(stats.collectCount) }}</span>
          </div>
        </div>
      </div>
    </div>

    <div class="custom-tabs-content">
      <div class="tabs-container">
        <div class="tabs-content" :style="{ transform: `translateX(-${currentIndex * 100}%)` }">

          <!-- 笔记标签页 -->
          <div class="tab-pane" @scroll="onScroll($event, 'note')" ref="notePane">
            <div v-if="notes.length > 0">
              <div v-for="b in notes" :key="b.id" class="blog-item">
                <div class="blog-img" @click="toNoteDetail(b)">
                  <img :src="getFirstImage(b.images)" alt="" @error="handleImgError($event)">
                </div>
                <div class="blog-info">
                  <div class="blog-title" @click="toNoteDetail(b)">{{ truncateTitle(b.title, 20) }}</div>
                  <div class="blog-meta">
                    <div class="blog-liked"
                         :class="{'active': b.isLike}"
                         @click.stop="toggleLike(b)">
                      <img src="/imgs/thumbup.png" alt="">
                      {{ b.liked || 0 }}
                    </div>
                    <div class="blog-comments" @click.stop="toNoteDetail(b)">
                      <i class="el-icon-chat-dot-round"></i>
                      {{ b.comments || 0 }}
                    </div>
                    <div class="blog-share" @click.stop="shareNote(b)">
                      <i class="el-icon-share"></i>
                      分享
                    </div>
                  </div>
                </div>
              </div>

              <!-- 加载状态指示器 -->
              <div class="loading-indicator" v-if="noteLoading">
                <i class="el-icon-loading"></i> 正在加载更多笔记...
              </div>

              <div class="no-more-data" v-if="noteNoMore && !noteLoading">
                <i class="el-icon-finished"></i> 没有更多笔记了
              </div>

              <div class="load-error" v-if="noteLoadError && !noteLoading">
                <i class="el-icon-warning"></i> 加载失败
                <span class="retry-btn" @click="retryLoadNotes">点击重试</span>
              </div>
            </div>
            <div v-else class="empty-state">
              <div class="empty-icon"><i class="el-icon-document"></i></div>
              <div class="empty-text">还没有发布任何笔记</div>
            </div>
          </div>

          <!-- 共同关注标签页 -->
          <div class="tab-pane" @scroll="onScroll($event, 'common')" ref="commonPane">
            <div class="user-list">
              <div v-if="commonFollows.length > 0">
                <div v-for="user in commonFollows" :key="user.id" class="user-item">
                  <div class="user-avatar" @click="toUserDetail(user)">
                    <img :src="user.icon || '/imgs/icons/default-icon.png'" alt="" @error="handleImgError($event)">
                  </div>
                  <div class="user-info" @click="toUserDetail(user)">
                    <div class="user-name">{{ user.nickName || '匿名用户' }}</div>
                    <div class="user-desc">{{ user.introduce || '这个人很懒，什么都没写' }}</div>
                  </div>
                  <button class="follow-btn" :class="{'following': user.isFollow}"
                          @click.stop="toggleFollow(user)">
                    {{ user.isFollow ? '已关注' : '关注' }}
                  </button>
                </div>

                <!-- 加载状态指示器 -->
                <div class="loading-indicator" v-if="commonLoading">
                  <i class="el-icon-loading"></i> 正在加载更多共同关注...
                </div>

                <div class="no-more-data" v-if="commonNoMore && !commonLoading">
                  <i class="el-icon-finished"></i> 没有更多共同关注了
                </div>

                <div class="load-error" v-if="commonLoadError && !commonLoading">
                  <i class="el-icon-warning"></i> 加载失败
                  <span class="retry-btn" @click="retryLoadCommon">点击重试</span>
                </div>
              </div>
              <div v-else class="empty-state">
                <div class="empty-icon"><i class="el-icon-user"></i></div>
                <div class="empty-text">没有共同关注的用户</div>
              </div>
            </div>
          </div>

          <!-- 收藏标签页 - 只显示店铺收藏 -->
          <div class="tab-pane" @scroll="onScroll($event, 'collection')" ref="collectionPane">
            <div v-if="collections.length > 0">
              <div v-for="shop in collections" :key="shop.id" class="shop-item">
                <div class="shop-img" @click="toShopDetail(shop)">
                  <img :src="getFirstImage(shop.images)" alt="" @error="handleImgError($event)">
                </div>
                <div class="shop-info">
                  <div class="shop-title" @click="toShopDetail(shop)">{{ shop.name }}</div>
                  <div class="shop-rate">
                    <el-rate
                            disabled
                            v-model="shop.score/10"
                            text-color="#F63"
                            show-score
                    ></el-rate>
                    <span>{{ shop.comments }}条</span>
                  </div>
                  <div class="shop-area">
                    <span>{{ shop.area }}</span>
                    <span v-if="shop.distance">
                      {{ shop.distance < 1000 ? shop.distance.toFixed(1) + 'm' : (shop.distance/1000).toFixed(1) + 'km' }}
                    </span>
                  </div>
                  <div class="shop-avg">￥{{ shop.avgPrice }}/人</div>
                  <div class="shop-address">
                    <i class="el-icon-map-location"></i>
                    <span>{{ shop.address }}</span>
                  </div>
                  <div class="collection-actions">
                    <button class="collection-btn view-btn" @click.stop="toShopDetail(shop)">
                      查看详情
                    </button>
                    <button class="collection-btn uncollect-btn" @click.stop="toggleFollowShop(shop)">
                      <template v-if="shop.isFollow">取消收藏</template>
                      <template v-else>收藏</template>
                    </button>
                  </div>
                </div>
              </div>

              <!-- 加载状态指示器 -->
              <div class="loading-indicator" v-if="collectionLoading">
                <i class="el-icon-loading"></i> 正在加载更多店铺收藏...
              </div>

              <div class="no-more-data" v-if="collectionNoMore && !collectionLoading">
                <i class="el-icon-finished"></i> 没有更多店铺收藏了
              </div>

              <div class="load-error" v-if="collectionLoadError && !collectionLoading">
                <i class="el-icon-warning"></i> 加载失败
                <span class="retry-btn" @click="retryLoadCollections">点击重试</span>
              </div>
            </div>
            <div v-else class="empty-state">
              <div class="empty-icon"><i class="el-icon-star-off"></i></div>
              <div class="empty-text">还没有收藏任何店铺</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <foot-bar :active-btn="0"></foot-bar>
</div>

<!-- 保留本地工具脚本 -->
<script src="./js/common.js"></script>
<script src="./js/footer.js"></script>

<script>
  const app = new Vue({
    el: "#app",
    data: {
      util,
      user: {},
      loginUser: {},
      activeName: "note", // 默认选中笔记标签
      currentIndex: 0, // 用于标签页切换的索引
      sessionId: "",
      info: {},
      // 新增：加载状态控制
      isLoading: true,
      // 数据加载完成计数器
      dataLoadedCount: 0,
      // 需要加载的数据总数
      totalDataToLoad: 6, // 用户信息、用户详情、统计数据、笔记、共同关注、收藏

      //统计标签
      stats: {
        blogCount: 0,
        fansCount: 0,
        followCount: 0,
        likeCount: 0,
        collectCount:0,
        commonFollowCount: 0
      },
      // 登录状态
      token: sessionStorage.getItem("token") || '',
      // 各标签页数据
      notes: [],
      commonFollows: [],
      collections: [],

      // 分页参数
      noteCurrent: 1,
      commonCurrent: 1,
      collectionCurrent: 1,

      // 加载状态
      noteLoading: false,
      noteNoMore: false,
      noteLoadError: false,

      commonLoading: false,
      commonNoMore: false,
      commonLoadError: false,

      collectionLoading: false,
      collectionNoMore: false,
      collectionLoadError: false,

      // 滚动节流标记
      scrollThrottle: null,

      followed: false,

      // 调试标记
      debugMode: true
    },
    created() {
      // 初始化测试数据
      this.initTestData();

      // 延迟加载实际数据
      setTimeout(() => {
        this.queryUser();
        this.queryLoginUser();
      }, 1000);
    },
    mounted() {
      // 确保滚动容器正确初始化
      this.$nextTick(() => {
        console.log('页面加载完成，检查滚动容器');
      });
    },
    methods: {
      // 新增：数据加载完成回调
      onDataLoaded() {
        this.dataLoadedCount++;
        console.log(`数据加载进度: ${this.dataLoadedCount}/${this.totalDataToLoad}`);

        // 当所有数据加载完成时隐藏遮罩层
        if (this.dataLoadedCount >= this.totalDataToLoad) {
          setTimeout(() => {
            this.isLoading = false;
            console.log('所有数据加载完成，隐藏遮罩层');
          }, 500); // 延迟500ms隐藏，让用户看到加载完成
        }
      },

      // 初始化测试数据
      initTestData() {
        // 笔记数据
        this.notes = Array(5).fill().map((_, i) => ({
          id: i + 1,
          title: `测试笔记 ${i + 1}：这是一篇用于测试的笔记内容`,
          images: '/imgs/icons/default-blog.png',
          liked: i * 10,
          comments: i * 3,
          isLike: false
        }));

        // 共同关注数据
        this.commonFollows = Array(3).fill().map((_, i) => ({
          id: i + 100,
          nickName: `共同关注用户 ${i + 1}`,
          icon: '/imgs/icons/default-icon.png',
          isFollow: true
        }));

        // 店铺收藏数据
        this.collections = Array(3).fill().map((_, i) => ({
          id: i + 400,
          shop: {
            id: i + 500,
            name: `收藏店铺 ${i + 1}`,
            images: '/imgs/icons/default-shop.png',
            score: 4.5 + (i * 0.1),
            comments: 50 + (i * 10),
            area: '拱墅区',
            distance: 500 + (i * 200),
            avgPrice: 80 + (i * 20),
            address: `杭州市拱墅区莫干山路${1000 + i}号`
          }
        }));

        // 测试数据加载完成
        this.onDataLoaded();
      },

      // 处理图片加载失败
      handleImgError(event) {
        event.target.src = '/imgs/icons/default-icon.png';
      },

      // 切换标签页
      switchTabWithFeedback(tabName) {
        // 映射标签名到索引
        const tabIndexMap = {
          'note': 0,
          'common': 1,
          'collection': 2
        };

        this.activeName = tabName;
        this.currentIndex = tabIndexMap[tabName] || 0;

        // 按需加载数据
        if (tabName === 'note' && this.notes.length === 0) {
          this.queryNotes();
        } else if (tabName === 'common' && this.commonFollows.length === 0) {
          this.queryCommonFollows();
        } else if (tabName === 'collection' && this.collections.length === 0) {
          this.queryCollections();
        }
      },

      // 格式化数量（超过99显示99+）
      formatCount(count) {
        return count > 99 ? '99+' : count;
      },

      // 获取第一张图片
      getFirstImage(images) {
        if (!images) return '/imgs/icons/default-blog.png';
        const imgArr = images.split(',');
        return fileURL+imgArr[0] || '/imgs/icons/default-blog.png';
      },

      // 截断标题
      truncateTitle(title, length) {
        if (!title) return '无标题';
        return title.length > length ? title.substring(0, length) + '...' : title;
      },

      // 滚动加载更多 - 修复重复调用问题
      onScroll(event, type) {
        // 节流处理，避免频繁触发
        if (this.scrollThrottle) {
          clearTimeout(this.scrollThrottle);
        }

        this.scrollThrottle = setTimeout(() => {
          const container = event.target;
          const { scrollTop, scrollHeight, clientHeight } = container;

          // 计算距离底部的距离
          const bottomDistance = scrollHeight - scrollTop - clientHeight;

          if (this.debugMode) {
            console.log(`${type}滚动距离：`, bottomDistance);
          }

          // 关键修复：简化判断条件
          if (bottomDistance <= 100 &&
                  !this[`${type}Loading`] &&
                  !this[`${type}LoadError`] &&
                  !this[`${type}NoMore`]) {

            console.log(`✅ 触发${type}加载更多`);

            // 直接调用对应的方法
            if (type === 'note') {
              this.loadMoreNotes();
            } else if (type === 'common') {
              this.loadMoreCommonFollows();
            } else if (type === 'collection') {
              this.loadMoreCollections();
            }
          }
        }, 300);
      },

      // 查询店铺收藏
      queryCollections() {
        if (!this.user.id) return;
        this.collectionLoading = true;
        this.collectionLoadError = false;
        this.collectionCurrent = 1;

        axios.get("/app/follow/followShop/followShops", {
          params: {
            userId: this.user.id,
            current: this.collectionCurrent
          }
        })
                .then((response) => {
                  const data = response.data || [];
                  data.forEach(s => s.images = s.images.split(',')[0]);
                  this.collections = data;
                  this.collectionNoMore = false;
                  this.collectionLoading = false;
                  this.onDataLoaded(); // 新增：数据加载完成回调
                })
                .catch(err => {
                  console.error("获取店铺收藏失败:", err);
                  this.collectionLoading = false;
                  this.collectionLoadError = true;
                  this.onDataLoaded(); // 新增：即使失败也回调
                });
      },

      // 加载更多店铺收藏
      loadMoreCollections() {
        if (this.collectionLoading || this.collectionLoadError || this.collectionNoMore) return;

        this.collectionLoading = true;
        this.collectionLoadError = false;
        const nextPage = this.collectionCurrent + 1;

        axios.get("/app/follow/followShop/followShops", {
          params: {
            userId: this.user.id,
            current: nextPage
          }
        })
                .then((response) => {
                  const newCollections = response.data || [];
                  if (newCollections.length > 0) {
                    this.collections = [...this.collections, ...newCollections];
                    this.collectionCurrent = nextPage;
                    if (newCollections.length < 5) {
                      this.collectionNoMore = true;
                    }
                  } else {
                    this.collectionNoMore = true;
                  }
                  this.collectionLoading = false;
                })
                .catch(err => {
                  console.error("加载更多店铺收藏失败:", err);
                  this.collectionLoading = false;
                  this.collectionLoadError = true;
                });
      },

      // 取消收藏店铺
      toggleFollowShop(shop) {
        if (!this.token) {
          this.$message.error("请先登录");
          setTimeout(() => {
            location.href = "/login.html";
          }, 200);
          return;
        }
        const shopId = shop.id;
        const followStatus = !shop.isFollow;

        this.isFollowLoading = true;


        axios.put('/app/follow/followShop/'+ shopId + "/" + followStatus)
                .then(({data}) => {
                  // 文案改为"收藏"相关，适配按钮功能
                  const successMsg = followStatus ? '收藏店铺成功，已添加到你的收藏夹～' : '已取消店铺收藏';
                  this.$message.success(successMsg);
                  shop.isFollow= followStatus;
                })
                .catch(error => {
                  const errorMsg = followStatus ? '收藏失败，请重试' : '取消收藏失败，请重试';
                  this.$message.error(errorMsg);
                  console.error(error);
                })
                .finally(() => {
                  this.isFollowLoading = false;
                });
      },

      // 跳转到店铺详情
      toShopDetail(shop) {
        if (shop.id) {
          location.href = `/shop-detail.html?id=${shop.id}`;
        }
      },

      retryLoadCollections() {
        this.collectionLoadError = false;
        this.collectionNoMore = false;
        this.collectionCurrent = 1;
        this.queryCollections();
      },

      // 笔记数据加载 - 修复分页逻辑
      loadMoreNotes() {
        if (this.noteLoading || this.noteLoadError || this.noteNoMore) {
          console.log('笔记加载被阻止:', {
            loading: this.noteLoading,
            loadError: this.noteLoadError,
            noMore: this.noteNoMore
          });
          return;
        }

        this.noteLoading = true;
        this.noteLoadError = false;
        const nextPage = this.noteCurrent + 1;

        console.log('加载更多笔记，页码:', nextPage);

        axios.get("/app/blog/of/user", {
          params: {
            userId: this.user.id,
            current: nextPage
          }
        })
                .then((response) => {
                  const newNotes = response.data || [];
                  console.log('新加载笔记数量:', newNotes.length);

                  if (newNotes.length > 0) {
                    this.notes = [...this.notes, ...newNotes];
                    this.noteCurrent = nextPage;

                    // 关键修复：后端固定返回5条，所以当返回数据少于5条时标记为没有更多
                    if (newNotes.length < 5) {
                      this.noteNoMore = true;
                      console.log('返回数据少于5条，标记为没有更多数据');
                    }
                  } else {
                    // 返回空数组，确实没有更多数据了
                    this.noteNoMore = true;
                    console.log('返回空数组，标记为没有更多数据');
                  }

                  this.noteLoading = false;
                  console.log('加载更多完成，总数量:', this.notes.length, '是否有更多:', !this.noteNoMore);
                })
                .catch(err => {
                  console.error("加载更多笔记失败:", err);
                  this.noteLoading = false;
                  this.noteLoadError = true;
                  this.noteCurrent = Math.max(1, this.noteCurrent - 1);
                });
      },

      // 查询笔记 - 修复初始加载
      queryNotes() {
        if (!this.user.id) return;

        this.noteLoading = true;
        this.noteLoadError = false;
        this.noteNoMore = false;  // 关键：初始设为false
        this.noteCurrent = 1;

        console.log('初始查询笔记，页码:', this.noteCurrent);

        axios.get("/app/blog/of/user", {
          params: {
            userId: this.user.id,
            current: this.noteCurrent
          }
        })
                .then((response) => {
                  const data = response.data || [];
                  this.notes = data;

                  // 关键修复：第一页不判断是否还有更多数据
                  // 只有在加载更多时才判断
                  if (data.length === 0) {
                    this.noteNoMore = true;
                    console.log('第一页没有数据，标记为没有更多');
                  } else {
                    this.noteNoMore = false;
                    console.log('第一页有数据，不标记为没有更多，等待用户滚动');
                  }

                  this.noteLoading = false;
                  this.onDataLoaded(); // 新增：数据加载完成回调
                  console.log('笔记加载完成，数量:', data.length, '是否有更多:', !this.noteNoMore);
                })
                .catch(err => {
                  console.error("获取笔记失败:", err);
                  this.noteLoading = false;
                  this.noteLoadError = true;
                  this.onDataLoaded(); // 新增：即使失败也回调
                });
      },

      retryLoadNotes() {
        this.noteLoadError = false;
        this.noteNoMore = false;
        this.noteCurrent = 1;
        this.queryNotes();
      },

      // 共同关注数据加载
      queryCommonFollows() {
        if (!this.user.id || !this.loginUser.id) return;
        this.commonLoading = true;
        this.commonLoadError = false;
        this.commonCurrent = 1;

        axios.get("/app/follow/followUser/common", {
          params: {
            userId: this.user.id,
            current: this.commonCurrent
          }
        })
                .then((response) => {
                  const data = response.data || [];
                  data.forEach(item=>{
                    item.icon = fileURL + item.icon;
                  })
                  this.commonFollows = data;
                  // 第一页不判断是否有更多
                  this.commonNoMore = false;
                  this.commonLoading = false;
                  this.onDataLoaded(); // 新增：数据加载完成回调
                })
                .catch(err => {
                  console.error("获取共同关注失败:", err);
                  this.commonLoading = false;
                  this.commonLoadError = true;
                  this.onDataLoaded(); // 新增：即使失败也回调
                });
      },

      loadMoreCommonFollows() {
        if (this.commonLoading || this.commonLoadError || this.commonNoMore) return;

        this.commonLoading = true;
        this.commonLoadError = false;
        const nextPage = this.commonCurrent + 1;

        axios.get("/app/follow/followUser/common", {
          params: {
            userId: this.user.id,
            current: nextPage
          }
        })
                .then((response) => {
                  data.forEach(item=>{
                    item.icon = fileURL + item.icon;
                  })
                  const newFollows = response.data || [];
                  if (newFollows.length > 0) {
                    this.commonFollows = [...this.commonFollows, ...newFollows];
                    this.commonCurrent = nextPage;
                    // 后端固定返回5条，所以当返回数据少于5条时标记为没有更多
                    if (newFollows.length < 5) {
                      this.commonNoMore = true;
                    }
                  } else {
                    this.commonNoMore = true;
                  }
                  this.commonLoading = false;
                })
                .catch(err => {
                  console.error("加载更多共同关注失败:", err);
                  this.commonLoading = false;
                  this.commonLoadError = true;
                });
      },

      retryLoadCommon() {
        this.commonLoadError = false;
        this.commonNoMore = false;
        this.commonCurrent = 1;
        this.queryCommonFollows();
      },

      // 获取登录用户信息
      queryLoginUser() {
        axios.get("/app/user/me")
                .then((response) => {
                  this.loginUser = response.data || {};
                  this.onDataLoaded(); // 新增：数据加载完成回调
                  // 如果已获取用户信息，加载共同关注
                  if (this.user.id) {
                    this.queryCommonFollows();
                  }
                })
                .catch(err => {
                  console.error("获取登录用户失败:", err);
                  this.loginUser = {};
                  this.onDataLoaded(); // 新增：即使失败也回调
                });
      },

      // 获取用户信息
      queryUser() {
        let id = util.getUrlParam("id");
        if (!id) {
          console.error("未获取到用户ID");
          this.onDataLoaded(); // 新增：即使失败也回调
          return;
        }

        axios.get("/app/user/" + id)
                .then((response) => {
                  this.user = response.data || {};
                  this.user.icon = fileURL + response.data.icon;
                  this.onDataLoaded(); // 新增：数据加载完成回调
                  this.queryUserInfo();
                  this.queryNotes();
                  this.queryCollections(); // 加载店铺收藏
                  this.isCreateSession();
                  this.queryUserStats();
                  this.queryCommonFollows();
                })
                .catch(err => {
                  console.error("获取用户信息失败:", err);
                  this.user = {};
                  this.onDataLoaded(); // 新增：即使失败也回调
                });
      },

      // 获取用户统计数据
      queryUserStats() {
        if (!this.user.id) return;

        axios.get(`/app/user/stats/${this.user.id}`)
                .then((response) => {
                  const data = response.data || {};
                  this.stats = data;
                  this.onDataLoaded(); // 新增：数据加载完成回调
                })
                .catch(err => {
                  console.log("获取统计数据失败:", err);
                  this.onDataLoaded(); // 新增：即使失败也回调
                });
      },

      // 返回上一页
      goBack() {
        history.back();
      },

      // 获取用户详情
      queryUserInfo() {
        if (!this.user.id) return;

        axios.get("/app/user/info/getUserInfo/" + this.user.id)
                .then((response) => {
                  this.info = response.data || {};
                  this.onDataLoaded(); // 新增：数据加载完成回调
                })
                .catch(err => {
                  console.error("获取用户详情失败:", err);
                  this.info = {};
                  this.onDataLoaded(); // 新增：即使失败也回调
                });
      },
      // 关注/取消关注用户
      follow() {
        if (!this.user.id) return;

        axios.put("/app/follow/followUser/" + this.user.id + "/" + !this.followed)
                .then(() => {
                  this.$message.success(this.followed ? "已取消关注" : "已关注");
                  this.followed = !this.followed;
                  this.queryUserStats();
                  this.queryUser()
                })
                .catch(err => {
                  console.error("关注操作失败:", err);
                  this.$message.error("操作失败，请稍后重试");
                });
      },

      // 发送私信
      sendPrivateMessage() {
        if (!this.user.id) return;

        if (this.sessionId) {
          location.href = `/chat.html?sessionId=${this.sessionId}`;
          return;
        }

        let targetUid = this.user.id;
        axios.post(`/app/chat/chatSession/createSession/${targetUid}`)
                .then(response => {
                  if (response && response.success) {
                    const sessionId = response.data;
                    location.href = `/chat.html?sessionId=${sessionId}`;
                  } else {
                    this.$message.error('创建会话失败');
                  }
                })
                .catch(error => {
                  console.error('私信失败:', error);
                  this.$message.error('私信功能暂不可用');
                });
      },

      // 检查是否已有会话
      isCreateSession() {
        if (!this.loginUser.id || !this.user.id) return;

        axios.get(`/app/chat/chatSession/getSessionId`, {
          params: {
            fromUid: this.loginUser.id,
            toUid: this.user.id
          }
        })
                .then(response => {
                  if (response && response.success) {
                    this.sessionId = response.data;
                  }
                })
                .catch(err => {
                  console.error("获取会话ID失败:", err);
                });
      },

      // 切换关注状态
      toggleFollow(user) {
        if (!user.id) return;

        const isFollow = !user.isFollow;
        axios.put(`/app/user/follow/${user.id}/${isFollow}`)
                .then(() => {
                  user.isFollow = isFollow;
                  this.$message.success(isFollow ? "关注成功" : "取消关注成功");
                })
                .catch(err => {
                  console.error("关注操作失败:", err);
                  this.$message.error("操作失败，请稍后重试");
                });
      },

      // 切换点赞状态
      toggleLike(item) {
        const isLike = !item.isLike;
        axios.put(`/app/note/like/${item.id}/${isLike}`)
                .then(() => {
                  item.isLike = isLike;
                  item.liked = isLike ? (item.liked || 0) + 1 : (item.liked || 0) - 1;
                })
                .catch(err => {
                  console.error("点赞操作失败:", err);
                  this.$message.error("操作失败，请稍后重试");
                });
      },

      // 分享笔记
      shareNote(note) {
        this.$message.success("分享功能开发中...");
      },

      // 跳转到用户详情
      toUserDetail(user) {
        if (user.id) {
          location.href = `/other-info.html?id=${user.id}`;
        }
      },

      // 跳转到笔记详情
      toNoteDetail(note) {
        if (note.id) {
          location.href = `/blog-detail.html?id=${note.id}`;
        }
      }
    }
  });
</script>
</body>
</html>