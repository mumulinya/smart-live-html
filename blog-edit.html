<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <title>智评生活 - 发布笔记</title>
  <!-- 引入样式 -->
  <link rel="stylesheet" href="./css/element.css">
  <link href="./css/main.css" rel="stylesheet">
  <link href="./css/blog-edit.css" rel="stylesheet">

  <style type="text/css">
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: #f5f5f7;
      color: #333;
      overflow-x: hidden;
    }

    #app {
      min-height: 100vh;
      background-color: #f5f5f7;
    }

    /* 头部样式优化 */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px 20px;
      background-color: #fff;
      border-bottom: 1px solid #eee;
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .header-cancel-btn {
      color: #666;
      font-size: 16px;
      cursor: pointer;
      padding: 5px 10px;
      border-radius: 4px;
      transition: background-color 0.2s;
    }

    .header-cancel-btn:hover {
      background-color: #f5f5f5;
    }

    .header-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      display: flex;
      align-items: center;
    }

    .header-title .el-icon-info {
      margin-left: 8px;
      color: #999;
      font-size: 16px;
      cursor: help;
    }

    .header-commit-btn {
      background-color: #f63;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      opacity: 0.8;
    }

    .header-commit-btn:enabled {
      opacity: 1;
    }

    .header-commit-btn:enabled:hover {
      background-color: #ff7a45;
      transform: translateY(-1px);
      box-shadow: 0 2px 5px rgba(246, 102, 51, 0.2);
    }

    .header-commit-btn:enabled:active {
      transform: translateY(0);
    }

    /* 上传区域优化 */
    .upload-box {
      padding: 20px;
      background-color: #fff;
      margin-bottom: 10px;
    }

    .upload-btn {
      width: 80px;
      height: 80px;
      border: 2px dashed #e0e0e0;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #999;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 15px;
    }

    .upload-btn:hover {
      border-color: #f63;
      color: #f63;
      background-color: rgba(246, 102, 51, 0.03);
    }

    .upload-btn .el-icon-camera {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .pic-list {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .pic-box {
      width: 80px;
      height: 80px;
      border-radius: 10px;
      overflow: hidden;
      position: relative;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      transition: transform 0.2s;
    }

    .pic-box:hover {
      transform: scale(1.03);
    }

    .pic-box img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .pic-box .el-icon-close {
      position: absolute;
      top: -6px;
      right: -6px;
      background-color: rgba(0, 0, 0, 0.6);
      color: white;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .pic-box .el-icon-close:hover {
      background-color: #f63;
    }

    /* 标题和内容区域优化 */
    .blog-title, .blog-content {
      padding: 15px 20px;
      background-color: #fff;
      margin-bottom: 10px;
    }

    .blog-title input {
      width: 100%;
      border: none;
      outline: none;
      font-size: 18px;
      padding: 8px 0;
      color: #333;
      font-weight: 500;
    }

    .blog-title input::placeholder {
      color: #ccc;
      font-weight: normal;
    }

    .blog-content textarea {
      width: 100%;
      border: none;
      outline: none;
      min-height: 150px;
      resize: none;
      font-size: 16px;
      color: #333;
      line-height: 1.6;
      padding: 8px 0;
    }

    .blog-content textarea::placeholder {
      color: #ccc;
    }

    /* 商户关联区域优化 */
    .divider {
      height: 10px;
      background-color: #f5f5f7;
    }

    .blog-shop {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      background-color: #fff;
      border-bottom: 1px solid #eee;
      color: #333;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .blog-shop:hover {
      background-color: #f9f9f9;
    }

    .shop-left {
      color: #666;
    }

    .blog-shop div:last-child {
      color: #333;
      display: flex;
      align-items: center;
    }

    .blog-shop .el-icon-arrow-right {
      color: #ccc;
      margin-left: 5px;
      font-size: 18px;
    }

    /* 弹窗样式优化 */
    .mask {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 100;
    }

    .shop-dialog {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: #fff;
      border-top-left-radius: 16px;
      border-top-right-radius: 16px;
      z-index: 101;
      max-height: 80vh;
      overflow-y: auto;
      transform: translateY(0);
      transition: transform 0.3s ease;
    }

    .el-zoom-in-bottom-enter-active,
    .el-zoom-in-bottom-leave-active {
      transition: all 0.3s ease;
    }

    .el-zoom-in-bottom-enter,
    .el-zoom-in-bottom-leave-to {
      transform: translateY(100%);
    }

    /* 搜索区域优化 */
    .search-bar {
      display: flex;
      padding: 15px 20px;
      border-bottom: 1px solid #eee;
    }

    .city-select {
      padding: 8px 12px;
      background-color: #f5f5f7;
      border-radius: 20px;
      font-size: 14px;
      color: #333;
      display: flex;
      align-items: center;
      margin-right: 10px;
      cursor: pointer;
    }

    .city-select .el-icon-arrow-down {
      margin-left: 5px;
      font-size: 12px;
      color: #999;
    }

    .search-input {
      flex: 1;
      position: relative;
    }

    .search-input input {
      width: 100%;
      padding: 8px 15px 8px 35px;
      background-color: #f5f5f7;
      border: none;
      border-radius: 20px;
      font-size: 14px;
      outline: none;
    }

    .search-input .el-icon-search {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #999;
      font-size: 16px;
      cursor: pointer;
    }

    /* 商户列表优化 */
    .shop-list {
      max-height: calc(80vh - 120px);
      overflow-y: auto;
    }

    .shop-item {
      padding: 15px 20px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .shop-item:hover {
      background-color: #f9f9f9;
    }

    .shop-name {
      font-size: 16px;
      color: #333;
      margin-bottom: 5px;
      font-weight: 500;
    }

    .shop-item div:last-child {
      font-size: 14px;
      color: #999;
    }

    /* 滚动条美化 */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background-color: rgba(0, 0, 0, 0.1);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background-color: rgba(0, 0, 0, 0.2);
    }

    /* 加载中动画 */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
<div id="app">
  <div class="header">
    <div class="header-cancel-btn" @click="goBack">取消</div>
    <div class="header-title">&nbsp;&nbsp;发笔记<i class="el-icon-info" @click="showTips"></i></div>
    <div class="header-commit">
      <div class="header-commit-btn" @click="submitBlog" :disabled="!canSubmit">
        <span v-if="!isSubmitting">发布</span>
        <span v-if="isSubmitting" class="loading"></span>
      </div>
    </div>
  </div>

  <div class="upload-box">
    <input type="file" @change="fileSelected" name="file" ref="fileInput" style="display: none" accept="image/*">
    <div class="upload-btn" @click="openFileDialog" :class="{ 'disabled': fileList.length >= 9 }">
      <i class="el-icon-camera"></i>
      <div style="font-size: 12px;line-height: 12px">上传照片</div>
    </div>
    <div class="pic-list">
      <div class="pic-box" v-for="(f,i) in fileList" :key="i">
        <img :src="f" alt="" :class="{ 'loading': uploading[i] }">
        <i class="el-icon-close" @click="deletePic(i)"></i>
      </div>
    </div>
    <div v-if="fileList.length > 0" style="font-size: 12px; color: #999; margin-top: 8px;">
      已选择 {{fileList.length}} 张，最多可上传9张
    </div>
  </div>

  <div class="blog-title">
    <input v-model="params.title" type="text" placeholder="填写标题更容易上首页哦~" @input="checkSubmitStatus">
  </div>

  <div class="blog-content">
    <textarea v-model="params.content" placeholder="最近打卡了什么地方，有什么新奇体验呢？" @input="checkSubmitStatus"></textarea>
  </div>

  <div class="divider"></div>

  <div class="blog-shop" @click="showDialog=true">
    <div class="shop-left">关联商户</div>
    <div v-if="selectedShop.name">{{selectedShop.name}}</div>
    <div v-else>去选择&nbsp;<i class="el-icon-arrow-right"></i></div>
  </div>

  <div class="mask" v-show="showDialog" @click="showDialog=false"></div>

  <transition name="el-zoom-in-bottom">
    <div class="shop-dialog" v-show="showDialog">
      <div class="blog-shop">
        <div class="shop-left">关联商户</div>
      </div>
      <div class="search-bar">
        <div class="city-select">杭州 <i class="el-icon-arrow-down"></i></div>
        <div class="search-input">
          <i class="el-icon-search" @click="queryShops"></i>
          <input v-model="shopName" type="text" placeholder="搜索商户名称" @keyup.enter="queryShops">
        </div>
      </div>
      <div class="shop-list">
        <div v-if="shops.length === 0 && !shopLoading" class="empty-shop">
          <div style="text-align: center; padding: 30px 20px; color: #999;">
            <i class="el-icon-shopping-bag" style="font-size: 40px; margin-bottom: 10px; opacity: 0.3;"></i>
            <div>未找到相关商户</div>
          </div>
        </div>
        <div v-if="shopLoading" style="text-align: center; padding: 30px;">
          <i class="el-icon-loading" style="font-size: 24px; color: #f63;"></i>
        </div>
        <div v-for="s in shops" class="shop-item" @click="selectShop(s)">
          <div class="shop-name">{{s.name}}</div>
          <div>{{s.area}}</div>
        </div>
      </div>
    </div>
  </transition>
</div>
<script src="./js/vue.js"></script>
<script src="./js/axios.min.js"></script>
<!-- 引入组件库 -->
<script src="./js/element.js"></script>
<script src="./js/common.js"></script>
<script src="./js/footer.js"></script>
<script>
  const app = new Vue({
    el: "#app",
    data() {
      return {
        util,
        fileList: [], // 文件列表
        uploading: [], // 记录每个文件的上传状态
        params: {
          title: '',
          content: ''
        },
        showDialog: false, // 商户选择弹窗
        shops: [], // 商户信息
        shopName: "", // 商户名称
        selectedShop: {}, // 选中的商户
        canSubmit: false, // 是否可以提交
        isSubmitting: false, // 是否正在提交
        shopLoading: false // 商户搜索加载状态
      }
    },
    created() {
      this.checkLogin();
      this.queryShops();
    },
    methods: {
      // 显示提示信息
      showTips() {
        this.$message({
          message: '优质笔记更容易获得推荐：\n1. 上传清晰的图片\n2. 标题突出重点\n3. 内容详细描述体验',
          type: 'info',
          duration: 3000,
          showClose: true
        });
      },

      // 检查是否可以提交
      checkSubmitStatus() {
        this.canSubmit = this.params.title.trim() !== '' &&
                this.params.content.trim() !== '' &&
                this.fileList.length > 0;
      },

      // 查询商户
      queryShops() {
        this.shopLoading = true;
        axios.get("/app/shop/of/name?name=" + this.shopName)
                .then(({data}) => {
                  this.shops = data || [];
                  this.shopLoading = false;
                })
                .catch(err => {
                  this.$message.error('获取商户失败');
                  this.shopLoading = false;
                })
      },

      // 选择商户
      selectShop(s) {
        this.selectedShop = s;
        this.showDialog = false;
      },

      // 提交笔记
      submitBlog() {
        if (!this.canSubmit) return;

        this.isSubmitting = true;

        let {...data} = this.params;
        // data.images = this.fileList.join(",");
        data.images = this.fileList.map(url =>
                url.split(filePrefix)[1] || url
        ).join(",");
        data.shopId = this.selectedShop.id;

        axios.post("/app/blog", data)
                .then(resp => {
                  this.$message.success('发布成功！');
                  setTimeout(() => {
                    location.href = "/info.html";
                  }, 1000);
                })
                .catch(err => {
                  this.$message.error(err.response?.data?.message || '发布失败，请重试');
                  this.isSubmitting = false;
                })
      },

      // 打开文件选择
      openFileDialog() {
        if (this.fileList.length >= 9) {
          this.$message.warning('最多只能上传9张图片');
          return;
        }
        this.$refs.fileInput.click();
      },

      // 文件选择处理
      fileSelected() {
        let file = this.$refs.fileInput.files[0];
        if (!file) return;

        // 检查文件类型
        if (!file.type.startsWith('image/')) {
          this.$message.error('请选择图片文件');
          return;
        }

        // 检查文件大小
        if (file.size > 10 * 1024 * 1024) {
          this.$message.error('图片大小不能超过10MB');
          return;
        }

        // 添加到上传列表，标记为上传中
        const tempUrl = URL.createObjectURL(file);
        this.fileList.push(tempUrl);
        this.uploading.push(true);

        // 清空input值，允许重复选择同一文件
        this.$refs.fileInput.value = '';

        let formData = new FormData();
        formData.append("file", file);

        // 微服务环境配置
        const config = {
          headers: {
            'Content-Type': 'multipart/form-data'
            // 'X-Service-Id': 'file-service' // 如需要
          },
          timeout: 30000
        };

        axios.post("/app/file/appUpload", formData, config)
                .then(({data}) => {
                  // 替换临时URL为实际URL
                  const index = this.fileList.indexOf(tempUrl);
                  if (index !== -1) {
                    this.fileList[index] = data;
                    this.uploading[index] = false;
                    URL.revokeObjectURL(tempUrl); // 释放临时URL
                  }
                  this.checkSubmitStatus();
                })
                .catch(err => {
                  // 上传失败，移除该文件
                  const index = this.fileList.indexOf(tempUrl);
                  if (index !== -1) {
                    this.fileList.splice(index, 1);
                    this.uploading.splice(index, 1);
                    URL.revokeObjectURL(tempUrl);
                  }
                  this.$message.error('图片上传失败，请重试');
                });
      },

      // 删除图片
      deletePic(i) {
        const url = this.fileList[i];
        // 只删除已上传成功的图片
        if (!this.uploading[i]) {
          axios.get("/app/file/appDelete?name=" + url)
                  .catch(err => {
                    console.error('删除图片失败', err);
                  });
        }
        this.fileList.splice(i, 1);
        this.uploading.splice(i, 1);
        this.checkSubmitStatus();
      },

      // 检查登录状态
      checkLogin() {
        let token = sessionStorage.getItem("token");
        if (!token) {
          location.href = "login.html";
          return;
        }

        axios.get("/app/user/me")
                .catch(err => {
                  this.$message.error('请先登录');
                  setTimeout(() => {
                    location.href = "login.html";
                  }, 1000);
                })
      },

      // 返回
      goBack() {
        if (this.params.title || this.params.content || this.fileList.length > 0) {
          this.$confirm('确定要放弃编辑吗？已输入的内容将会丢失', '提示', {
            confirmButtonText: '确定',
            cancelButtonText: '取消',
            type: 'warning'
          }).then(() => {
            history.back();
          }).catch(() => {
            // 取消返回
          });
        } else {
          history.back();
        }
      }
    }
  })
</script>
</body>
</html>