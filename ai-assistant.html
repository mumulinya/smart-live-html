<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <title>智评生活 - AI助手</title>
  <!-- 引入样式 -->
  <link rel="stylesheet" href="./css/element.css">
  <link href="./css/main.css" rel="stylesheet">
  <style type="text/css">
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: #e5e5ea;
      color: #333;
      overflow-x: hidden;
    }

    #app {
      height: 100vh;
      display: flex;
      flex-direction: column;
      background-color: #f8f8f8;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px 20px;
      background-color: #fff;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      z-index: 10;
    }
    .header-back-btn {
      font-size: 20px;
      color: #333;
      cursor: pointer;
      display: flex;
      align-items: center;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      justify-content: center;
      transition: background-color 0.2s;
    }
    .header-back-btn:hover {
      background-color: #f5f5f5;
    }
    .header-title {
      font-size: 18px;
      font-weight: 600;
      flex: 1;
      text-align: center;
    }
    .header-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .header-actions .el-icon {
      font-size: 20px;
      color: #666;
      cursor: pointer;
      transition: color 0.2s;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }
    .header-actions .el-icon:hover {
      color: #f63;
      background-color: #f5f5f5;
    }

    /* 定位状态显示 */
    .location-status {
      padding: 8px 16px;
      background: #f4f4f5;
      color: #909399;
      font-size: 12px;
      text-align: center;
      border-bottom: 1px solid #e6e6e6;
      transition: all 0.3s ease;
      max-height: 40px;
      overflow: hidden;
    }

    .location-status.hidden {
      max-height: 0;
      padding: 0;
      border-bottom: none;
    }

    .location-status.success {
      color: #67C23A;
    }

    .location-status.error {
      color: #F56C6C;
    }

    .chat-messages {
      height: calc(100vh - 220px);
      padding: 20px 15px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      background-color: #f0f2f5;
      background-image:
              radial-gradient(circle at 10px 10px, rgba(0, 0, 0, 0.03) 1px, transparent 0),
              radial-gradient(circle at 20px 20px, rgba(0, 0, 0, 0.02) 1px, transparent 0);
      background-size: 30px 30px;
    }

    /* 消息气泡样式优化 */
    .message {
      max-width: 75%;
      padding: 10px 15px;
      margin-bottom: 12px;
      border-radius: 18px;
      word-wrap: break-word;
      position: relative;
      animation: fadeIn 0.3s ease-out;
      line-height: 1.6;
    }

    .message-left {
      background-color: #fff;
      align-self: flex-start;
      border-top-left-radius: 5px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.08);
    }

    .message-right {
      background-color: #f63;
      color: white;
      align-self: flex-end;
      border-top-right-radius: 5px;
      box-shadow: 0 1px 2px rgba(246, 102, 51, 0.2);
    }

    /* AI消息内容格式化样式 */
    .message-content {
      white-space: pre-wrap;
    }

    /* 代码块样式 */
    .message-code {
      background-color: #f5f5f5;
      color: #333;
      padding: 10px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 0.9em;
      margin: 8px 0;
      overflow-x: auto;
    }

    /* 图片容器样式 */
    .message-image-container {
      margin: 8px 0;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
      max-width: 100%;
      max-height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .message-image {
      max-width: 100%;
      max-height: 300px;
      width: auto;
      height: auto;
      border-radius: 8px;
      transition: transform 0.2s, box-shadow 0.2s;
      cursor: pointer;
    }

    .message-image:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .image-placeholder {
      background-color: #f0f0f0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #999;
      padding: 20px;
      border-radius: 8px;
      width: 100%;
      min-height: 100px;
    }

    .message-time {
      font-size: 0.7em;
      margin-top: 3px;
      text-align: right;
      opacity: 0.7;
    }

    /* AI头像和样式优化 */
    .ai-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, #f63 0%, #ff8a5c 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      margin-right: 10px;
      flex-shrink: 0;
      box-shadow: 0 2px 5px rgba(246, 102, 51, 0.2);
    }

    /* 思考状态动画优化 */
    .thinking {
      display: flex;
      align-items: center;
      padding: 10px 15px;
      margin: 10px 0;
      background-color: #fff;
      border-radius: 18px;
      width: fit-content;
      align-self: flex-start;
      box-shadow: 0 1px 2px rgba(0,0,0,0.08);
    }

    .thinking-dot {
      width: 10px;
      height: 10px;
      background-color: #f63;
      border-radius: 50%;
      margin: 0 3px;
      animation: bounce 1.4s infinite ease-in-out both;
    }

    .thinking-dot:nth-child(1) { animation-delay: -0.32s; }
    .thinking-dot:nth-child(2) { animation-delay: -0.16s; }

    /* 输入区域样式优化 */
    .chat-input {
      padding: 12px 15px;
      border-top: 1px solid #eee;
      display: flex;
      background-color: #fff;
      flex-direction: column;
      box-shadow: 0 -1px 3px rgba(0, 0, 0, 0.05);
    }

    .chat-input-top {
      display: flex;
      width: 100%;
      margin-bottom: 10px;
    }

    .chat-input input {
      flex: 1;
      padding: 12px 18px;
      border: 1px solid #e0e0e0;
      border-radius: 24px;
      margin-right: 10px;
      font-size: 1em;
      transition: all 0.2s;
      outline: none;
    }

    .chat-input input:focus {
      border-color: #f63;
      box-shadow: 0 0 0 2px rgba(246, 102, 51, 0.1);
    }

    .chat-input button {
      padding: 12px 22px;
      background: linear-gradient(135deg, #f63 0%, #ff8a5c 100%);
      color: white;
      border: none;
      border-radius: 24px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
      box-shadow: 0 2px 5px rgba(246, 102, 51, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .chat-input button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(246, 102, 51, 0.3);
    }

    .chat-input button:active {
      transform: translateY(1px);
      box-shadow: 0 1px 3px rgba(246, 102, 51, 0.2);
    }

    .chat-input button:disabled {
      background: #ffaa80;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* 建议按钮样式优化 */
    .suggestion-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 5px;
      padding-bottom: 5px;
    }

    .suggestion-btn {
      background-color: #f5f5f5;
      border: 1px solid #e8e8e8;
      border-radius: 18px;
      padding: 6px 14px;
      font-size: 0.85em;
      cursor: pointer;
      transition: all 0.2s;
      color: #444;
    }

    .suggestion-btn:hover {
      background-color: #eeeeee;
      transform: translateY(-1px);
      box-shadow: 0 2px 3px rgba(0, 0, 0, 0.05);
    }

    .suggestion-btn:active {
      transform: translateY(0);
    }

    /* 动画效果 */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0.6); }
      40% { transform: scale(1); }
    }

    /* 滚动条美化 */
    .chat-messages::-webkit-scrollbar {
      width: 6px;
    }

    .chat-messages::-webkit-scrollbar-track {
      background: transparent;
    }

    .chat-messages::-webkit-scrollbar-thumb {
      background-color: rgba(0, 0, 0, 0.1);
      border-radius: 3px;
    }

    .chat-messages::-webkit-scrollbar-thumb:hover {
      background-color: rgba(0, 0, 0, 0.2);
    }

    /* 消息发送状态指示器 */
    .message-status {
      display: inline-block;
      width: 16px;
      height: 16px;
      margin-left: 5px;
      vertical-align: middle;
    }

    /* 空状态样式 */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      color: #999;
      text-align: center;
    }

    .empty-icon {
      font-size: 60px;
      margin-bottom: 20px;
      opacity: 0.3;
    }

    /* 图片预览模态框 */
    .image-preview-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }

    .image-preview-modal.active {
      opacity: 1;
      visibility: visible;
    }

    .preview-image {
      max-width: 90%;
      max-height: 90%;
      object-fit: contain;
    }

    .close-preview {
      position: absolute;
      top: 20px;
      right: 20px;
      color: white;
      font-size: 30px;
      cursor: pointer;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: rgba(0, 0, 0, 0.5);
      border-radius: 50%;
    }
  </style>
</head>
<body>
<div id="app">
  <div class="header">
    <div class="header-back-btn" @click="goBack">
      <i class="el-icon-arrow-left"></i>
    </div>
    <div class="header-title">AI助手</div>
    <div class="header-actions">
      <i class="el-icon-location" @click="reGetLocation" title="重新定位"></i>
      <i class="el-icon-more" @click="showOptions"></i>
    </div>
  </div>

  <!-- 定位状态显示 -->
  <div class="location-status" :class="{
        'success': usingCachedLocation && !locationLoading && !locationError,
        'error': locationError,
        'hidden': !showLocationStatus
      }" v-if="showLocationStatus">
    <i class="el-icon-loading" v-if="locationLoading"></i>
    <i class="el-icon-location" v-else-if="usingCachedLocation && !locationError"></i>
    <i class="el-icon-warning" v-else-if="locationError"></i>
    {{ locationStatusText }}
  </div>

  <div class="chat-messages" ref="chatMessages">
    <div v-if="messages.length === 0 && !isThinking" class="message message-left">
      <div style="display: flex; align-items: flex-start;">
        <div class="ai-avatar">AI</div>
        <div>
          <div class="message-content">你好！我是智评生活AI助手，有什么可以帮您的吗？</div>
          <div class="message-time">刚刚</div>
        </div>
      </div>
    </div>

    <div v-if="isThinking" class="thinking">
      <div class="ai-avatar" style="width: 28px; height: 28px; font-size: 12px; margin-right: 8px;">AI</div>
      <div class="thinking-dot"></div>
      <div class="thinking-dot"></div>
      <div class="thinking-dot"></div>
    </div>

    <div v-for="msg in messages" :key="msg.id" class="message" :class="{'message-left': !msg.isSelf, 'message-right': msg.isSelf}">
      <div v-if="!msg.isSelf" style="display: flex; align-items: flex-start;">
        <div class="ai-avatar">AI</div>
        <div>
          <div class="message-content" v-html="formatMessage(msg.text)"></div>
          <div class="message-time">{{msg.time}}</div>
        </div>
      </div>
      <div v-else>
        <div class="message-content">{{msg.text}}</div>
        <div class="message-time">
          {{msg.time}}
          <i v-if="msg.status === 'sending'" class="el-icon-loading message-status" style="font-size: 12px;"></i>
          <i v-if="msg.status === 'sent'" class="el-icon-check message-status" style="font-size: 12px;"></i>
        </div>
      </div>
    </div>
  </div>

  <div class="chat-input">
    <div class="chat-input-top">
      <input
              type="text"
              v-model="messageInput"
              @input="handleInput"
              @keyup.enter="sendMessage"
              placeholder="输入您的问题...">
      <button @click="sendMessage" :disabled="!messageInput.trim()">
        <i class="el-icon-paper-plane" style="margin-right: 5px;"></i>发送
      </button>
    </div>
    <div class="suggestion-buttons">
      <div class="suggestion-btn" @click="useSuggestion('最近有什么热门餐厅推荐吗？')">热门餐厅推荐</div>
      <div class="suggestion-btn" @click="useSuggestion('如何写一篇好的美食评论？')">写美食评论</div>
      <div class="suggestion-btn" @click="useSuggestion('帮我规划一个周末美食之旅')">周末美食之旅</div>
      <div class="suggestion-btn" @click="useSuggestion('附近有什么适合约会的餐厅？')">约会餐厅推荐</div>
    </div>
  </div>

  <!-- 图片预览模态框 -->
  <div class="image-preview-modal" :class="{active: isPreviewActive}" @click="closeImagePreview">
    <div class="close-preview" @click="closeImagePreview">×</div>
    <img :src="previewImageUrl" class="preview-image" @click.stop>
  </div>
</div>

<script src="./js/vue.js"></script>
<script src="./js/axios.min.js"></script>
<!-- 引入组件库 -->
<script src="./js/element.js"></script>
<script src="./js/common.js"></script>
<script>
  const app = new Vue({
    el: "#app",
    data: {
      messages: [],
      messageInput: "",
      isThinking: false,
      isLoading: false,
      isPreviewActive: false,
      previewImageUrl: "",
      user:{},
      // 定位相关数据
      locationLoading: false,
      locationError: false,
      usingCachedLocation: false,
      showLocationStatus: false,
      userLocation: {
        x: 120.149993,
        y: 30.334229,
        region:{}
      }
    },
    computed: {
      locationStatusText() {
        if (this.locationLoading) return "定位中...";
        if (this.usingCachedLocation && !this.locationError) return "已使用缓存位置";
        if (this.locationError) return "定位失败，使用默认位置";
        return "";
      }
    },
    created() {
      this.initData();
      this.initLocation();
    },
    mounted() {
      this.scrollToBottom();

      const chatMessages = this.$refs.chatMessages;
      if (chatMessages) {
        chatMessages.addEventListener('click', (e) => {
          const img = e.target.closest('.message-image');
          if (img) {
            e.preventDefault();
            this.previewImageUrl = img.src;
            this.isPreviewActive = true;
          }
        });
      }
    },
    methods: {
      initData() {
        const history = localStorage.getItem('ai_chat_history');
        if (history) {
          try {
            this.messages = JSON.parse(history);
          } catch (e) {
            console.error('Failed to parse chat history', e);
          }
        }
      },
      // 获取地区信息
// 添加详细的错误日志
      async getRegionInfo(lng, lat) {
        try {
          console.log('开始获取地区信息，坐标:', lng, lat);

          const response = await fetch(
                  `https://restapi.amap.com/v3/geocode/regeo?key=60bdbf9b9cf98025c397ee43e8c25871&location=${lng},${lat}`
          );

          console.log('响应状态:', response.status, response.statusText);

          const data = await response.json();
          console.log('API返回数据:', data);

          if (data.status === '1' && data.regeocode) {
            const address = data.regeocode.addressComponent;
            const result = {
              province: address.province,
              city: address.city || address.province,
              district: address.district,
              township: address.township,
              fullAddress: data.regeocode.formatted_address
            };
            console.log('解析后的地区信息:', result);
            return result;
          } else {
            throw new Error(`API返回错误: ${data.info}`);
          }
        } catch (error) {
          console.error('获取地区信息详细错误:', error);
          return null;
        }
      },
      // 显示定位状态（3秒后自动隐藏）
      showLocationStatusMessage() {
        this.showLocationStatus = true;

        setTimeout(() => {
          this.hideLocationStatus();
        }, 3000);
      },

      // 隐藏定位状态
      hideLocationStatus() {
        this.showLocationStatus = false;
      },

      // 初始化位置信息
      initLocation() {
        const cachedLocation = this.getCachedLocation();

        if (cachedLocation) {
          console.log("使用缓存位置:", cachedLocation);
          this.userLocation.x = cachedLocation.x;
          this.userLocation.y = cachedLocation.y;
          this.usingCachedLocation = true;
          this.locationError = false;
          this.userLocation.region = cachedLocation.region;
          this.showLocationStatusMessage();
        } else {
          console.log("缓存中没有位置，开始定位");
          this.getLocation();
        }
      },

      // 获取缓存中的位置
      getCachedLocation() {
        try {
          const cached = localStorage.getItem('user_location');
          if (cached) {
            const location = JSON.parse(cached);
            const cacheTime = localStorage.getItem('user_location_time');
            const now = new Date().getTime();
            if (cacheTime && (now - parseInt(cacheTime)) < 24 * 60 * 60 * 1000) {
              return location;
            } else {
              this.clearLocationCache();
              return null;
            }
          }
        } catch (error) {
          console.log("读取位置缓存失败:", error);
          this.clearLocationCache();
        }
        return null;
      },

      // 保存位置到缓存
      saveLocationToCache(x, y,region) {
        try {
          const location = { x, y, region };
          localStorage.setItem('user_location', JSON.stringify(location));
          localStorage.setItem('user_location_time', new Date().getTime().toString());
          console.log("位置已保存到缓存:", location);
        } catch (error) {
          console.log("保存位置缓存失败:", error);
        }
      },

      // 清除位置缓存
      clearLocationCache() {
        try {
          localStorage.removeItem('user_location');
          localStorage.removeItem('user_location_time');
          console.log("位置缓存已清除");
        } catch (error) {
          console.log("清除位置缓存失败:", error);
        }
      },

      // 自动定位方法
      getLocation() {
        this.showLocationStatus = true;
        this.locationLoading = true;
        this.locationError = false;
        this.usingCachedLocation = false;

        if (!navigator.geolocation) {
          console.log("浏览器不支持地理定位");
          this.locationError = true;
          this.locationLoading = false;
          this.showLocationStatusMessage();
          return;
        }

        const options = {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 60000
        };

        navigator.geolocation.getCurrentPosition(
              async  (position) => {
                  console.log("定位成功:", position);
                const convertedCoord   =this.transformWGS84ToGCJ02(position.coords.longitude, position.coords.latitude)
                  const longitude = convertedCoord.lng;
                  const latitude = convertedCoord.lat;

                  this.userLocation.x = longitude;
                  this.userLocation.y = latitude;


                // 等待地区信息获取完成
                try {
                  const regionInfo = await this.getRegionInfo(longitude, latitude);
                  if (regionInfo) {
                    this.userLocation.region = regionInfo;
                    console.log("地区信息获取成功:", regionInfo);

                    // 保存包含地区信息的缓存
                    this.saveLocationToCache(longitude, latitude, regionInfo);

                    // 显示包含地区的成功消息
                    this.$message({
                      message: `定位成功：${regionInfo.district}`,
                      type: 'success',
                      duration: 2000
                    });
                  } else {
                    throw new Error('获取地区信息失败');
                  }
                } catch (error) {
                  console.error('获取地区信息失败:', error);
                  // 即使地区获取失败，也保存坐标
                  this.saveLocationToCache(longitude, latitude, null);

                  this.$message({
                    message: '定位成功（地区信息获取失败）',
                    type: 'warning',
                    duration: 2000
                  });
                }
                  console.log("当前位置 - 经度:", longitude, "纬度:", latitude, "地区:", this.userLocation.region);
                  this.locationLoading = false;
                  this.usingCachedLocation = false;
                  this.showLocationStatusMessage();

                  this.$message({
                    message: '定位成功',
                    type: 'success',
                    duration: 2000
                  });
                },
                (error) => {
                  console.log("定位失败:", error);
                  this.locationError = true;
                  this.locationLoading = false;
                  this.showLocationStatusMessage();

                  this.$message({
                    message: '定位失败，使用默认位置',
                    type: 'warning',
                    duration: 2000
                  });
                },
                options
        );
      },

      // 手动重新定位方法
      reGetLocation() {
        this.clearLocationCache();
        this.showLocationStatus = true;
        this.locationLoading = true;
        this.locationError = false;
        this.usingCachedLocation = false;
        this.getLocation();
      },
      // GPS坐标转高德坐标
      transformWGS84ToGCJ02(lng, lat) {
        // 简化的坐标转换（实际应该使用更精确的算法）
        const x = lng - 0.0065;
        const y = lat - 0.0060;
        return { lng: x, lat: y };
      },
      saveHistory() {
        localStorage.setItem('ai_chat_history', JSON.stringify(this.messages));
      },

      scrollToBottom() {
        this.$nextTick(() => {
          const chatMessages = this.$refs.chatMessages;
          if (chatMessages) {
            chatMessages.scrollTop = chatMessages.scrollHeight;
          }
        });
      },

      addMessage(text, isSelf, status = 'sent') {
        const now = new Date();
        const timeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;

        const message = {
          id: Date.now() + Math.random().toString(36).substr(2, 5),
          text: text,
          time: timeStr,
          isSelf: isSelf,
          status: status
        };

        this.messages.push(message);
        this.scrollToBottom();
        this.saveHistory();

        return message.id;
      },

      // 发送消息
      async sendMessage() {
        if (!this.messageInput.trim() || this.isThinking) return;

        if (this.containsOrderKeywords(this.messageInput)){
          console.log("用户信息为"+this.user.id)
          //查询用户信息，未登录则跳转登录页面
          if(this.user.id== null){
            await this.queryUser();
          }
        }

        const userMessageId = this.addMessage(this.messageInput, true, 'sending');
        this.isThinking = true;
        const userInput = this.messageInput;
        this.messageInput = "";

        try {
          const aiMessageId = this.addMessage("▌", false);
          this.isThinking = false;
          this.scrollToBottom();

          const userMsgIndex = this.messages.findIndex(msg => msg.id === userMessageId);
          if (userMsgIndex !== -1) {
            this.messages[userMsgIndex].status = 'sent';
          }

          await this.streamResponse(userInput, aiMessageId);

        } catch (error) {
          console.error('请求错误:', error);
          this.isThinking = false;

          const userMsgIndex = this.messages.findIndex(msg => msg.id === userMessageId);
          if (userMsgIndex !== -1) {
            this.messages[userMsgIndex].status = 'sent';
          }

          const errorIndex = this.messages.findIndex(msg => msg.text === "▌" && !msg.isSelf);
          if (errorIndex !== -1) {
            this.messages[errorIndex].text = "抱歉，请求失败，请稍后重试";
          } else {
            this.addMessage("抱歉，请求失败，请稍后重试", false);
          }
        }
      },

      // 流式响应处理
      async streamResponse(userInput, messageId) {
        try {
          console.log('开始流式请求');
          const response = await fetch('/app-dev-api/app/ai/ai/chat', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              message: userInput,
              sessionId: 'user-session-' + Date.now(),
              x: this.userLocation.x,
              y: this.userLocation.y,
              district: this.userLocation.region.district,
              userId: this.user.id
            })
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let accumulatedText = '';

          while (true) {
            const { done, value } = await reader.read();

            if (done) {
              console.log('流式传输完成');
              break;
            }

            const chunk = decoder.decode(value, { stream: true });

            if (chunk.trim()) {
              accumulatedText += chunk;
              this.updateMessageContent(messageId, accumulatedText);
            }
          }

        } catch (error) {
          console.error('流式请求错误:', error);
          throw error;
        }
      },
      // 查询用户信息
      async  queryUser() {
        console.log("queryUser")
        try {
          let response=await axios.get("/app/user/me")
          this.user = response.data;
        } catch (error) {
          console.error('查询用户信息失败:', error);
          this.$message({
            type: 'warning',
            message: '请先登录，登录才能下单',
            duration: 1000,
            onClose: () => {
              location.href = "login.html";
            }
          });
          return;
        }
      },

// 判断是否包含下单相关关键词
      containsOrderKeywords(input) {
        const orderKeywords = [
          '下单', '订购', '购买', '买', 'order', 'purchase', 'buy',
          '我要订', '我想买', '帮我下单', '下单购买', '立即购买'
        ];
        const lowerInput = input.toLowerCase();
        return orderKeywords.some(keyword => lowerInput.includes(keyword.toLowerCase()));
      },
      // 更新消息内容
      updateMessageContent(messageId, newContent) {
        const messageIndex = this.messages.findIndex(msg => msg.id === messageId);
        if (messageIndex !== -1) {
          this.messages[messageIndex].text = newContent;
          this.$forceUpdate();
          this.scrollToBottom();
          this.saveHistory();
        }
      },

      // 格式化消息内容
      formatMessage(text) {
        if (!text) return '';

        let formatted = text.replace(/\n/g, '<br>');

        formatted = formatted.replace(/```([\s\S]*?)```/g, (match, code) => {
          return `<div class="message-code">${code.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>`;
        });

        formatted = formatted.replace(/(https?:\/\/[^\s]+\.(jpg|jpeg|png|gif|bmp|webp))/g, (url) => {
          return `<div class="message-image-container">
                    <img src="${url}" class="message-image"
                         onerror="this.parentElement.innerHTML='<div class=\'image-placeholder\'>图片加载失败</div>'">
                  </div>`;
        });

        return formatted;
      },

      closeImagePreview() {
        this.isPreviewActive = false;
        this.previewImageUrl = "";
      },

      handleInput() {
        // 输入框变化处理
      },

      goBack() {
        location.href = "/index.html";
      },

      useSuggestion(text) {
        this.messageInput = text;
        this.sendMessage();
      },

      showOptions() {
        this.$confirm('对话选项', '提示', {
          confirmButtonText: '清空对话',
          cancelButtonText: '取消',
          type: 'info'
        }).then(() => {
          this.messages = [];
          localStorage.removeItem('ai_chat_history');
          this.scrollToBottom();
        }).catch(() => {
          // 取消操作
        });
      }
    }
  })
</script>
</body>
</html>