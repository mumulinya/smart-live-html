<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <title>智评生活 - 地图</title>
  <!-- 引入样式 -->
  <link rel="stylesheet" href="./css/element.css">
  <link href="./css/main.css" rel="stylesheet">

  <style type="text/css">
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background-color: #f5f5f5;
      height: 100vh;
      overflow: hidden;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px;
      border-bottom: 1px solid #eee;
      background-color: #fff;
      z-index: 1000;
    }

    .header-back-btn {
      font-size: 20px;
      color: #333;
      cursor: pointer;
      display: flex;
      align-items: center;
    }

    .header-title {
      font-size: 18px;
      font-weight: bold;
      flex: 1;
      text-align: center;
    }

    .map-container {
      position: relative;
      height: calc(100vh - 110px);
    }

    /* 高德地图容器 */
    #amap-container {
      width: 100%;
      height: 100%;
    }

    /* 搜索栏 */
    .search-bar {
      position: absolute;
      top: 15px;
      left: 15px;
      right: 15px;
      z-index: 100;
      display: flex;
      background-color: white;
      border-radius: 20px;
      padding: 5px 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .search-input {
      flex: 1;
      margin-right: 10px;
    }

    .search-input .el-input__inner {
      border: none !important;
      height: 30px;
    }

    .filter-btn {
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    /* 分类筛选 */
    .category-filter {
      position: absolute;
      top: 60px;
      left: 15px;
      right: 15px;
      background-color: white;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      z-index: 100;
      max-height: 100px;
      overflow-y: auto;
    }

    .category-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .category-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 60px;
      height: 60px;
      cursor: pointer;
    }

    .category-icon {
      width: 30px;
      height: 30px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 5px;
    }

    .category-text {
      font-size: 12px;
      color: #333;
    }

    /* 店铺列表 */
    .shop-list {
      position: absolute;
      bottom: 70px;
      left: 15px;
      right: 15px;
      background-color: white;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 2px 15px rgba(0,0,0,0.1);
      z-index: 100;
      max-height: 200px;
      overflow-y: auto;
    }

    .shop-item {
      display: flex;
      padding: 10px 0;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }

    .shop-item:last-child {
      border-bottom: none;
    }

    .shop-avatar {
      width: 50px;
      height: 50px;
      border-radius: 5px;
      object-fit: cover;
      margin-right: 10px;
      background-color: #f0f0f0;
    }

    .shop-info {
      flex: 1;
      overflow: hidden;
    }

    .shop-name {
      font-weight: bold;
      margin-bottom: 5px;
    }

    .shop-rate {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }

    .shop-score {
      color: #f63;
      margin-right: 5px;
    }

    .shop-distance {
      color: #999;
      font-size: 12px;
    }

    /* 控制按钮 */
    .control-buttons {
      position: absolute;
      bottom: 15px;
      right: 15px;
      z-index: 100;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .control-btn {
      width: 45px;
      height: 45px;
      background-color: white;
      border: 1px solid #ddd;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .control-btn i {
      font-size: 20px;
      color: #333;
    }
  </style>
</head>
<body>
<div id="app">
  <div class="header">
    <div class="header-back-btn" @click="goBack">
      <i class="el-icon-arrow-left"></i>
      <span style="margin-left: 5px; font-size: 16px;">返回</span>
    </div>
    <div class="header-title">地图</div>
    <div style="width: 20px;"></div>
  </div>

  <div class="map-container">
    <!-- 高德地图容器 -->
    <div id="amap-container"></div>

    <!-- 搜索栏 -->
    <div class="search-bar">
      <div class="search-input">
        <el-input size="mini" placeholder="搜索商家、地点" v-model="searchKeyword" @input="searchShops">
          <i slot="prefix" class="el-input__icon el-icon-search"></i>
        </el-input>
      </div>
      <div class="filter-btn" @click="toggleFilters">
        <i class="el-icon-film"></i>
      </div>
    </div>

    <!-- 分类筛选 -->
    <div class="category-filter" v-show="showFilters">
      <div class="category-list">
        <div v-for="type in types" :key="type.id" class="category-item" @click="selectCategory(type)">
          <div class="category-icon" :style="{ backgroundColor: type.color }">
            <i :class="type.icon" style="color: white;"></i>
          </div>
          <div class="category-text">{{ type.name }}</div>
        </div>
      </div>
    </div>

    <!-- 店铺列表 -->
    <div class="shop-list">
      <div v-for="shop in filteredShops" :key="shop.id" class="shop-item" @click="centerToShop(shop)">
        <img :src="shop.avatar || '/imgs/default-shop.jpg'" alt="" class="shop-avatar">
        <div class="shop-info">
          <div class="shop-name">{{ shop.name }}</div>
          <div class="shop-rate">
            <span class="shop-score">{{ shop.score }}</span>
            <el-rate disabled v-model="shop.score/10" text-color="#F63" :size="12"></el-rate>
          </div>
          <div class="shop-distance">{{ shop.distance }}m</div>
        </div>
      </div>
    </div>

    <!-- 控制按钮 -->
    <div class="control-buttons">
      <div class="control-btn" @click="centerToCurrentLocation">
        <i class="el-icon-location-outline"></i>
      </div>
      <div class="control-btn" @click="refreshData">
        <i class="el-icon-refresh"></i>
      </div>
    </div>
  </div>

  <foot-bar :active-btn="2"></foot-bar>
</div>

<script src="./js/vue.js"></script>
<script src="./js/axios.min.js"></script>
<!-- 引入组件库 -->
<script src="./js/element.js"></script>
<script src="./js/common.js"></script>
<script src="./js/footer.js"></script>
<!-- 高德地图API -->
<script src="https://webapi.amap.com/maps?v=1.4.15&key=60bdbf9b9cf98025c397ee43e8c25871"></script>
<script>
  const app = new Vue({
    el: "#app",
    data: {
      searchKeyword: "",
      showFilters: false,
      selectedShopId: null,
      isLoading: false,
      currentType: null,
      map: null,
      markers: [],
      infoWindows: [],
      currentLocationMarker: null, // 新增：当前用户位置标记
      types: [
        { id: 1, name: "美食", icon: "el-icon-food", color: "#f63" },
        { id: 2, name: "外卖", icon: "el-icon-takeaway-box", color: "#07c160" },
        { id: 3, name: "超市", icon: "el-icon-shopping-cart-2", color: "#1989fa" },
        { id: 4, name: "水果", icon: "el-icon-apple", color: "#ff6b3b" },
        { id: 5, name: "甜品", icon: "el-icon-dessert", color: "#9a66e4" },
        { id: 6, name: "饮品", icon: "el-icon-coffee-cup", color: "#00bcd4" },
        { id: 7, name: "快餐", icon: "el-icon-burger", color: "#ff9900" },
        { id: 8, name: "火锅", icon: "el-icon-hot-water", color: "#e4393c" }
      ],
      shops: [
        {
          id: 1,
          name: "江南小馆",
          score: 4.8,
          distance: 150,
          avatar: "/imgs/shop1.jpg",
          x: 120.16142, // 经度
          y: 30.279693  // 纬度
        },
        {
          id: 2,
          name: "星空西餐厅",
          score: 4.9,
          distance: 320,
          avatar: "/imgs/shop2.jpg",
          x: 120.16242,
          y: 30.278693
        },
        {
          id: 3,
          name: "老北京炸酱面",
          score: 4.6,
          distance: 80,
          avatar: "/imgs/shop3.jpg",
          x: 120.16042,
          y: 30.277693
        },
        {
          id: 4,
          name: "时光咖啡",
          score: 4.7,
          distance: 210,
          avatar: "/imgs/shop4.jpg",
          x: 120.16342,
          y: 30.276693
        },
        {
          id: 5,
          name: "甜蜜时光",
          score: 4.8,
          distance: 450,
          avatar: "/imgs/shop5.jpg",
          x: 120.15942,
          y: 30.275693
        },
        {
          id: 6,
          name: "美味烧烤",
          score: 4.5,
          distance: 120,
          avatar: "/imgs/shop6.jpg",
          x: 120.16442,
          y: 30.274693
        },
        {
          id: 7,
          name: "健康沙拉",
          score: 4.7,
          distance: 280,
          avatar: "/imgs/shop7.jpg",
          x: 120.15842,
          y: 30.273693
        },
        {
          id: 8,
          name: "奶茶专家",
          score: 4.6,
          distance: 90,
          avatar: "/imgs/shop8.jpg",
          x: 120.16542,
          y: 30.272693
        }
      ],
      filteredShops: []
    },
    created() {
      this.filteredShops = [...this.shops];
    },
    mounted() {
      // 初始化高德地图
      this.initMap();
    },
    methods: {
      initMap() {
        // 初始化地图
        this.map = new AMap.Map('amap-container', {
          zoom: 15,
          center: [120.16142, 30.279693], // 默认中心点（可以是用户当前位置）
          viewMode: '2D'
        });

        // 添加店铺标记
        this.addShopMarkers();

        // 监听地图移动事件
        this.map.on('moveend', () => {
          console.log('地图移动结束');
        });
      },

      addShopMarkers() {
        // 清除现有标记
        if (this.markers.length > 0) {
          this.map.remove(this.markers);
          this.markers = [];
        }

        if (this.infoWindows.length > 0) {
          this.infoWindows.forEach(win => win.close());
          this.infoWindows = [];
        }

        // 为每个店铺添加标记
        this.filteredShops.forEach(shop => {
          const marker = new AMap.Marker({
            position: [shop.x, shop.y],
            offset: new AMap.Pixel(-12, -36),
            extData: shop,
            label: {
              content: shop.name,
              direction: 'top',
              offset: new AMap.Pixel(0, -40)
            }
          });

          // 添加点击事件
          marker.on('click', () => {
            this.showInfoWindow(shop);
          });

          this.markers.push(marker);
        });

        // 将所有标记添加到地图
        this.map.add(this.markers);

        // 如果有标记，调整视野以包含所有标记
        if (this.markers.length > 0) {
          this.map.setFitView(this.markers);
        }
      },

      showInfoWindow(shop) {
        // 关闭所有已打开的信息窗口
        this.infoWindows.forEach(win => win.close());
        this.infoWindows = [];

        // 创建信息窗口内容
        const content = `
          <div style="min-width: 200px; padding: 10px;">
            <h4 style="margin: 0 0 10px 0; color: #333;">${shop.name}</h4>
            <div style="display: flex; align-items: center; margin-bottom: 5px;">
              <span class="shop-score">${shop.score}</span>
              <div style="font-size: 12px; color: #999;">${shop.comments ? shop.comments + '条评论' : ''}</div>
            </div>
            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">距离 ${shop.distance}m</div>
            <div style="font-size: 12px; color: #666; margin-bottom: 10px;">${shop.address || '地址信息暂无'}</div>
            <div style="text-align: right;">
              <button onclick="app.toShopDetail(${shop.id})"
                      style="background-color: #f63; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">
                查看详情
              </button>
            </div>
          </div>
        `;

        // 创建信息窗口
        const infoWindow = new AMap.InfoWindow({
          content: content,
          offset: new AMap.Pixel(0, -30)
        });

        // 打开信息窗口
        infoWindow.open(this.map, [shop.x, shop.y]);

        // 保存引用以便后续关闭
        this.infoWindows.push(infoWindow);
      },

      toggleFilters() {
        this.showFilters = !this.showFilters;
      },

      selectCategory(type) {
        this.currentType = type;
        this.showFilters = false;
        this.$message.success(`已筛选${type.name}类别`);

        // 这里可以添加实际的分类筛选逻辑
        this.filterShops();
      },

      filterShops() {
        if (!this.currentType) {
          this.filteredShops = [...this.shops];
        } else {
          // 这里可以根据类型进行筛选
          this.filteredShops = this.shops;
        }

        // 重新添加标记
        this.addShopMarkers();
      },

      centerToShop(shop) {
        // 跳转到店铺详情页
        this.toShopDetail(shop.id);
      },

      searchShops() {
        if (!this.searchKeyword.trim()) {
          this.filteredShops = [...this.shops];
          this.addShopMarkers();
          return;
        }

        const keyword = this.searchKeyword.toLowerCase();
        this.filteredShops = this.shops.filter(shop =>
                shop.name.toLowerCase().includes(keyword)
        );

        // 重新添加标记
        this.addShopMarkers();
      },

      centerToCurrentLocation() {
        // 定位到用户当前位置
        this.isLoading = true;

        // 使用高德地图的定位插件
        AMap.plugin('AMap.Geolocation', () => {
          const geolocation = new AMap.Geolocation({
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0,
            convert: true,
            showButton: true,
            showMarker: true,
            showCircle: true,
            panToLocation: true,
            trackLocation: false
          });

          geolocation.getCurrentPosition((status, result) => {
            this.isLoading = false;
            if (status === 'complete') {
              this.$message.success("定位成功");

              // 移除之前的位置标记（如果存在）
              if (this.currentLocationMarker) {
                this.map.remove(this.currentLocationMarker);
              }

              // 创建新的位置标记
              this.currentLocationMarker = new AMap.Marker({
                position: [result.position.lng, result.position.lat],
                offset: new AMap.Pixel(-15, -15),
                icon: new AMap.Icon({
                  size: new AMap.Size(30, 30),
                  image: 'https://a.amap.com/jsapi_demos/static/demo-center/icons/poi-marker-default.png',
                  imageSize: new AMap.Size(30, 30)
                }),
                title: '我的位置'
              });

              // 将标记添加到地图
              this.map.add(this.currentLocationMarker);

              // 更新地图中心
              this.map.setCenter([result.position.lng, result.position.lat]);
            } else {
              this.$message.error("定位失败：" + result.message);
              // 使用默认位置
              this.map.setCenter([120.16142, 30.279693]);
            }
          });
        });
      },

      refreshData() {
        this.isLoading = true;
        setTimeout(() => {
          this.isLoading = false;
          this.$message.success("刷新成功");
          // 重新加载数据和标记
          this.addShopMarkers();
        }, 1000);
      },

      toShopDetail(shopId) {
        location.href = `/shop-detail.html?id=${shopId}`;
      },

      goBack() {
        location.href = "/";
      }
    }
  })
</script>
</body>
</html>
