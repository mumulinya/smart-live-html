<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <title>æ™ºè¯„ç”Ÿæ´» - åœ°å›¾</title>
  <!-- å¼•å…¥æ ·å¼ -->
  <link rel="stylesheet" href="./css/element.css">
  <link href="./css/main.css" rel="stylesheet">

  <style type="text/css">
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background-color: #f5f5f5;
      height: 100vh;
      overflow: hidden;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px;
      border-bottom: 1px solid #eee;
      background-color: #fff;
      z-index: 1000;
    }

    .header-back-btn {
      font-size: 20px;
      color: #333;
      cursor: pointer;
      display: flex;
      align-items: center;
    }

    .header-title {
      font-size: 18px;
      font-weight: bold;
      flex: 1;
      text-align: center;
    }

    .map-container {
      position: relative;
      height: calc(100vh - 110px);
    }

    /* é«˜å¾·åœ°å›¾å®¹å™¨ */
    #amap-container {
      width: 100%;
      height: 100%;
    }

    /* æœç´¢æ  */
    .search-bar {
      position: absolute;
      top: 15px;
      left: 15px;
      right: 15px;
      z-index: 100;
      display: flex;
      background-color: white;
      border-radius: 20px;
      padding: 5px 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .search-input {
      flex: 1;
      margin-right: 10px;
    }

    .search-input .el-input__inner {
      border: none !important;
      height: 30px;
    }

    .filter-btn {
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    /* åˆ†ç±»ç­›é€‰ */
    .category-filter {
      position: absolute;
      top: 60px;
      left: 15px;
      right: 15px;
      background-color: white;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      z-index: 100;
      max-height: 100px;
      overflow-y: auto;
    }

    .category-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .category-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 60px;
      height: 60px;
      cursor: pointer;
    }

    /* ğŸ”¥ ä¿®æ”¹å›¾æ ‡å°ºå¯¸ */
    .category-icon {
      width: 24px;  /* å‡å°å®½åº¦ */
      height: 24px; /* å‡å°é«˜åº¦ */
      border-radius: 6px; /* ç›¸åº”å‡å°åœ†è§’ */
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 5px;
      background-color: #f8f9fa; /* æ·»åŠ æµ…è‰²èƒŒæ™¯ */
    }

    /* ğŸ”¥ ç¡®ä¿å›¾æ ‡å›¾ç‰‡å¤§å°åˆé€‚ */
    .category-icon img {
      width: 16px;  /* å›¾æ ‡å›¾ç‰‡å°ºå¯¸ */
      height: 16px; /* å›¾æ ‡å›¾ç‰‡å°ºå¯¸ */
      object-fit: contain; /* ä¿æŒæ¯”ä¾‹ */
    }

    .category-text {
      font-size: 11px; /* ç¨å¾®å‡å°å­—ä½“ */
      color: #333;
      text-align: center;
      line-height: 1.2;
    }

    /* åº—é“ºåˆ—è¡¨ */
    .shop-list {
      position: absolute;
      bottom: 70px;
      left: 15px;
      right: 15px;
      background-color: white;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 2px 15px rgba(0,0,0,0.1);
      z-index: 100;
      max-height: 200px;
      overflow-y: auto;
    }

    .shop-item {
      display: flex;
      padding: 10px 0;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }

    .shop-item:last-child {
      border-bottom: none;
    }

    .shop-avatar {
      width: 50px;
      height: 50px;
      border-radius: 5px;
      object-fit: cover;
      margin-right: 10px;
      background-color: #f0f0f0;
    }

    .shop-info {
      flex: 1;
      overflow: hidden;
    }

    .shop-name {
      font-weight: bold;
      margin-bottom: 5px;
    }

    .shop-rate {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }

    .shop-score {
      color: #f63;
      margin-right: 5px;
    }

    .shop-distance {
      color: #999;
      font-size: 12px;
    }

    /* æ§åˆ¶æŒ‰é’® */
    .control-buttons {
      position: absolute;
      bottom: 15px;
      right: 15px;
      z-index: 100;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .control-btn {
      width: 45px;
      height: 45px;
      background-color: white;
      border: 1px solid #ddd;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .control-btn i {
      font-size: 20px;
      color: #333;
    }

    /* åŠ è½½é®ç½©å±‚ */
    .map-loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      font-size: 16px;
      color: #666;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #07c160;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      margin-top: 12px;
      font-size: 14px;
      color: #999;
    }

    /* åœ°å›¾å®¹å™¨åŠ è½½çŠ¶æ€ */
    .map-container.loading {
      opacity: 0.6;
      pointer-events: none;
    }

    /* å®šä½çŠ¶æ€æ˜¾ç¤º */
    .location-status {
      padding: 8px 16px;
      background: #f4f4f5;
      color: #909399;
      font-size: 12px;
      text-align: center;
      border-bottom: 1px solid #e6e6e6;
    }
  </style>
</head>
<body>
<div id="app">
  <div class="header">
    <div class="header-back-btn" @click="goBack">
      <i class="el-icon-arrow-left"></i>
    </div>
    <div class="header-title">åœ°å›¾</div>
    <div class="header-actions">
      <div class="header-location" @click="reGetLocation" title="é‡æ–°å®šä½">
        <i class="el-icon-location"></i>
      </div>
    </div>
  </div>

  <!-- å®šä½çŠ¶æ€æ˜¾ç¤º -->
  <div class="location-status" v-if="locationLoading">
    <i class="el-icon-loading"></i> å®šä½ä¸­...
  </div>
  <div class="location-status" v-else-if="usingCachedLocation" style="color: #67C23A;">
  </div>
  <div class="location-status" v-else-if="locationError" style="color: #F56C6C;">
    <i class="el-icon-warning"></i> å®šä½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ä½ç½®
  </div>

  <!-- ğŸ”¥ æ–°å¢ï¼šåœ°å›¾åŠ è½½é®ç½© -->
  <div class="map-loading" v-if="isLoading">
    <div class="loading-spinner"></div>
    <div class="loading-text">{{ loadingText }}</div>
  </div>

  <div class="map-container" :class="{ 'loading': isLoading }">
    <!-- é«˜å¾·åœ°å›¾å®¹å™¨ -->
    <div id="amap-container"></div>

    <!-- æœç´¢æ  -->
    <div class="search-bar">
      <div class="search-input">
        <el-input size="mini" placeholder="æœç´¢å•†å®¶ã€åœ°ç‚¹" v-model="searchKeyword" @input="searchShops">
          <i slot="prefix" class="el-input__icon el-icon-search"></i>
        </el-input>
      </div>
      <div class="filter-btn" @click="toggleFilters">
        <i class="el-icon-film"></i>
      </div>
    </div>

    <!-- åˆ†ç±»ç­›é€‰ -->
    <div class="category-filter" v-show="showFilters">
      <div class="category-list">
        <div v-for="type in shopTypeList" :key="type.id" class="category-item" @click="selectCategory(type)">
          <div class="category-icon" >
            <img :class="type.icon" :src="'/imgs/'+type.icon"></img>
          </div>
          <div class="category-text">{{ type.name }}</div>
        </div>
      </div>
    </div>

    <!-- åº—é“ºåˆ—è¡¨ -->
    <div class="shop-list">
      <div v-for="shop in shopList" :key="shop.id" class="shop-item" @click="centerToShop(shop)">
        <img :src="shop.avatar || '/imgs/default-shop.jpg'" alt="" class="shop-avatar">
        <div class="shop-info">
          <div class="shop-name">{{ shop.name }}</div>
          <div class="shop-rate">
            <span class="shop-score">{{ shop.score }}</span>
            <el-rate disabled v-model="shop.score/10" text-color="#F63" :size="12"></el-rate>
          </div>
          <div class="shop-distance">{{ formatDistance(shop.distance) }}</div>
        </div>
      </div>
    </div>

    <!-- æ§åˆ¶æŒ‰é’® -->
    <div class="control-buttons">
      <div class="control-btn" @click="refreshData">
        <i class="el-icon-refresh"></i>
      </div>
    </div>
  </div>
</div>

<script src="./js/vue.js"></script>
<script src="./js/axios.min.js"></script>
<!-- å¼•å…¥ç»„ä»¶åº“ -->
<script src="./js/element.js"></script>
<script src="./js/common.js"></script>
<script src="./js/footer.js"></script>
<!-- é«˜å¾·åœ°å›¾API -->
<script src="https://webapi.amap.com/maps?v=1.4.15&key=60bdbf9b9cf98025c397ee43e8c25871"></script>
<script>
  const app = new Vue({
    el: "#app",
    data: {
      searchKeyword: "",
      showFilters: false,
      selectedShopId: null,
      isLoading: true, // é»˜è®¤è®¾ç½®ä¸º trueï¼Œé¡µé¢åŠ è½½æ—¶æ˜¾ç¤º
      loadingText: "æ­£åœ¨åˆå§‹åŒ–...", // æ–°å¢ï¼šåŠ è½½æ–‡æœ¬
      locationLoading: false, // å®šä½åŠ è½½çŠ¶æ€
      locationError: false,   // å®šä½é”™è¯¯çŠ¶æ€
      usingCachedLocation: false, // æ˜¯å¦ä½¿ç”¨ç¼“å­˜ä½ç½®
      currentType: null,
      x: 120.16142,//ç»åº¦
      y: 30.279693,//çº¬åº¦
      keyword: "",
      map: null,
      markers: [],
      infoWindows: [],
      typeId:1, //é»˜è®¤åº—é“ºç±»å‹ä¸ºç¾é£Ÿ
      currentLocationMarker: null,
      locationAccuracyCircle: null, // æ–°å¢ï¼šç²¾åº¦åœˆ
      shopTypeList: [
        { id: 1, name: "ç¾é£Ÿ", icon: "el-icon-food", color: "#f63" },
        { id: 2, name: "å¤–å–", icon: "el-icon-takeaway-box", color: "#07c160" },
        { id: 3, name: "è¶…å¸‚", icon: "el-icon-shopping-cart-2", color: "#1989fa" },
        { id: 4, name: "æ°´æœ", icon: "el-icon-apple", color: "#ff6b3b" },
        { id: 5, name: "ç”œå“", icon: "el-icon-dessert", color: "#9a66e4" },
        { id: 6, name: "é¥®å“", icon: "el-icon-coffee-cup", color: "#00bcd4" },
        { id: 7, name: "å¿«é¤", icon: "el-icon-burger", color: "#ff9900" },
        { id: 8, name: "ç«é”…", icon: "el-icon-hot-water", color: "#e4393c" }
      ],
      shops: [
        {
          id: 1,
          name: "æ±Ÿå—å°é¦†",
          score: 4.8,
          distance: 150,
          avatar: "/imgs/shop1.jpg",
          x: 120.16142,
          y: 30.279693
        },
        {
          id: 2,
          name: "æ˜Ÿç©ºè¥¿é¤å…",
          score: 4.9,
          distance: 320,
          avatar: "/imgs/shop2.jpg",
          x: 120.16242,
          y: 30.278693
        },
        {
          id: 3,
          name: "è€åŒ—äº¬ç‚¸é…±é¢",
          score: 4.6,
          distance: 80,
          avatar: "/imgs/shop3.jpg",
          x: 120.16042,
          y: 30.277693
        },
        {
          id: 4,
          name: "æ—¶å…‰å’–å•¡",
          score: 4.7,
          distance: 210,
          avatar: "/imgs/shop4.jpg",
          x: 120.16342,
          y: 30.276693
        },
        {
          id: 5,
          name: "ç”œèœœæ—¶å…‰",
          score: 4.8,
          distance: 450,
          avatar: "/imgs/shop5.jpg",
          x: 120.15942,
          y: 30.275693
        },
        {
          id: 6,
          name: "ç¾å‘³çƒ§çƒ¤",
          score: 4.5,
          distance: 120,
          avatar: "/imgs/shop6.jpg",
          x: 120.16442,
          y: 30.274693
        },
        {
          id: 7,
          name: "å¥åº·æ²™æ‹‰",
          score: 4.7,
          distance: 280,
          avatar: "/imgs/shop7.jpg",
          x: 120.15842,
          y: 30.273693
        },
        {
          id: 8,
          name: "å¥¶èŒ¶ä¸“å®¶",
          score: 4.6,
          distance: 90,
          avatar: "/imgs/shop8.jpg",
          x: 120.16542,
          y: 30.272693
        }
      ],
      shopList: []
    },
    created() {
      // ä¼˜å…ˆä»ç¼“å­˜è¯»å–ä½ç½®ï¼Œæ²¡æœ‰å†å®šä½
      this.initLocation();
    },
    mounted() {
      // åˆå§‹åŒ–é«˜å¾·åœ°å›¾
      this.initMap();
    },
    methods: {
      // åˆå§‹åŒ–ä½ç½®ä¿¡æ¯
      initLocation() {
        // å…ˆå°è¯•ä»ç¼“å­˜è¯»å–ä½ç½®
        const cachedLocation = this.getCachedLocation();

        if (cachedLocation) {
          // ä½¿ç”¨ç¼“å­˜ä½ç½®
          console.log("ä½¿ç”¨ç¼“å­˜ä½ç½®:", cachedLocation);
          this.x = cachedLocation.x;
          this.y = cachedLocation.y;
          this.usingCachedLocation = true;

          // ç›´æ¥åˆå§‹åŒ–åœ°å›¾å’Œæ•°æ®
          this.initMapAndData();
        } else {
          // ç¼“å­˜ä¸­æ²¡æœ‰ä½ç½®ï¼Œè¿›è¡Œå®šä½
          console.log("ç¼“å­˜ä¸­æ²¡æœ‰ä½ç½®ï¼Œå¼€å§‹å®šä½");
          this.locationLoading = true;
          this.centerToCurrentLocation();
        }
      },

      // è·å–ç¼“å­˜ä¸­çš„ä½ç½®
      getCachedLocation() {
        try {
          const cached = localStorage.getItem('user_location');
          if (cached) {
            const location = JSON.parse(cached);

            // æ£€æŸ¥ç¼“å­˜æ˜¯å¦è¿‡æœŸï¼ˆ24å°æ—¶ï¼‰
            const cacheTime = localStorage.getItem('user_location_time');
            const now = new Date().getTime();
            if (cacheTime && (now - parseInt(cacheTime)) < 24 * 60 * 60 * 1000) {
              return location;
            } else {
              // ç¼“å­˜è¿‡æœŸï¼Œæ¸…é™¤
              this.clearLocationCache();
              return null;
            }
          }
        } catch (error) {
          console.log("è¯»å–ä½ç½®ç¼“å­˜å¤±è´¥:", error);
          this.clearLocationCache();
        }
        return null;
      },

      // ä¿å­˜ä½ç½®åˆ°ç¼“å­˜
      saveLocationToCache(x, y) {
        try {
          const location = { x, y };
          localStorage.setItem('user_location', JSON.stringify(location));
          localStorage.setItem('user_location_time', new Date().getTime().toString());
          console.log("ä½ç½®å·²ä¿å­˜åˆ°ç¼“å­˜:", location);
        } catch (error) {
          console.log("ä¿å­˜ä½ç½®ç¼“å­˜å¤±è´¥:", error);
        }
      },

      // æ¸…é™¤ä½ç½®ç¼“å­˜
      clearLocationCache() {
        try {
          localStorage.removeItem('user_location');
          localStorage.removeItem('user_location_time');
          console.log("ä½ç½®ç¼“å­˜å·²æ¸…é™¤");
        } catch (error) {
          console.log("æ¸…é™¤ä½ç½®ç¼“å­˜å¤±è´¥:", error);
        }
      },

      // åˆå§‹åŒ–åœ°å›¾å’Œæ•°æ®ï¼ˆä½¿ç”¨ç¼“å­˜ä½ç½®æ—¶è°ƒç”¨ï¼‰
      async initMapAndData() {
        this.isLoading = true;
        this.loadingText = "æ­£åœ¨åˆå§‹åŒ–åœ°å›¾...";

        try {
          // åˆå§‹åŒ–åœ°å›¾
          this.initMap();

          // è®¾ç½®åœ°å›¾ä¸­å¿ƒä¸ºç¼“å­˜ä½ç½®
          this.map.setCenter([this.x, this.y]);

          // æ·»åŠ å½“å‰ä½ç½®æ ‡è®°
          this.addCurrentLocationMarker(this.x, this.y);

          // åŠ è½½åº—é“ºç±»å‹
          this.loadingText = "æ­£åœ¨åŠ è½½åº—é“ºç±»å‹...";
          await this.getShopTypeList();

          // åŠ è½½åº—é“ºåˆ—è¡¨
          this.loadingText = "æ­£åœ¨åŠ è½½é™„è¿‘åº—é“º...";
          await this.getShopList();

          this.isLoading = false;
        } catch (error) {
          console.error('åˆå§‹åŒ–å¤±è´¥:', error);
          this.isLoading = false;
        }
      },

      initMap() {
        // åˆå§‹åŒ–åœ°å›¾
        this.map = new AMap.Map('amap-container', {
          zoom: 15,
          center: [this.x, this.y], // ä½¿ç”¨å½“å‰åæ ‡
          viewMode: '2D'
        });

        // ç›‘å¬åœ°å›¾ç§»åŠ¨äº‹ä»¶
        this.map.on('moveend', () => {
          console.log('åœ°å›¾ç§»åŠ¨ç»“æŸ');
        });
      },

      // æ·»åŠ å½“å‰ä½ç½®æ ‡è®°
      addCurrentLocationMarker(lng, lat) {
        // ç§»é™¤ä¹‹å‰çš„ä½ç½®æ ‡è®°å’Œç²¾åº¦åœˆ
        if (this.currentLocationMarker) {
          this.map.remove(this.currentLocationMarker);
        }
        if (this.locationAccuracyCircle) {
          this.map.remove(this.locationAccuracyCircle);
        }

        // åˆ›å»ºä½ç½®æ ‡è®°
        this.currentLocationMarker = new AMap.Marker({
          position: [lng, lat],
          offset: new AMap.Pixel(-15, -34),
          icon: new AMap.Icon({
            size: new AMap.Size(30, 34),
            image: 'https://a.amap.com/jsapi_demos/static/demo-center/icons/poi-marker-red.png',
            imageSize: new AMap.Size(30, 34)
          }),
          title: 'æˆ‘çš„ä½ç½®'
        });

        // å°†æ ‡è®°æ·»åŠ åˆ°åœ°å›¾
        this.map.add(this.currentLocationMarker);
      },

      // æ ¼å¼åŒ–è·ç¦»
      formatDistance(distance) {
        if (!distance && distance !== 0) return 'è·ç¦»æœªçŸ¥';

        if (distance < 1000) {
          return Math.round(distance) + 'ç±³';
        } else if (distance < 10000) {
          return (distance / 1000).toFixed(1) + 'å…¬é‡Œ';
        } else {
          return Math.round(distance / 1000) + 'å…¬é‡Œ';
        }
      },

      addShopMarkers() {
        // æ¸…é™¤ç°æœ‰æ ‡è®°
        if (this.markers.length > 0) {
          this.map.remove(this.markers);
          this.markers = [];
        }

        if (this.infoWindows.length > 0) {
          this.infoWindows.forEach(win => win.close());
          this.infoWindows = [];
        }

        // ä¸ºæ¯ä¸ªåº—é“ºæ·»åŠ æ ‡è®°
        this.shopList.forEach(shop => {
          const marker = new AMap.Marker({
            position: [shop.x, shop.y],
            offset: new AMap.Pixel(-12, -36),
            extData: shop,
            label: {
              content: shop.name,
              direction: 'top',
              offset: new AMap.Pixel(0, -40)
            }
          });

          // æ·»åŠ ç‚¹å‡»äº‹ä»¶
          marker.on('click', () => {
            this.showInfoWindow(shop);
          });

          this.markers.push(marker);
        });

        // å°†æ‰€æœ‰æ ‡è®°æ·»åŠ åˆ°åœ°å›¾
        this.map.add(this.markers);

        // å¦‚æœæœ‰æ ‡è®°ï¼Œè°ƒæ•´è§†é‡ä»¥åŒ…å«æ‰€æœ‰æ ‡è®°
        if (this.markers.length > 0) {
          this.map.setFitView(this.markers);
        }
      },

      showInfoWindow(shop) {
        // å…³é—­æ‰€æœ‰å·²æ‰“å¼€çš„ä¿¡æ¯çª—å£
        this.infoWindows.forEach(win => win.close());
        this.infoWindows = [];
        const distanceText = this.formatDistance(shop.distance);
        // åˆ›å»ºä¿¡æ¯çª—å£å†…å®¹
        const content = `
          <div style="min-width: 200px; padding: 10px;">
            <h4 style="margin: 0 0 10px 0; color: #333;">${shop.name}</h4>
            <div style="display: flex; align-items: center; margin-bottom: 5px;">
              <span class="shop-score">${shop.score}</span>
              <div style="font-size: 12px; color: #999;">${shop.comments ? shop.comments + 'æ¡è¯„è®º' : ''}</div>
            </div>
            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">è·ç¦» ${distanceText}</div>
            <div style="font-size: 12px; color: #666; margin-bottom: 10px;">${shop.address || 'åœ°å€ä¿¡æ¯æš‚æ— '}</div>
            <div style="text-align: right;">
              <button onclick="app.toShopDetail(${shop.id})"
                      style="background-color: #f63; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">
                æŸ¥çœ‹è¯¦æƒ…
              </button>
            </div>
          </div>
        `;

        // åˆ›å»ºä¿¡æ¯çª—å£
        const infoWindow = new AMap.InfoWindow({
          content: content,
          offset: new AMap.Pixel(0, -30)
        });

        // æ‰“å¼€ä¿¡æ¯çª—å£
        infoWindow.open(this.map, [shop.x, shop.y]);

        // ä¿å­˜å¼•ç”¨ä»¥ä¾¿åç»­å…³é—­
        this.infoWindows.push(infoWindow);
      },

      toggleFilters() {
        this.showFilters = !this.showFilters;
      },

      selectCategory(type) {
        this.typeId = type.id;
        this.showFilters = false;
        this.$message.success(`å·²ç­›é€‰${type.name}ç±»åˆ«`);

        // è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„åˆ†ç±»ç­›é€‰é€»è¾‘
        this.getShopList();
      },

      centerToShop(shop) {
        // è·³è½¬åˆ°åº—é“ºè¯¦æƒ…é¡µ
        this.toShopDetail(shop.id);
      },

      searchShops() {
        if (!this.searchKeyword.trim()) {
          this.keyword = this.searchKeyword.toLowerCase();
          this.getShopList();
          return;
        }
        this.keyword = this.searchKeyword.toLowerCase();
        this.getShopList();
      },

      async centerToCurrentLocation() {
        // å®šä½åˆ°ç”¨æˆ·å½“å‰ä½ç½®
        this.locationLoading = true;
        this.usingCachedLocation = false;

        try {
          await new Promise((resolve, reject) => {
            AMap.plugin('AMap.Geolocation', () => {
              const geolocation = new AMap.Geolocation({
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0,
                convert: true,
                showButton: true,
                showMarker: false,
                showCircle: false,
                panToLocation: true,
                trackLocation: false
              });

              geolocation.getCurrentPosition((status, result) => {
                if (status === 'complete') {
                  this.$message.success("å®šä½æˆåŠŸ");

                  // æ›´æ–°åæ ‡
                  this.x = result.position.lng;
                  this.y = result.position.lat;

                  // ä¿å­˜åˆ°ç¼“å­˜
                  this.saveLocationToCache(this.x, this.y);

                  // åˆå§‹åŒ–åœ°å›¾å’Œæ•°æ®
                  this.initMapAndData();

                  this.locationLoading = false;
                  resolve(result);
                } else {
                  this.$message.error("å®šä½å¤±è´¥ï¼š" + result.message);
                  this.locationError = true;
                  this.locationLoading = false;

                  // ä½¿ç”¨é»˜è®¤ä½ç½®
                  this.initMapAndData();
                  resolve(null);
                }
              });
            });
          });

        } catch (error) {
          console.error('å®šä½è¿‡ç¨‹å‡ºé”™:', error);
          this.locationError = true;
          this.locationLoading = false;
          this.initMapAndData();
        }
      },

      // æ‰‹åŠ¨é‡æ–°å®šä½æ–¹æ³•
      reGetLocation() {
        // æ¸…é™¤ç¼“å­˜ï¼Œå¼ºåˆ¶é‡æ–°å®šä½
        this.clearLocationCache();
        this.locationLoading = true;
        this.locationError = false;
        this.usingCachedLocation = false;

        // é‡æ–°å®šä½
        this.centerToCurrentLocation();
      },

      getShopTypeList(){
        this.loadingText = "æ­£åœ¨åŠ è½½åº—é“ºç±»å‹...";
        return axios.get('/app/map/getShopTypeList').then(res => {
          this.shopTypeList = res.data
        }).catch(err => {
          console.log(err)
        })
      },

      getShopList(){
        this.loadingText = "æ­£åœ¨åŠ è½½é™„è¿‘åº—é“º...";
        return axios.get('/app/map/getShopList', {
          params: {
            typeId: this.typeId,
            x: this.x,
            y: this.y,
            keyword: this.keyword
          }
        }).then(res => {
          this.shopList = res.data
          // é‡æ–°æ·»åŠ æ ‡è®°
          this.addShopMarkers();
          this.keyword = ''
        }).catch(err => {
          console.log(err)
        })
      },

      refreshData() {
        this.isLoading = true;
        this.loadingText = "æ­£åœ¨åˆ·æ–°æ•°æ®...";

        setTimeout(() => {
          this.isLoading = false;
          this.$message.success("åˆ·æ–°æˆåŠŸ");
          // é‡æ–°åŠ è½½æ•°æ®å’Œæ ‡è®°
          this.getShopList();
        }, 1000);
      },

      toShopDetail(shopId) {
        location.href = `/shop-detail.html?id=${shopId}`;
      },

      goBack() {
        location.href = "/";
      }
    }
  })
</script>

<style>
  /* headerå¸ƒå±€è°ƒæ•´ */
  .header-actions {
    display: flex;
    align-items: center;
  }

  .header-location {
    cursor: pointer;
    color: #409EFF;
    font-size: 18px;
  }
</style>
</body>
</html>