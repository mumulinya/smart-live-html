<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <title>æ™ºè¯„ç”Ÿæ´» - åœ°å›¾</title>
  <!-- å¼•å…¥æ ·å¼ -->
  <link rel="stylesheet" href="./css/element.css">
  <link href="./css/main.css" rel="stylesheet">

  <style type="text/css">
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background-color: #f5f5f5;
      height: 100vh;
      overflow: hidden;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px;
      border-bottom: 1px solid #eee;
      background-color: #fff;
      z-index: 1000;
    }

    .header-back-btn {
      font-size: 20px;
      color: #333;
      cursor: pointer;
      display: flex;
      align-items: center;
    }

    .header-title {
      font-size: 18px;
      font-weight: bold;
      flex: 1;
      text-align: center;
    }

    .map-container {
      position: relative;
      height: calc(100vh - 110px);
    }

    /* é«˜å¾·åœ°å›¾å®¹å™¨ */
    #amap-container {
      width: 100%;
      height: 100%;
    }

    /* æœç´¢æ  */
    .search-bar {
      position: absolute;
      top: 15px;
      left: 15px;
      right: 15px;
      z-index: 100;
      display: flex;
      background-color: white;
      border-radius: 20px;
      padding: 5px 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .search-input {
      flex: 1;
      margin-right: 10px;
    }

    .search-input .el-input__inner {
      border: none !important;
      height: 30px;
    }

    .filter-btn {
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    /* åˆ†ç±»ç­›é€‰ */
    .category-filter {
      position: absolute;
      top: 60px;
      left: 15px;
      right: 15px;
      background-color: white;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      z-index: 100;
      max-height: 100px;
      overflow-y: auto;
    }

    .category-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .category-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 60px;
      height: 60px;
      cursor: pointer;
    }

    .category-icon {
      width: 24px;
      height: 24px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 5px;
      background-color: #f8f9fa;
    }

    .category-icon img {
      width: 16px;
      height: 16px;
      object-fit: contain;
    }

    .category-text {
      font-size: 11px;
      color: #333;
      text-align: center;
      line-height: 1.2;
    }

    /* åº—é“ºåˆ—è¡¨ */
    .shop-list {
      position: absolute;
      bottom: 70px;
      left: 15px;
      right: 15px;
      background-color: white;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 2px 15px rgba(0,0,0,0.1);
      z-index: 100;
      max-height: 200px;
      overflow-y: auto;
    }

    .shop-item {
      display: flex;
      padding: 10px 0;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }

    .shop-item:last-child {
      border-bottom: none;
    }

    .shop-avatar {
      width: 50px;
      height: 50px;
      border-radius: 5px;
      object-fit: cover;
      margin-right: 10px;
      background-color: #f0f0f0;
    }

    .shop-info {
      flex: 1;
      overflow: hidden;
    }

    .shop-name {
      font-weight: bold;
      margin-bottom: 5px;
    }

    .shop-rate {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }

    .shop-score {
      color: #f63;
      margin-right: 5px;
    }

    .shop-distance {
      color: #999;
      font-size: 12px;
    }

    /* æ§åˆ¶æŒ‰é’® */
    .control-buttons {
      position: absolute;
      bottom: 15px;
      right: 15px;
      z-index: 100;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .control-btn {
      width: 45px;
      height: 45px;
      background-color: white;
      border: 1px solid #ddd;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .control-btn i {
      font-size: 20px;
      color: #333;
    }

    /* åŠ è½½é®ç½©å±‚ */
    .map-loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      font-size: 16px;
      color: #666;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #07c160;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      margin-top: 12px;
      font-size: 14px;
      color: #999;
    }

    /* åœ°å›¾å®¹å™¨åŠ è½½çŠ¶æ€ */
    .map-container.loading {
      opacity: 0.6;
      pointer-events: none;
    }

    /* å®šä½çŠ¶æ€æ˜¾ç¤º */
    .location-status {
      padding: 8px 16px;
      background: #f4f4f5;
      color: #909399;
      font-size: 12px;
      text-align: center;
      border-bottom: 1px solid #e6e6e6;
      transition: all 0.3s ease;
      max-height: 40px;
      overflow: hidden;
    }

    .location-status.hidden {
      max-height: 0;
      padding: 0;
      border-bottom: none;
    }

    .location-status.success {
      color: #67C23A;
    }

    .location-status.error {
      color: #F56C6C;
    }

    /* è‡ªå®šä¹‰æ ‡è®°æ ·å¼ */
    .custom-marker {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: 3px solid white;
      border-radius: 50%;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 12px;
      transition: all 0.3s ease;
    }

    .custom-marker:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
    }

    .custom-marker.high-score {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .custom-marker.medium-score {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .custom-marker.low-score {
      background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }
  </style>
</head>
<body>
<div id="app">
  <div class="header">
    <div class="header-back-btn" @click="goBack">
      <i class="el-icon-arrow-left"></i>
    </div>
    <div class="header-title">åœ°å›¾</div>
    <div class="header-actions">
      <div class="header-location" @click="reGetLocation" title="é‡æ–°å®šä½">
        <i class="el-icon-location"></i>
      </div>
    </div>
  </div>

  <!-- å®šä½çŠ¶æ€æ˜¾ç¤º -->
  <div class="location-status" :class="{
        'success': usingCachedLocation && !locationLoading && !locationError,
        'error': locationError,
        'hidden': !showLocationStatus
      }" v-if="showLocationStatus">
    <i class="el-icon-loading" v-if="locationLoading"></i>
    <i class="el-icon-location" v-else-if="usingCachedLocation && !locationError"></i>
    <i class="el-icon-warning" v-else-if="locationError"></i>
    {{ locationStatusText }}
  </div>

  <!-- ğŸ”¥ æ–°å¢ï¼šåœ°å›¾åŠ è½½é®ç½© -->
  <div class="map-loading" v-if="isLoading">
    <div class="loading-spinner"></div>
    <div class="loading-text">{{ loadingText }}</div>
  </div>

  <div class="map-container" :class="{ 'loading': isLoading }">
    <!-- é«˜å¾·åœ°å›¾å®¹å™¨ -->
    <div id="amap-container"></div>

    <!-- æœç´¢æ  -->
    <div class="search-bar">
      <div class="search-input">
        <el-input size="mini" placeholder="æœç´¢å•†å®¶ã€åœ°ç‚¹" v-model="searchKeyword" @input="searchShops">
          <i slot="prefix" class="el-input__icon el-icon-search"></i>
        </el-input>
      </div>
      <div class="filter-btn" @click="toggleFilters">
        <i class="el-icon-film"></i>
      </div>
    </div>

    <!-- åˆ†ç±»ç­›é€‰ -->
    <div class="category-filter" v-show="showFilters">
      <div class="category-list">
        <div v-for="type in shopTypeList" :key="type.id" class="category-item" @click="selectCategory(type)">
          <div class="category-icon" >
            <img :class="type.icon" :src="'/imgs/'+type.icon"></img>
          </div>
          <div class="category-text">{{ type.name }}</div>
        </div>
      </div>
    </div>

    <!-- åº—é“ºåˆ—è¡¨ -->
    <div class="shop-list">
      <div v-for="shop in shopList" :key="shop.id" class="shop-item" @click="centerToShop(shop)">
        <img :src="shop.images || '/imgs/default-shop.jpg'" alt="" class="shop-avatar">
        <div class="shop-info">
          <div class="shop-name">{{ shop.name }}</div>
          <div class="shop-rate">
            <span class="shop-score">{{ shop.score }}</span>
            <el-rate disabled v-model="shop.score/10" text-color="#F63" :size="12"></el-rate>
          </div>
          <div class="shop-distance">{{ formatDistance(shop.distance) }}</div>
        </div>
      </div>
    </div>

    <!-- æ§åˆ¶æŒ‰é’® -->
    <div class="control-buttons">
      <div class="control-btn" @click="refreshData">
        <i class="el-icon-refresh"></i>
      </div>
    </div>
  </div>
</div>

<script src="./js/vue.js"></script>
<script src="./js/axios.min.js"></script>
<!-- å¼•å…¥ç»„ä»¶åº“ -->
<script src="./js/element.js"></script>
<script src="./js/common.js"></script>
<script src="./js/footer.js"></script>
<!-- é«˜å¾·åœ°å›¾API -->
<script src="https://webapi.amap.com/maps?v=1.4.15&key=60bdbf9b9cf98025c397ee43e8c25871"></script>
<script>
  const app = new Vue({
    el: "#app",
    data: {
      searchKeyword: "",
      showFilters: false,
      selectedShopId: null,
      isLoading: true,
      loadingText: "æ­£åœ¨åˆå§‹åŒ–...",
      // å®šä½ç›¸å…³æ•°æ®
      locationLoading: false,
      locationError: false,
      usingCachedLocation: false,
      showLocationStatus: false,
      currentType: null,
      x: 120.16142,
      y: 30.279693,
      keyword: "",
      map: null,
      markers: [],
      infoWindows: [],
      typeId: 1,
      currentLocationMarker: null,
      locationAccuracyCircle: null,
      userLocation: {
        x: 120.149993,
        y: 30.334229,
        region: {}
      },
      shopTypeList: [
        { id: 1, name: "ç¾é£Ÿ", icon: "el-icon-food", color: "#f63" },
        { id: 2, name: "å¤–å–", icon: "el-icon-takeaway-box", color: "#07c160" },
        { id: 3, name: "è¶…å¸‚", icon: "el-icon-shopping-cart-2", color: "#1989fa" },
        { id: 4, name: "æ°´æœ", icon: "el-icon-apple", color: "#ff6b3b" },
        { id: 5, name: "ç”œå“", icon: "el-icon-dessert", color: "#9a66e4" },
        { id: 6, name: "é¥®å“", icon: "el-icon-coffee-cup", color: "#00bcd4" },
        { id: 7, name: "å¿«é¤", icon: "el-icon-burger", color: "#ff9900" },
        { id: 8, name: "ç«é”…", icon: "el-icon-hot-water", color: "#e4393c" }
      ],
      shops: [
        {
          id: 1,
          name: "æ±Ÿå—å°é¦†",
          score: 4.8,
          distance: 150,
          avatar: "/imgs/shop1.jpg",
          x: 120.16142,
          y: 30.279693
        },
        {
          id: 2,
          name: "æ˜Ÿç©ºè¥¿é¤å…",
          score: 4.9,
          distance: 320,
          avatar: "/imgs/shop2.jpg",
          x: 120.16242,
          y: 30.278693
        },
        {
          id: 3,
          name: "è€åŒ—äº¬ç‚¸é…±é¢",
          score: 4.6,
          distance: 80,
          avatar: "/imgs/shop3.jpg",
          x: 120.16042,
          y: 30.277693
        },
        {
          id: 4,
          name: "æ—¶å…‰å’–å•¡",
          score: 4.7,
          distance: 210,
          avatar: "/imgs/shop4.jpg",
          x: 120.16342,
          y: 30.276693
        },
        {
          id: 5,
          name: "ç”œèœœæ—¶å…‰",
          score: 4.8,
          distance: 450,
          avatar: "/imgs/shop5.jpg",
          x: 120.15942,
          y: 30.275693
        },
        {
          id: 6,
          name: "ç¾å‘³çƒ§çƒ¤",
          score: 4.5,
          distance: 120,
          avatar: "/imgs/shop6.jpg",
          x: 120.16442,
          y: 30.274693
        },
        {
          id: 7,
          name: "å¥åº·æ²™æ‹‰",
          score: 4.7,
          distance: 280,
          avatar: "/imgs/shop7.jpg",
          x: 120.15842,
          y: 30.273693
        },
        {
          id: 8,
          name: "å¥¶èŒ¶ä¸“å®¶",
          score: 4.6,
          distance: 90,
          avatar: "/imgs/shop8.jpg",
          x: 120.16542,
          y: 30.272693
        }
      ],
      shopList: []
    },
    computed: {
      locationStatusText() {
        if (this.locationLoading) return "å®šä½ä¸­...";
        if (this.usingCachedLocation && !this.locationError) return "å·²ä½¿ç”¨ç¼“å­˜ä½ç½®";
        if (this.locationError) return "å®šä½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ä½ç½®";
        return "";
      }
    },
    created() {
      this.initLocation();
    },
    mounted() {
      this.initMap();
    },
    methods: {
      // è·å–åœ°åŒºä¿¡æ¯
      async getRegionInfo(lng, lat) {
        try {
          console.log('å¼€å§‹è·å–åœ°åŒºä¿¡æ¯ï¼Œåæ ‡:', lng, lat);

          const response = await fetch(
                  `https://restapi.amap.com/v3/geocode/regeo?key=60bdbf9b9cf98025c397ee43e8c25871&location=${lng},${lat}`
          );

          console.log('å“åº”çŠ¶æ€:', response.status, response.statusText);

          const data = await response.json();
          console.log('APIè¿”å›æ•°æ®:', data);

          if (data.status === '1' && data.regeocode) {
            const address = data.regeocode.addressComponent;
            const result = {
              province: address.province,
              city: address.city || address.province,
              district: address.district,
              township: address.township,
              fullAddress: data.regeocode.formatted_address
            };
            console.log('è§£æåçš„åœ°åŒºä¿¡æ¯:', result);
            return result;
          } else {
            throw new Error(`APIè¿”å›é”™è¯¯: ${data.info}`);
          }
        } catch (error) {
          console.error('è·å–åœ°åŒºä¿¡æ¯è¯¦ç»†é”™è¯¯:', error);
          return null;
        }
      },

      // æ˜¾ç¤ºå®šä½çŠ¶æ€ï¼ˆ3ç§’åè‡ªåŠ¨éšè—ï¼‰
      showLocationStatusMessage() {
        this.showLocationStatus = true;

        setTimeout(() => {
          this.hideLocationStatus();
        }, 3000);
      },

      // éšè—å®šä½çŠ¶æ€
      hideLocationStatus() {
        this.showLocationStatus = false;
      },

      // åˆå§‹åŒ–ä½ç½®ä¿¡æ¯
      initLocation() {
        const cachedLocation = this.getCachedLocation();

        if (cachedLocation) {
          console.log("ä½¿ç”¨ç¼“å­˜ä½ç½®:", cachedLocation);
          this.userLocation.x = cachedLocation.x;
          this.userLocation.y = cachedLocation.y;
          this.x = cachedLocation.x;
          this.y = cachedLocation.y;
          this.usingCachedLocation = true;
          this.locationError = false;
          this.userLocation.region = cachedLocation.region;
          this.showLocationStatusMessage();
          this.initMapAndData();
        } else {
          console.log("ç¼“å­˜ä¸­æ²¡æœ‰ä½ç½®ï¼Œå¼€å§‹å®šä½");
          this.getLocation();
        }
      },

      // è·å–ç¼“å­˜ä¸­çš„ä½ç½®
      getCachedLocation() {
        try {
          const cached = localStorage.getItem('user_location');
          if (cached) {
            const location = JSON.parse(cached);
            const cacheTime = localStorage.getItem('user_location_time');
            const now = new Date().getTime();
            if (cacheTime && (now - parseInt(cacheTime)) < 24 * 60 * 60 * 1000) {
              return location;
            } else {
              this.clearLocationCache();
              return null;
            }
          }
        } catch (error) {
          console.log("è¯»å–ä½ç½®ç¼“å­˜å¤±è´¥:", error);
          this.clearLocationCache();
        }
        return null;
      },

      // ä¿å­˜ä½ç½®åˆ°ç¼“å­˜
      saveLocationToCache(x, y, region) {
        try {
          const location = { x, y, region };
          localStorage.setItem('user_location', JSON.stringify(location));
          localStorage.setItem('user_location_time', new Date().getTime().toString());
          console.log("ä½ç½®å·²ä¿å­˜åˆ°ç¼“å­˜:", location);
        } catch (error) {
          console.log("ä¿å­˜ä½ç½®ç¼“å­˜å¤±è´¥:", error);
        }
      },

      // æ¸…é™¤ä½ç½®ç¼“å­˜
      clearLocationCache() {
        try {
          localStorage.removeItem('user_location');
          localStorage.removeItem('user_location_time');
          console.log("ä½ç½®ç¼“å­˜å·²æ¸…é™¤");
        } catch (error) {
          console.log("æ¸…é™¤ä½ç½®ç¼“å­˜å¤±è´¥:", error);
        }
      },

      // è‡ªåŠ¨å®šä½æ–¹æ³•
      getLocation() {
        this.showLocationStatus = true;
        this.locationLoading = true;
        this.locationError = false;
        this.usingCachedLocation = false;

        if (!navigator.geolocation) {
          console.log("æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†å®šä½");
          this.locationError = true;
          this.locationLoading = false;
          this.showLocationStatusMessage();
          this.initMapAndData();
          return;
        }

        const options = {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 60000
        };

        navigator.geolocation.getCurrentPosition(
                async (position) => {
                  console.log("å®šä½æˆåŠŸ:", position);
                  const convertedCoord = this.transformWGS84ToGCJ02(position.coords.longitude, position.coords.latitude)
                  const longitude = convertedCoord.lng;
                  const latitude = convertedCoord.lat;

                  this.userLocation.x = longitude;
                  this.userLocation.y = latitude;
                  this.x = longitude;
                  this.y = latitude;

                  // ç­‰å¾…åœ°åŒºä¿¡æ¯è·å–å®Œæˆ
                  try {
                    const regionInfo = await this.getRegionInfo(longitude, latitude);
                    if (regionInfo) {
                      this.userLocation.region = regionInfo;
                      console.log("åœ°åŒºä¿¡æ¯è·å–æˆåŠŸ:", regionInfo);

                      // ä¿å­˜åŒ…å«åœ°åŒºä¿¡æ¯çš„ç¼“å­˜
                      this.saveLocationToCache(longitude, latitude, regionInfo);

                      // æ˜¾ç¤ºåŒ…å«åœ°åŒºçš„æˆåŠŸæ¶ˆæ¯
                      this.$message({
                        message: `å®šä½æˆåŠŸï¼š${regionInfo.district}`,
                        type: 'success',
                        duration: 2000
                      });
                    } else {
                      throw new Error('è·å–åœ°åŒºä¿¡æ¯å¤±è´¥');
                    }
                  } catch (error) {
                    console.error('è·å–åœ°åŒºä¿¡æ¯å¤±è´¥:', error);
                    // å³ä½¿åœ°åŒºè·å–å¤±è´¥ï¼Œä¹Ÿä¿å­˜åæ ‡
                    this.saveLocationToCache(longitude, latitude, null);

                    this.$message({
                      message: 'å®šä½æˆåŠŸï¼ˆåœ°åŒºä¿¡æ¯è·å–å¤±è´¥ï¼‰',
                      type: 'warning',
                      duration: 2000
                    });
                  }
                  console.log("å½“å‰ä½ç½® - ç»åº¦:", longitude, "çº¬åº¦:", latitude, "åœ°åŒº:", this.userLocation.region);
                  this.locationLoading = false;
                  this.usingCachedLocation = false;
                  this.showLocationStatusMessage();

                  this.initMapAndData();
                },
                (error) => {
                  console.log("å®šä½å¤±è´¥:", error);
                  this.locationError = true;
                  this.locationLoading = false;
                  this.showLocationStatusMessage();

                  this.$message({
                    message: 'å®šä½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ä½ç½®',
                    type: 'warning',
                    duration: 2000
                  });

                  this.initMapAndData();
                },
                options
        );
      },

      // GPSåæ ‡è½¬é«˜å¾·åæ ‡
      transformWGS84ToGCJ02(lng, lat) {
        // ç®€åŒ–çš„åæ ‡è½¬æ¢ï¼ˆå®é™…åº”è¯¥ä½¿ç”¨æ›´ç²¾ç¡®çš„ç®—æ³•ï¼‰
        const x = lng - 0.0065;
        const y = lat - 0.0060;
        return { lng: x, lat: y };
      },

      // æ‰‹åŠ¨é‡æ–°å®šä½æ–¹æ³•
      reGetLocation() {
        this.clearLocationCache();
        this.showLocationStatus = true;
        this.locationLoading = true;
        this.locationError = false;
        this.usingCachedLocation = false;
        this.getLocation();
      },

      async initMapAndData() {
        this.isLoading = true;
        this.loadingText = "æ­£åœ¨åˆå§‹åŒ–åœ°å›¾...";

        try {
          if (!this.map) {
            this.initMap();
          }

          this.map.setCenter([this.x, this.y]);
          this.addCurrentLocationMarker(this.x, this.y);

          this.loadingText = "æ­£åœ¨åŠ è½½åº—é“ºç±»å‹...";
          await this.getShopTypeList();

          this.loadingText = "æ­£åœ¨åŠ è½½é™„è¿‘åº—é“º...";
          await this.getShopList();

          this.isLoading = false;
        } catch (error) {
          console.error('åˆå§‹åŒ–å¤±è´¥:', error);
          this.isLoading = false;
        }
      },

      initMap() {
        this.map = new AMap.Map('amap-container', {
          zoom: 15,
          center: [this.x, this.y],
          viewMode: '2D'
        });

        this.map.on('moveend', () => {
          console.log('åœ°å›¾ç§»åŠ¨ç»“æŸ');
        });
      },

      addCurrentLocationMarker(lng, lat) {
        if (this.currentLocationMarker) {
          this.map.remove(this.currentLocationMarker);
        }
        if (this.locationAccuracyCircle) {
          this.map.remove(this.locationAccuracyCircle);
        }

        this.currentLocationMarker = new AMap.Marker({
          position: [lng, lat],
          offset: new AMap.Pixel(-15, -34),
          icon: new AMap.Icon({
            size: new AMap.Size(30, 34),
            image: 'https://a.amap.com/jsapi_demos/static/demo-center/icons/poi-marker-red.png',
            imageSize: new AMap.Size(30, 34)
          }),
          title: 'æˆ‘çš„ä½ç½®'
        });

        this.map.add(this.currentLocationMarker);
      },

      formatDistance(distance) {
        if (!distance && distance !== 0) return 'è·ç¦»æœªçŸ¥';
        if (distance < 1000) return Math.round(distance) + 'ç±³';
        if (distance < 10000) return (distance / 1000).toFixed(1) + 'å…¬é‡Œ';
        return Math.round(distance / 1000) + 'å…¬é‡Œ';
      },

      // ğŸ¨ ç¾åŒ–åçš„æ ‡è®°æ·»åŠ æ–¹æ³•
      addShopMarkers() {
        // æ¸…é™¤ç°æœ‰æ ‡è®°
        if (this.markers.length > 0) {
          this.map.remove(this.markers);
          this.markers = [];
        }

        if (this.infoWindows.length > 0) {
          this.infoWindows.forEach(win => win.close());
          this.infoWindows = [];
        }

        // ä¸ºæ¯ä¸ªåº—é“ºæ·»åŠ ç¾åŒ–åçš„æ ‡è®°
        this.shopList.forEach(shop => {
          // æ ¹æ®è¯„åˆ†ç¡®å®šæ ‡è®°æ ·å¼
          let markerClass = 'custom-marker';
          if (shop.score >= 4.5) {
            markerClass += ' high-score';
          } else if (shop.score >= 4.0) {
            markerClass += ' medium-score';
          } else {
            markerClass += ' low-score';
          }

          // åˆ›å»ºè‡ªå®šä¹‰æ ‡è®°å†…å®¹
          const markerContent = document.createElement('div');
          markerContent.className = markerClass;
          markerContent.innerHTML = `
            <div style="
              width: 24px;
              height: 24px;
              display: flex;
              align-items: center;
              justify-content: center;
              border-radius: 50%;
              background: inherit;
              border: 2px solid white;
              box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            ">
              <span style="font-size: 10px; font-weight: bold;">${Math.round(shop.score)}</span>
            </div>
          `;

          const marker = new AMap.Marker({
            position: [shop.x, shop.y],
            content: markerContent,
            offset: new AMap.Pixel(-12, -12),
            extData: shop
          });

          // æ·»åŠ é¼ æ ‡æ‚¬åœæ•ˆæœ
          marker.on('mouseover', () => {
            markerContent.style.transform = 'scale(1.2)';
            markerContent.style.zIndex = '1000';
          });

          marker.on('mouseout', () => {
            markerContent.style.transform = 'scale(1)';
            markerContent.style.zIndex = 'auto';
          });

          // æ·»åŠ ç‚¹å‡»äº‹ä»¶
          marker.on('click', () => {
            this.showInfoWindow(shop);
          });

          this.markers.push(marker);
        });

        // å°†æ‰€æœ‰æ ‡è®°æ·»åŠ åˆ°åœ°å›¾
        this.map.add(this.markers);

        // è°ƒæ•´è§†é‡ä»¥åŒ…å«æ‰€æœ‰æ ‡è®°
        if (this.markers.length > 0) {
          this.map.setFitView(this.markers);
        }
      },

      // ğŸ¨ ç¾åŒ–ä¿¡æ¯çª—å£ - ç²¾ç¾æ˜Ÿæ˜Ÿç‰ˆæœ¬
      showInfoWindow(shop) {
        this.infoWindows.forEach(win => win.close());
        this.infoWindows = [];

        const distanceText = this.formatDistance(shop.distance);

        // ç”Ÿæˆç²¾ç¾æ˜Ÿæ˜ŸHTML
        const generateStars = (score) => {
          const fullStars = Math.floor(score);
          const decimal = score % 1;
          let starsHtml = '';

          for (let i = 1; i <= 5; i++) {
            if (i <= fullStars) {
              // æ»¡æ˜Ÿ
              starsHtml += `
          <span style="
            color: #F7BA2A;
            font-size: 16px;
            text-shadow: 0 1px 2px rgba(247, 186, 42, 0.3);
          ">â˜…</span>
        `;
            } else if (i === fullStars + 1 && decimal >= 0.3) {
              // åŠæ˜Ÿï¼ˆæ ¹æ®å°æ•°éƒ¨åˆ†æ˜¾ç¤ºä¸åŒå¡«å……ï¼‰
              if (decimal >= 0.8) {
                starsHtml += `<span style="color: #F7BA2A; font-size: 16px;">â˜…</span>`;
              } else if (decimal >= 0.5) {
                starsHtml += `<span style="color: #F7BA2A; font-size: 16px;">â˜†</span>`;
              } else {
                starsHtml += `<span style="color: #F7BA2A; font-size: 16px; opacity: 0.6;">â˜†</span>`;
              }
            } else {
              // ç©ºæ˜Ÿ
              starsHtml += `
          <span style="
            color: #E6E6E6;
            font-size: 16px;
          ">â˜…</span>
        `;
            }
          }

          return starsHtml;
        };

        const content = `
    <div style="
      min-width: 280px;
      padding: 20px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
      border: 1px solid #f0f0f0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    ">
      <div style="display: flex; align-items: flex-start; margin-bottom: 16px;">
        <img src="${shop.avatar || '/imgs/default-shop.jpg'}"
             style="width: 70px; height: 70px; border-radius: 10px; object-fit: cover; margin-right: 16px; border: 2px solid #f8f8f8;">
        <div style="flex: 1;">
          <h4 style="margin: 0 0 12px 0; color: #333; font-size: 18px; font-weight: 700; line-height: 1.3;">${shop.name}</h4>

          <!-- è¯„åˆ†åŒºåŸŸ -->
          <div style="margin-bottom: 8px;">
            <div style="display: flex; align-items: center; margin-bottom: 6px;">
              <div style="display: flex; align-items: center; margin-right: 10px;">
                ${generateStars(shop.score)}
              </div>
              <span style="
                color: #ff6b35;
                font-weight: 700;
                font-size: 16px;
                background: linear-gradient(135deg, #ff6b35, #ff8c00);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
              ">${shop.score}</span>
            </div>

            <!-- è¯„è®ºæ•°é‡ -->
            <div style="
              display: inline-flex;
              align-items: center;
              background: #f8f9fa;
              padding: 4px 10px;
              border-radius: 12px;
              color: #666;
              font-size: 12px;
              font-weight: 500;
            ">
              <span style="margin-right: 4px;">ğŸ’¬</span>
              ${shop.comments ? shop.comments + 'æ¡è¯„è®º' : 'æš‚æ— è¯„è®º'}
            </div>
          </div>

          <!-- è·ç¦» -->
          <div style="
            display: inline-flex;
            align-items: center;
            background: #e8f4ff;
            padding: 4px 10px;
            border-radius: 12px;
            color: #1890ff;
            font-size: 12px;
            font-weight: 500;
            margin-top: 4px;
          ">
            <span style="margin-right: 4px;">ğŸ“</span>
            ${distanceText}
          </div>
        </div>
      </div>

      <!-- åœ°å€ -->
      <div style="
        background: #fafafa;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 16px;
        border-left: 3px solid #1890ff;
      ">
        <div style="color: #666; font-size: 13px; line-height: 1.4;">
          ${shop.address || 'åœ°å€ä¿¡æ¯æš‚æ— '}
        </div>
      </div>

      <!-- æŒ‰é’® -->
      <div style="text-align: right;">
        <button onclick="app.toShopDetail(${shop.id})"
                style="
                  background: linear-gradient(135deg, #ff6b35, #ff8c00);
                  color: white;
                  border: none;
                  padding: 10px 24px;
                  border-radius: 24px;
                  cursor: pointer;
                  font-weight: 600;
                  font-size: 14px;
                  transition: all 0.3s ease;
                  box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
                "
                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(255, 107, 53, 0.4)';"
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(255, 107, 53, 0.3)';">
          ğŸª æŸ¥çœ‹åº—é“ºè¯¦æƒ…
        </button>
      </div>
    </div>
  `;

        const infoWindow = new AMap.InfoWindow({
          content: content,
          offset: new AMap.Pixel(0, -45),
          closeWhenClickMap: true
        });

        infoWindow.open(this.map, [shop.x, shop.y]);
        this.infoWindows.push(infoWindow);
      },

      toggleFilters() {
        this.showFilters = !this.showFilters;
      },

      selectCategory(type) {
        this.typeId = type.id;
        this.showFilters = false;
        this.$message.success(`å·²ç­›é€‰${type.name}ç±»åˆ«`);
        this.getShopList();
      },

      centerToShop(shop) {
        this.toShopDetail(shop.id);
      },

      searchShops() {
        if (!this.searchKeyword.trim()) {
          this.keyword = this.searchKeyword.toLowerCase();
          this.getShopList();
          return;
        }
        this.keyword = this.searchKeyword.toLowerCase();
        this.getShopList();
      },

      getShopTypeList(){
        this.loadingText = "æ­£åœ¨åŠ è½½åº—é“ºç±»å‹...";
        return axios.get('/app/map/getShopTypeList').then(res => {
          this.shopTypeList = res.data
        }).catch(err => {
          console.log(err)
        })
      },

      getShopList(){
        this.loadingText = "æ­£åœ¨åŠ è½½é™„è¿‘åº—é“º...";
        return axios.get('/app/map/getShopList', {
          params: {
            typeId: this.typeId,
            x: this.x,
            y: this.y,
            keyword: this.keyword
          }
        }).then(res => {
          res.data.forEach(s => s.images = fileURL+s.images.split(',')[0]);
          this.shopList = res.data
          this.addShopMarkers();
          this.keyword = ''
        }).catch(err => {
          console.log(err)
        })
      },

      refreshData() {
        this.isLoading = true;
        this.loadingText = "æ­£åœ¨åˆ·æ–°æ•°æ®...";
        setTimeout(() => {
          this.isLoading = false;
          this.$message.success("åˆ·æ–°æˆåŠŸ");
          this.getShopList();
        }, 1000);
      },

      toShopDetail(shopId) {
        location.href = `/shop-detail.html?id=${shopId}`;
      },

      goBack() {
        location.href = "/";
      }
    }
  })
</script>

<style>
  .header-actions {
    display: flex;
    align-items: center;
  }

  .header-location {
    cursor: pointer;
    color: #409EFF;
    font-size: 18px;
  }
</style>
</body>
</html>