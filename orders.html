<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æˆ‘çš„è®¢å• - æ™ºè¯„ç”Ÿæ´»</title>
  <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
  <link rel="stylesheet" href="./css/element.css">
  <link href="./css/index.css" rel="stylesheet">
  <link href="./css/main.css" rel="stylesheet">
  <style>
    /* ====================================== æ–°å¢ï¼šå€’è®¡æ—¶æ ·å¼ ====================================== */
    .countdown-container {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
      padding: 8px 12px;
      background: #fff7e6;
      border-radius: 6px;
      border-left: 3px solid #fa8c16;
    }

    .countdown-icon {
      color: #fa8c16;
      font-size: 14px;
    }

    .countdown-text {
      font-size: 13px;
      color: #666;
    }

    .countdown-time {
      font-weight: 600;
      color: #fa541c;
      font-size: 14px;
    }

    .countdown-warning {
      background: #fff2f0;
      border-left-color: #ff4d4f;
    }

    .countdown-warning .countdown-icon {
      color: #ff4d4f;
    }

    .countdown-warning .countdown-time {
      color: #ff4d4f;
    }

    /* ====================================== åŸæœ‰æ ·å¼ä¿æŒä¸å˜ ====================================== */
    #app {
      min-height: 100vh;
      padding-bottom: 60px;
      position: relative;
      background: #f8f9fa;
    }

    .loading-mask {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255, 255, 255, 0.95);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.3s ease;
    }

    .loading-mask.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #409EFF;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }

    .loading-text {
      font-size: 16px;
      color: #666;
      text-align: center;
    }

    .loading-subtext {
      font-size: 14px;
      color: #999;
      margin-top: 8px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      overflow-x: hidden;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
      background-color: #f8f9fa;
      touch-action: pan-y;
    }

    .header {
      display: flex;
      align-items: center;
      padding: 15px;
      background: white;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-back-btn {
      font-size: 18px;
      color: #333;
      cursor: pointer;
      padding: 5px;
      border-radius: 50%;
      transition: background-color 0.3s;
    }

    .header-back-btn:hover {
      background-color: #f5f5f5;
    }

    .header-title {
      flex: 1;
      text-align: center;
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }

    /* è®¢å•åˆ—è¡¨å®¹å™¨ */
    .orders-container {
      height: calc(100vh - 120px);
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    /* è®¢å•åˆ—è¡¨æ ·å¼ */
    .order-list {
      background: white;
      margin-top: 10px;
    }

    .order-item {
      margin-bottom: 12px;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      transition: all 0.3s;
      border: 1px solid #f0f0f0;
    }

    .order-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      background: #fafafa;
      border-bottom: 1px solid #f0f0f0;
    }

    .order-info {
      display: flex;
      flex-direction: column;
    }

    .order-number {
      font-size: 14px;
      color: #666;
      margin-bottom: 4px;
    }

    .order-time {
      font-size: 12px;
      color: #999;
    }

    .order-status {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }

    .status-unpaid {
      background: #fff7e6;
      color: #fa8c16;
    }

    .status-paid {
      background: #f6ffed;
      color: #52c41a;
    }

    .status-used {
      background: #e6f7ff;
      color: #1890ff;
    }

    .status-cancelled {
      background: #fff2f0;
      color: #ff4d4f;
    }

    .status-refunding {
      background: #fff7e6;
      color: #fa8c16;
    }

    .status-refunded {
      background: #f6f6f6;
      color: #666;
    }

    .order-content {
      padding: 20px;
    }

    .voucher-info {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .voucher-title {
      font-size: 16px;
      color: #333;
      font-weight: 600;
      line-height: 1.4;
      cursor: pointer;
      transition: color 0.3s;
    }

    .voucher-title:hover {
      color: #409EFF;
    }

    .voucher-subtitle {
      font-size: 14px;
      color: #666;
      line-height: 1.4;
    }

    .voucher-rules {
      font-size: 13px;
      color: #999;
      line-height: 1.4;
      margin-top: 8px;
      padding: 8px 12px;
      background: #f8f9fa;
      border-radius: 4px;
    }

    .voucher-price {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px dashed #f0f0f0;
    }

    .price-item {
      display: flex;
      flex-direction: column;
    }

    .price-label {
      font-size: 12px;
      color: #999;
      margin-bottom: 4px;
    }

    .price-value {
      font-size: 16px;
      font-weight: 600;
    }

    .pay-value {
      color: #ff4757;
    }

    .actual-value {
      color: #52c41a;
    }

    .order-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      background: #fafafa;
      border-top: 1px solid #f0f0f0;
    }

    .order-total {
      font-size: 16px;
      color: #333;
      font-weight: 600;
    }

    .order-actions {
      display: flex;
      gap: 10px;
    }

    .order-btn {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.3s;
      border: 1px solid;
      background: white;
    }

    .btn-primary {
      color: #409EFF;
      border-color: #409EFF;
    }

    .btn-primary:hover {
      background: #409EFF;
      color: white;
    }

    .btn-secondary {
      color: #666;
      border-color: #d9d9d9;
    }

    .btn-secondary:hover {
      background: #f5f5f5;
      border-color: #999;
    }

    .btn-danger {
      color: #ff4757;
      border-color: #ff4757;
    }

    .btn-danger:hover {
      background: #ff4757;
      color: white;
    }

    /* è®¢å•è¯¦æƒ…å¼¹çª—æ ·å¼ */
    .order-detail-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 20px;
    }

    .order-detail-content {
      background: white;
      border-radius: 8px;
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .order-detail-header {
      padding: 20px;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .order-detail-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }

    .order-detail-close {
      font-size: 18px;
      color: #999;
      cursor: pointer;
      padding: 5px;
    }

    .order-detail-close:hover {
      color: #666;
    }

    .order-detail-body {
      padding: 20px;
    }

    .detail-section {
      margin-bottom: 20px;
    }

    .detail-section-title {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid #f0f0f0;
    }

    .detail-row {
      display: flex;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .detail-label {
      color: #666;
      width: 80px;
      flex-shrink: 0;
    }

    .detail-value {
      color: #333;
      flex: 1;
    }

    .empty-state {
      text-align: center;
      padding: 80px 20px;
      color: #999;
      background: white;
      margin-top: 10px;
    }

    .empty-icon {
      font-size: 60px;
      margin-bottom: 20px;
      opacity: 0.4;
    }

    .empty-text {
      font-size: 15px;
    }

    .loading-indicator {
      text-align: center;
      padding: 15px;
      color: #909399;
      font-size: 14px;
      background: white;
    }

    .loading-indicator .el-icon-loading {
      margin-right: 5px;
    }

    .no-more-data {
      text-align: center;
      padding: 15px;
      color: #C0C4CC;
      font-size: 14px;
      background: white;
    }

    .load-error {
      text-align: center;
      padding: 15px;
      color: #F56C6C;
      font-size: 14px;
      background: white;
    }

    .load-error .retry-btn {
      color: #409EFF;
      cursor: pointer;
      margin-left: 5px;
    }

    .foot-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: white;
      display: flex;
      justify-content: space-around;
      align-items: center;
      border-top: 1px solid #eee;
      z-index: 100;
    }

    .foot-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex: 1;
      height: 100%;
      cursor: pointer;
      transition: all 0.3s;
      color: #666;
      text-decoration: none;
    }

    .foot-btn.active {
      color: #409EFF;
    }

    .foot-btn:hover {
      background-color: #f9f9f9;
    }

    .foot-icon {
      font-size: 22px;
      margin-bottom: 4px;
    }

    .foot-text {
      font-size: 12px;
    }

    /* æ¶ˆæ¯æç¤ºå±…ä¸­æ ·å¼ */
    .el-message {
      display: flex;
      justify-content: center;
      align-items: center;
      top: 50% !important;
      left: 50% !important;
      transform: translate(-50%, -50%) !important;
      min-width: 300px;
    }

    .el-message__content {
      text-align: center;
    }

    /* å¯¹è¯æ¡†å±…ä¸­æ ·å¼ */
    .el-message-box {
      position: absolute;
      top: 50% !important;
      left: 50% !important;
      transform: translate(-50%, -50%) !important;
      margin-top: 0 !important;
    }

    /* è‡ªå®šä¹‰å¯¹è¯æ¡†æ ·å¼ */
    .pay-confirm-dialog,
    .cancel-confirm-dialog,
    .use-voucher-dialog,
    .refund-confirm-dialog {
      position: absolute;
      top: 50% !important;
      left: 50% !important;
      transform: translate(-50%, -50%) !important;
      margin-top: 0 !important;
    }
  </style>
</head>
<body>
<div id="app">
  <!-- æ–°å¢ï¼šåŠ è½½é®ç½©å±‚ -->
  <div class="loading-mask" :class="{ hidden: !isLoading }">
    <div class="loading-spinner"></div>
    <div class="loading-text">æ­£åœ¨åŠ è½½è®¢å•æ•°æ®</div>
    <div class="loading-subtext">è¯·ç¨å€™...</div>
  </div>

  <div class="header">
    <div class="header-back-btn" @click="goBack"><i class="el-icon-arrow-left"></i></div>
    <div class="header-title"v-if="stats.orderCount > 0">æˆ‘çš„è®¢å•({{stats.orderCount}})</div>
    <div class="header-title" v-else>æˆ‘çš„è®¢å•</div>
  </div>

  <div class="orders-container" @scroll="onScroll">
    <div class="order-list">
      <div v-if="orders.length > 0">
        <div v-for="order in orders" :key="order.id" class="order-item">
          <div class="order-header">
            <div class="order-info">
              <div class="order-number">è®¢å•å·: {{order.orderNumber || 'ORD' + order.id}}</div>
              <div class="order-time">{{formatTime(order.createTime)}}</div>
            </div>
            <div class="order-status" :class="getOrderStatusClass(order.status)">
              {{getOrderStatusText(order.status)}}
            </div>
          </div>

          <div class="order-content">
            <div class="voucher-info">
              <div class="voucher-title" @click="goToShop(order.voucher.shopId)">
                {{order.voucher.title}}
              </div>
              <div class="voucher-subtitle" v-if="order.voucher.subTitle">{{order.voucher.subTitle}}</div>
              <div class="voucher-rules" v-if="order.voucher.rules">{{order.voucher.rules}}</div>

              <!-- æ–°å¢ï¼šå€’è®¡æ—¶æ˜¾ç¤º -->
              <div v-if="order.status === 1 && order.countdown > 0"
                   class="countdown-container"
                   :class="{ 'countdown-warning': order.countdown <= 300000 }">
                <i class="el-icon-time countdown-icon"></i>
                <span class="countdown-text">å‰©ä½™æ”¯ä»˜æ—¶é—´:</span>
                <span class="countdown-time">{{formatCountdown(order.countdown)}}</span>
              </div>

              <div class="voucher-price">
                <div class="price-item">
                  <div class="price-label">æ”¯ä»˜é‡‘é¢</div>
                  <div class="price-value pay-value">Â¥{{formatPrice(order.voucher.payValue)}}</div>
                </div>
                <div class="price-item">
                  <div class="price-label">æŠµæ‰£é‡‘é¢</div>
                  <div class="price-value actual-value">Â¥{{formatPrice(order.voucher.actualValue)}}</div>
                </div>
              </div>
            </div>
          </div>

          <div class="order-footer">
            <div class="order-total">
              å®ä»˜: Â¥{{formatPrice(order.voucher.payValue)}}
            </div>
            <div class="order-actions">
              <button class="order-btn btn-secondary" @click="viewOrderDetail(order)">
                æŸ¥çœ‹è¯¦æƒ…
              </button>
              <button v-if="order.status === 1"
                      class="order-btn btn-primary"
                      @click="payOrder(order)">
                ç«‹å³æ”¯ä»˜
              </button>
              <button v-if="order.status === 1"
                      class="order-btn btn-danger"
                      @click="cancelOrder(order)">
                å–æ¶ˆè®¢å•
              </button>
              <button v-if="order.status === 2"
                      class="order-btn btn-primary"
                      @click="useVoucher(order)">
                ç«‹å³ä½¿ç”¨
              </button>
              <button v-if="order.status === 2"
                      class="order-btn btn-danger"
                      @click="applyRefund(order)">
                ç”³è¯·é€€æ¬¾
              </button>
            </div>
          </div>
        </div>

        <div class="loading-indicator" v-if="orderLoading">
          <i class="el-icon-loading"></i> æ­£åœ¨åŠ è½½æ›´å¤šè®¢å•...
        </div>

        <div class="no-more-data" v-if="orderNoMore && !orderLoading">
          <i class="el-icon-finished"></i> æ²¡æœ‰æ›´å¤šè®¢å•äº†
        </div>

        <div class="load-error" v-if="orderLoadError && !orderLoading">
          <i class="el-icon-warning"></i> åŠ è½½å¤±è´¥
          <span class="retry-btn" @click="retryLoadOrders">ç‚¹å‡»é‡è¯•</span>
        </div>
      </div>
      <div v-else class="empty-state">
        <div class="empty-icon"><i class="el-icon-shopping-cart-2"></i></div>
        <div class="empty-text">è¿˜æ²¡æœ‰ä»»ä½•è®¢å•</div>
      </div>
    </div>
  </div>

  <foot-bar :active-btn="4" class="foot-bar"></foot-bar>

  <!-- è®¢å•è¯¦æƒ…å¼¹çª— -->
  <div class="order-detail-modal" v-if="showOrderDetail" @click="closeOrderDetail">
    <div class="order-detail-content" @click.stop>
      <div class="order-detail-header">
        <div class="order-detail-title">è®¢å•è¯¦æƒ…</div>
        <i class="el-icon-close order-detail-close" @click="closeOrderDetail"></i>
      </div>
      <div class="order-detail-body" v-if="currentOrder">
        <div class="detail-section">
          <div class="detail-section-title">è®¢å•ä¿¡æ¯</div>
          <div class="detail-row">
            <div class="detail-label">è®¢å•å·:</div>
            <div class="detail-value">{{currentOrder.orderNumber || 'ORD' + currentOrder.id}}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">ä¸‹å•æ—¶é—´:</div>
            <div class="detail-value">{{formatTime(currentOrder.createTime)}}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">è®¢å•çŠ¶æ€:</div>
            <div class="detail-value">{{getOrderStatusText(currentOrder.status)}}</div>
          </div>

          <!-- æ–°å¢ï¼šè®¢å•è¯¦æƒ…ä¸­çš„å€’è®¡æ—¶æ˜¾ç¤º -->
          <div class="detail-row" v-if="currentOrder.status === 1 && currentOrder.countdown > 0">
            <div class="detail-label">å‰©ä½™æ—¶é—´:</div>
            <div class="detail-value" style="color: #fa541c; font-weight: 500;">
              {{formatCountdown(currentOrder.countdown)}}
            </div>
          </div>

          <div class="detail-row">
            <div class="detail-label">æ”¯ä»˜æ–¹å¼:</div>
            <div class="detail-value">{{getPayTypeText(currentOrder.payType)}}</div>
          </div>
          <div class="detail-row" v-if="currentOrder.payTime">
            <div class="detail-label">æ”¯ä»˜æ—¶é—´:</div>
            <div class="detail-value">{{formatTime(currentOrder.payTime)}}</div>
          </div>
          <div class="detail-row" v-if="currentOrder.useTime">
            <div class="detail-label">ä½¿ç”¨æ—¶é—´:</div>
            <div class="detail-value">{{formatTime(currentOrder.useTime)}}</div>
          </div>
        </div>

        <div class="detail-section" v-if="currentOrder.voucher">
          <div class="detail-section-title">ä¼˜æƒ åˆ¸ä¿¡æ¯</div>
          <div class="detail-row">
            <div class="detail-label">åˆ¸åç§°:</div>
            <div class="detail-value">{{currentOrder.voucher.title}}</div>
          </div>
          <div class="detail-row" v-if="currentOrder.voucher.subTitle">
            <div class="detail-label">å‰¯æ ‡é¢˜:</div>
            <div class="detail-value">{{currentOrder.voucher.subTitle}}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">æ”¯ä»˜é‡‘é¢:</div>
            <div class="detail-value">Â¥{{formatPrice(currentOrder.voucher.payValue)}}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">æŠµæ‰£é‡‘é¢:</div>
            <div class="detail-value">Â¥{{formatPrice(currentOrder.voucher.actualValue)}}</div>
          </div>
          <div class="detail-row" v-if="currentOrder.voucher.rules">
            <div class="detail-label">ä½¿ç”¨è§„åˆ™:</div>
            <div class="detail-value">{{currentOrder.voucher.rules}}</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="./js/vue.js"></script>
<script src="./js/axios.min.js"></script>
<script src="./js/element.js"></script>
<script src="./js/common.js"></script>
<script src="./js/footer.js"></script>
<script>
  new Vue({
    el: '#app',
    data() {
      return {
        user: {},
        orders: [],
        stats: {
          orderCount: 0
        },
        orderCurrent: 1,
        orderSize: 10,
        orderLoading: false,
        orderNoMore: false,
        orderLoadError: false,
        showOrderDetail: false,
        currentOrder: null,
        // æ»šåŠ¨èŠ‚æµ
        scrollThrottle: null,
        // æ–°å¢ï¼šåŠ è½½çŠ¶æ€æ§åˆ¶
        isLoading: true,
        // æ•°æ®åŠ è½½å®Œæˆè®¡æ•°å™¨
        dataLoadedCount: 0,
        // éœ€è¦åŠ è½½çš„æ•°æ®æ€»æ•°
        totalDataToLoad: 2, // ç”¨æˆ·ä¿¡æ¯ã€è®¢å•åˆ—è¡¨
        // æ–°å¢ï¼šå€’è®¡æ—¶å®šæ—¶å™¨
        countdownTimer: null,
        // æ–°å¢ï¼šæ”¯ä»˜æ—¶é—´é™åˆ¶ï¼ˆ15åˆ†é’Ÿï¼‰
        PAYMENT_TIME_LIMIT: 15 * 60 * 1000 // 15åˆ†é’Ÿ
      }
    },
    created() {
      this.queryUser();
      this.queryOrders();
    },
    mounted() {
      // å¯åŠ¨å€’è®¡æ—¶å®šæ—¶å™¨
      this.startCountdownTimer();
    },
    beforeDestroy() {
      // æ¸…ç†å®šæ—¶å™¨
      if (this.countdownTimer) {
        clearInterval(this.countdownTimer);
      }
    },
    methods: {
      // æ–°å¢ï¼šå¯åŠ¨å€’è®¡æ—¶å®šæ—¶å™¨
      startCountdownTimer() {
        // æ¯ç§’æ›´æ–°ä¸€æ¬¡å€’è®¡æ—¶
        this.countdownTimer = setInterval(() => {
          this.updateAllCountdowns();
        }, 1000);
      },

      // æ–°å¢ï¼šåˆå§‹åŒ–æ‰€æœ‰è®¢å•çš„å€’è®¡æ—¶
      initAllCountdowns() {
        const now = new Date().getTime();

        this.orders.forEach(order => {
          // åªå¤„ç†å¾…æ”¯ä»˜è®¢å•
          if (order.status === 1 && order.createTime) {
            const createTime = new Date(order.createTime).getTime();
            const timePassed = now - createTime;
            const timeLeft = this.PAYMENT_TIME_LIMIT - timePassed; // 15åˆ†é’Ÿå€’è®¡æ—¶

            if (timeLeft > 0) {
              // åˆå§‹åŒ–å€’è®¡æ—¶
              order.countdown = timeLeft;
            } else {
              // å€’è®¡æ—¶ç»“æŸï¼Œè‡ªåŠ¨å–æ¶ˆè®¢å•
              order.countdown = 0;
            }
          }
        });

        // å¼ºåˆ¶æ›´æ–°è§†å›¾
        this.$forceUpdate();
      },

      // æ–°å¢ï¼šæ›´æ–°æ‰€æœ‰è®¢å•çš„å€’è®¡æ—¶
      updateAllCountdowns() {
        this.orders.forEach(order => {
          // åªå¤„ç†å¾…æ”¯ä»˜è®¢å•
          if (order.status === 1 && order.countdown > 0) {
            order.countdown -= 1000; // å‡å°‘1ç§’

            if (order.countdown <= 0) {
              order.countdown = 0;
            }
          }
        });

        // å¦‚æœå½“å‰æŸ¥çœ‹çš„è®¢å•è¯¦æƒ…æ˜¯å¾…æ”¯ä»˜çŠ¶æ€ï¼Œä¹Ÿæ›´æ–°å…¶å€’è®¡æ—¶
        if (this.currentOrder && this.currentOrder.status === 1) {
          const currentOrderInList = this.orders.find(o => o.id === this.currentOrder.id);
          if (currentOrderInList && currentOrderInList.countdown !== undefined) {
            this.currentOrder.countdown = currentOrderInList.countdown;
          }
        }

        // å¼ºåˆ¶æ›´æ–°è§†å›¾
        this.$forceUpdate();
      },

      // æ–°å¢ï¼šæ ¼å¼åŒ–å€’è®¡æ—¶æ˜¾ç¤º
      formatCountdown(milliseconds) {
        if (milliseconds <= 0) return '00:00';

        const totalSeconds = Math.floor(milliseconds / 1000);
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;

        return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      },

      // æ–°å¢ï¼šæ•°æ®åŠ è½½å®Œæˆå›è°ƒ
      onDataLoaded() {
        this.dataLoadedCount++;
        console.log(`æ•°æ®åŠ è½½è¿›åº¦: ${this.dataLoadedCount}/${this.totalDataToLoad}`);

        // å½“æ‰€æœ‰æ•°æ®åŠ è½½å®Œæˆæ—¶éšè—é®ç½©å±‚
        if (this.dataLoadedCount >= this.totalDataToLoad) {
          setTimeout(() => {
            this.isLoading = false;
            console.log('æ‰€æœ‰æ•°æ®åŠ è½½å®Œæˆï¼Œéšè—é®ç½©å±‚');
          }, 500); // å»¶è¿Ÿ500mséšè—ï¼Œè®©ç”¨æˆ·çœ‹åˆ°åŠ è½½å®Œæˆ
        }
      },

      // æ»šåŠ¨äº‹ä»¶å¤„ç†
      onScroll(e) {
        if (this.scrollThrottle) {
          clearTimeout(this.scrollThrottle);
        }

        this.scrollThrottle = setTimeout(() => {
          const container = e.target;
          const { scrollTop, clientHeight, scrollHeight } = container;
          const distanceToBottom = scrollHeight - scrollTop - clientHeight;

          // å½“è·ç¦»åº•éƒ¨å°äº100pxæ—¶åŠ è½½æ›´å¤š
          if (distanceToBottom <= 100
                  && !this.orderLoading
                  && !this.orderNoMore
                  && !this.orderLoadError) {
            this.loadMoreOrders();
          }
        }, 150);
      },

      // æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
      async queryUser() {
        try {
          let response = await axios.get("/app/user/me")
          this.user = response.data;
          await this.queryUserStats();
          this.onDataLoaded(); // æ–°å¢ï¼šæ•°æ®åŠ è½½å®Œæˆå›è°ƒ
        } catch (error) {
          console.error('æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
          this.onDataLoaded(); // æ–°å¢ï¼šå³ä½¿å¤±è´¥ä¹Ÿå›è°ƒ
          this.$message({
            type: 'warning',
            message: 'è¯·å…ˆç™»å½•',
            duration: 1000,
            center: true,
            onClose: () => {
              location.href = "login.html";
            }
          });
        }
      },

      // æŸ¥è¯¢è®¢å•åˆ—è¡¨
      queryOrders() {
        this.orderCurrent = 1;
        this.orderNoMore = false;
        this.orderLoadError = false;
        axios.get("/app/order/voucher-order/of/me")
                .then(({data}) => {
                  this.orders = data || [];
                  // ä¸ºæ¯ä¸ªè®¢å•æŸ¥è¯¢ä¼˜æƒ åˆ¸è¯¦æƒ…
                  this.orders.forEach(order => {
                    this.queryVoucherDetail(order);
                  });
                  this.onDataLoaded(); // æ–°å¢ï¼šæ•°æ®åŠ è½½å®Œæˆå›è°ƒ
                  if (!data || data.length === 0) {
                    this.orderNoMore = true;
                  }

                  // æ–°å¢ï¼šåˆå§‹åŒ–æ‰€æœ‰è®¢å•çš„å€’è®¡æ—¶
                  this.initAllCountdowns();
                })
                .catch(err => {
                  console.error('è·å–è®¢å•åˆ—è¡¨å¤±è´¥:', err);
                  this.orders = [];
                  this.orderLoadError = true;
                  this.onDataLoaded(); // æ–°å¢ï¼šå³ä½¿å¤±è´¥ä¹Ÿå›è°ƒ
                })
      },

      // æŸ¥è¯¢ä¼˜æƒ åˆ¸è¯¦æƒ…
      queryVoucherDetail(order) {
        if (!order.voucherId) return;

        axios.get(`/app/marketing/voucher/${order.voucherId}`)
                .then(({data}) => {
                  order.voucher = data;
                  this.$forceUpdate();
                })
                .catch(err => {
                  console.error('è·å–ä¼˜æƒ åˆ¸è¯¦æƒ…å¤±è´¥:', err);
                });
      },

      // åŠ è½½æ›´å¤šè®¢å•
      loadMoreOrders() {
        if (this.orderLoading || this.orderNoMore || this.orderLoadError) return;

        this.orderLoading = true;
        this.orderLoadError = false;
        this.orderCurrent++;

        axios.get("/app/order/voucher-order/of/me",{
          params: {
            current: this.orderCurrent,
          }
        })
                .then(({data}) => {
                  const newOrders = data || [];
                  if (newOrders.length > 0) {
                    this.orders = [...this.orders, ...newOrders];
                    newOrders.forEach(order => {
                      this.queryVoucherDetail(order);
                    });
                  }
                  if (newOrders.length === 0) {
                    this.orderNoMore = true;
                  }

                  // æ–°å¢ï¼šåˆå§‹åŒ–æ–°åŠ è½½è®¢å•çš„å€’è®¡æ—¶
                  this.initAllCountdowns();
                })
                .catch(err => {
                  console.error('åŠ è½½æ›´å¤šè®¢å•å¤±è´¥:', err);
                  this.orderCurrent--;
                  this.orderLoadError = true;
                })
                .finally(() => {
                  this.orderLoading = false;
                });
      },

      // æŸ¥è¯¢ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯
      async queryUserStats() {
        try {
          let response = await axios.get("/app/user/stats/" + this.user.id)
          this.stats = response.data;
        } catch (error) {
          console.error('è·å–ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error);
          this.stats = {
            likeCount: 0,
            fansCount: 0,
            followCount: 0
          };
        }
      },

      // é‡è¯•åŠ è½½
      retryLoadOrders() {
        this.orderLoadError = false;
        this.loadMoreOrders();
      },

      // æ ¼å¼åŒ–ä»·æ ¼ï¼ˆåˆ†è½¬å…ƒï¼‰
      formatPrice(price) {
        if (!price) return '0.00';
        const priceNum = typeof price === 'string' ? parseFloat(price) : price;
        return (priceNum / 100).toFixed(2);
      },

      // è·å–è®¢å•çŠ¶æ€ç±»å
      getOrderStatusClass(status) {
        const statusMap = {
          '1': 'status-unpaid',
          '2': 'status-paid',
          '3': 'status-used',
          '4': 'status-cancelled',
          '5': 'status-refunding',
          '6': 'status-refunded'
        };
        return statusMap[status] || 'status-unpaid';
      },

      // è·å–è®¢å•çŠ¶æ€æ–‡æœ¬
      getOrderStatusText(status) {
        const statusMap = {
          '1': 'å¾…æ”¯ä»˜',
          '2': 'å·²æ”¯ä»˜',
          '3': 'å·²ä½¿ç”¨',
          '4': 'å·²å–æ¶ˆ',
          '5': 'é€€æ¬¾ä¸­',
          '6': 'å·²é€€æ¬¾'
        };
        return statusMap[status] || 'æœªçŸ¥çŠ¶æ€';
      },

      // è·å–æ”¯ä»˜æ–¹å¼æ–‡æœ¬
      getPayTypeText(payType) {
        const payTypeMap = {
          '1': 'ä½™é¢æ”¯ä»˜',
          '2': 'æ”¯ä»˜å®',
          '3': 'å¾®ä¿¡æ”¯ä»˜'
        };
        return payTypeMap[payType] || 'æœªçŸ¥æ”¯ä»˜æ–¹å¼';
      },

      // æŸ¥çœ‹è®¢å•è¯¦æƒ…
      viewOrderDetail(order) {
        this.currentOrder = {...order};
        this.showOrderDetail = true;
      },

      // å…³é—­è®¢å•è¯¦æƒ…
      closeOrderDetail() {
        this.showOrderDetail = false;
        this.currentOrder = null;
      },

      // è·³è½¬åˆ°åº—é“ºåˆ—è¡¨
      goToShop(shopId) {
        if (shopId) {
          // è·³è½¬åˆ°åº—é“ºåˆ—è¡¨é¡µé¢ï¼Œå¹¶ä¼ é€’shopIdå‚æ•°
          window.location.href = `shop-detail.html?id=${shopId}`;
        } else {
          this.$message({
            message: 'åº—é“ºä¿¡æ¯ä¸å­˜åœ¨',
            type: 'warning',
            center: true
          });
        }
      },

      // æ”¯ä»˜è®¢å•
      payOrder(order) {
        this.$confirm(`ç¡®å®šè¦æ”¯ä»˜è®¢å• <strong>${order.orderNumber || 'ORD' + order.id}</strong> å—ï¼Ÿ<br>æ”¯ä»˜é‡‘é¢: <span style="color: #ff4757; font-weight: bold;">Â¥${this.formatPrice(order.voucher.payValue)}</span>`, 'ç¡®è®¤æ”¯ä»˜', {
          confirmButtonText: 'ç¡®è®¤æ”¯ä»˜',
          cancelButtonText: 'å†æƒ³æƒ³',
          type: 'info',
          dangerouslyUseHTMLString: true,
          customClass: 'pay-confirm-dialog',
          center: true
        }).then(() => {
          axios.post(`/app/order/voucher-order/pay/${order.id}`)
                  .then(() => {
                    this.$message({
                      message: `ğŸ‰ æ”¯ä»˜æˆåŠŸï¼è®¢å• ${order.orderNumber || 'ORD' + order.id} å·²å®Œæˆæ”¯ä»˜`,
                      type: 'success',
                      duration: 3000,
                      center: true
                    });
                    order.status = 2;
                    // æ”¯ä»˜æˆåŠŸåæ¸…é™¤å€’è®¡æ—¶
                    if (order.countdown !== undefined) {
                      order.countdown = 0;
                    }
                    this.queryOrders();
                  })
                  .catch(err => {
                    console.error('æ”¯ä»˜å¤±è´¥:', err);
                    this.$message({
                      message: 'ğŸ˜” æ”¯ä»˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ä½™é¢åé‡è¯•',
                      type: 'error',
                      center: true
                    });
                  });
        });
      },

      // å–æ¶ˆè®¢å•
      cancelOrder(order) {
        this.$confirm(`ç¡®å®šè¦å–æ¶ˆè®¢å• <strong>${order.orderNumber || 'ORD' + order.id}</strong> å—ï¼Ÿ<br><span style="color: #ff4757;">å–æ¶ˆåè®¢å•å°†æ— æ³•æ¢å¤</span>`, 'å–æ¶ˆè®¢å•', {
          confirmButtonText: 'ç¡®å®šå–æ¶ˆ',
          cancelButtonText: 'ç»§ç»­æ”¯ä»˜',
          type: 'warning',
          dangerouslyUseHTMLString: true,
          customClass: 'cancel-confirm-dialog',
          center: true
        }).then(() => {
          axios.post(`/app/order/voucher-order/cancel/${order.id}`)
                  .then(() => {
                    this.$message({
                      message: `âœ… è®¢å• ${order.orderNumber || 'ORD' + order.id} å·²æˆåŠŸå–æ¶ˆ`,
                      type: 'success',
                      duration: 3000,
                      center: true
                    });
                    order.status = 4;
                    // å–æ¶ˆè®¢å•åæ¸…é™¤å€’è®¡æ—¶
                    if (order.countdown !== undefined) {
                      order.countdown = 0;
                    }
                    this.queryOrders();
                  })
                  .catch(err => {
                    console.error('å–æ¶ˆè®¢å•å¤±è´¥:', err);
                    this.$message({
                      message: 'âŒ å–æ¶ˆè®¢å•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•',
                      type: 'error',
                      center: true
                    });
                  });
        });
      },

      // ä½¿ç”¨ä¼˜æƒ åˆ¸
      useVoucher(order) {
        this.$confirm(`ç¡®å®šè¦ä½¿ç”¨ä¼˜æƒ åˆ¸ <strong>${order.voucher.title}</strong> å—ï¼Ÿ<br>ä½¿ç”¨åä¼˜æƒ åˆ¸å°†ç«‹å³ç”Ÿæ•ˆ`, 'ä½¿ç”¨ä¼˜æƒ åˆ¸', {
          confirmButtonText: 'ç«‹å³ä½¿ç”¨',
          cancelButtonText: 'ç¨åä½¿ç”¨',
          type: 'info',
          dangerouslyUseHTMLString: true,
          customClass: 'use-voucher-dialog',
          center: true
        }).then(() => {
          axios.post(`/app/order/voucher-order/use/${order.id}`)
                  .then(() => {
                    this.$message({
                      message: `ğŸŠ ä¼˜æƒ åˆ¸ä½¿ç”¨æˆåŠŸï¼${order.voucher.title} å·²ç”Ÿæ•ˆ`,
                      type: 'success',
                      duration: 3000,
                      center: true
                    });
                    order.status = 3;
                    this.queryOrders();
                  })
                  .catch(err => {
                    console.error('ä½¿ç”¨ä¼˜æƒ åˆ¸å¤±è´¥:', err);
                    this.$message({
                      message: 'ğŸ˜” ä½¿ç”¨ä¼˜æƒ åˆ¸å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•',
                      type: 'error',
                      center: true
                    });
                  });
        });
      },

      // ç”³è¯·é€€æ¬¾
      applyRefund(order) {
        this.$confirm(`ç¡®å®šè¦ä¸ºè®¢å• <strong>${order.orderNumber || 'ORD' + order.id}</strong> ç”³è¯·é€€æ¬¾å—ï¼Ÿ<br><span style="color: #fa8c16;">é€€æ¬¾ç”³è¯·æäº¤åå°†åœ¨1-3ä¸ªå·¥ä½œæ—¥å†…å¤„ç†</span>`, 'ç”³è¯·é€€æ¬¾', {
          confirmButtonText: 'ç”³è¯·é€€æ¬¾',
          cancelButtonText: 'æš‚ä¸é€€æ¬¾',
          type: 'warning',
          dangerouslyUseHTMLString: true,
          customClass: 'refund-confirm-dialog',
          center: true
        }).then(() => {
          axios.post(`/app/order/voucher-order/refund/${order.id}`)
                  .then(() => {
                    this.$message({
                      message: `ğŸ“ é€€æ¬¾ç”³è¯·å·²æäº¤ï¼è®¢å• ${order.orderNumber || 'ORD' + order.id} æ­£åœ¨å¤„ç†ä¸­`,
                      type: 'success',
                      duration: 4000,
                      center: true
                    });
                    order.status = 5;
                    this.queryOrders();
                  })
                  .catch(err => {
                    console.error('ç”³è¯·é€€æ¬¾å¤±è´¥:', err);
                    this.$message({
                      message: 'âŒ é€€æ¬¾ç”³è¯·å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•æˆ–è”ç³»å®¢æœ',
                      type: 'error',
                      center: true
                    });
                  });
        });
      },

      formatTime(time) {
        if (!time) return '';
        const date = new Date(time);
        const now = new Date();
        const diff = now - date;

        if (diff < 60000) return 'åˆšåˆš';
        if (diff < 3600000) return Math.floor(diff / 60000) + 'åˆ†é’Ÿå‰';
        if (diff < 86400000) return Math.floor(diff / 3600000) + 'å°æ—¶å‰';
        if (diff < 604800000) return Math.floor(diff / 86400000) + 'å¤©å‰';

        return date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate();
      },

      goBack() {
        history.back();
      }
    }
  });
</script>
</body>
</html>