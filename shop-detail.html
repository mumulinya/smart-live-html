<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <title>智评生活</title>
  <!-- 引入样式：确保main.css在最前，覆盖默认样式 -->
  <link href="./css/main.css" rel="stylesheet">
  <link rel="stylesheet" href="./css/element.css">
  <link href="./css/shop-detail.css" rel="stylesheet">

  <style type="text/css">
    /* ====================================== 新增：加载遮罩层样式 ====================================== */
    #app {
      position: relative;
      height: 100vh;
      overflow: hidden;
    }

    .loading-mask {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255, 255, 255, 0.95);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.3s ease;
    }

    .loading-mask.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #ff6633;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }

    .loading-text {
      font-size: 16px;
      color: #666;
      text-align: center;
    }

    .loading-subtext {
      font-size: 14px;
      color: #999;
      margin-top: 8px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ====================================== 核心修改：关注按钮（改为收藏按钮风格） ====================================== */
    /* 适配main.css的底部按钮结构，统一使用.foot-item类名 */
    .foot-item.follow-btn {
      display: flex;
      flex-direction: column; /* 垂直布局，与main.css底部导航一致 */
      align-items: center;
      justify-content: center;
      flex: 1; /* 占满可用空间，与其他底部按钮对齐 */
      height: 100%;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); /* 与main.css过渡曲线统一 */
      position: relative;
      opacity: 0.6; /* 默认非活跃状态透明度 */
      padding: 0 8px; /* 增加内边距，避免内容拥挤 */
    }

    /* 收藏激活状态（与main.css.active风格统一） */
    .foot-item.follow-btn.active {
      opacity: 1;
    }

    /* 收藏按钮图标样式（适配main.css.foot-icon） */
    .foot-item.follow-btn .foot-icon {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 4px; /* 图标与文字间距，与main.css一致 */
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .foot-item.follow-btn .foot-icon i {
      font-size: 22px; /* 图标大小与main.css一致 */
      color: #666;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* 收藏激活状态：图标上浮+变色（与main.css.active效果统一） */
    .foot-item.follow-btn.active .foot-icon {
      transform: translateY(-2px);
    }

    .foot-item.follow-btn.active .foot-icon i {
      color: #ff6633; /* 与main.css.active颜色统一 */
      transform: scale(1.15); /* 图标放大，增强反馈 */
    }

    /* 收藏按钮文字样式（适配main.css.foot-text） */
    .foot-item.follow-btn .foot-text {
      font-size: 11px; /* 文字大小与main.css一致 */
      color: #666;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-weight: 500;
      text-align: center; /* 文字居中，避免偏移 */
    }

    /* 收藏激活状态：文字变色（与main.css.active风格统一） */
    .foot-item.follow-btn.active .foot-text {
      color: #ff6633;
      font-weight: 600;
    }

    /* 收藏按钮加载状态（新增，避免重复点击） */
    .foot-item.follow-btn.loading {
      cursor: not-allowed;
      opacity: 0.5;
    }

    .foot-item.follow-btn.loading .foot-icon i {
      color: #999;
      transform: none;
      animation: spin 1s linear infinite; /* 加载动画 */
    }

    /* ====================================== 核心修改：评论按钮（与main.css风格统一） ====================================== */
    .foot-item.comment-btn {
      display: flex;
      flex-direction: column; /* 垂直布局，与main.css一致 */
      align-items: center;
      justify-content: center;
      flex: 1; /* 占满可用空间，与其他底部按钮对齐 */
      height: 100%;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      opacity: 0.6; /* 默认非活跃状态透明度 */
      padding: 0 8px;
    }

    /* 评论按钮点击/活跃状态 */
    .foot-item.comment-btn.active,
    .foot-item.comment-btn:hover {
      opacity: 1;
    }

    /* 评论按钮图标样式（适配main.css.foot-icon） */
    .foot-item.comment-btn .foot-icon {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 4px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .foot-item.comment-btn .foot-icon i {
      font-size: 22px;
      color: #666;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* 评论按钮hover/活跃状态：图标上浮+变色 */
    .foot-item.comment-btn.active .foot-icon,
    .foot-item.comment-btn:hover .foot-icon {
      transform: translateY(-2px);
    }

    .foot-item.comment-btn.active .foot-icon i,
    .foot-item.comment-btn:hover .foot-icon i {
      color: #ff6633; /* 与main.css活跃色统一 */
      transform: scale(1.15);
    }

    /* 评论按钮文字样式（适配main.css.foot-text） */
    .foot-item.comment-btn .foot-text {
      font-size: 11px;
      color: #666;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-weight: 500;
      text-align: center;
    }

    /* 评论按钮hover/活跃状态：文字变色 */
    .foot-item.comment-btn.active .foot-text,
    .foot-item.comment-btn:hover .foot-text {
      color: #ff6633;
      font-weight: 600;
    }

    /* 评论按钮禁用状态（未登录时） */
    .foot-item.comment-btn.disabled {
      cursor: not-allowed;
      opacity: 0.4;
    }

    .foot-item.comment-btn.disabled .foot-icon i,
    .foot-item.comment-btn.disabled .foot-text {
      color: #999;
      transform: none;
    }

    /* ====================================== 底部操作栏布局：适配main.css.foot-bar ====================================== */
    /* 替换原有.foot样式，使用main.css的.foot-bar结构 */
    .foot-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 70px; /* 与main.css高度一致 */
      background: white;
      display: flex;
      align-items: center;
      justify-content: space-around;
      box-shadow: 0 -2px 20px rgba(0, 0, 0, 0.08); /* 与main.css阴影一致 */
      z-index: 1000;
      padding: 0 10px;
      border-top: 1px solid #f0f0f0; /* 与main.css边框一致 */
    }

    /* 移除原有.foot和.foot-box样式，避免冲突 */
    .foot {
      display: none;
    }

    /* ====================================== 原有样式保持不变（以下代码未修改） ====================================== */
    .header{
      position: relative;
    }
    .liked{

    }

    .comment-publish {
      background: #fff;
      margin: 0;
      padding: 15px;
      border-bottom: 1px solid #f1f1f1;
    }

    .publish-header {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
    }

    .publish-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      overflow: hidden;
      margin-right: 10px;
      flex-shrink: 0;
    }

    .publish-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .username {
      font-size: 14px;
      font-weight: 500;
      color: #333;
    }

    .publish-content {
      margin-left: 42px;
    }

    .publish-textarea {
      position: relative;
      margin-bottom: 12px;
    }

    .publish-textarea textarea {
      width: 100%;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 12px;
      font-size: 14px;
      line-height: 1.4;
      resize: none;
      background: #fafafa;
      color: #333;
      min-height: 60px;
      box-sizing: border-box;
      font-family: inherit;
    }

    .publish-textarea textarea:focus {
      outline: none;
      border-color: #ff6633;
      background: #fff;
    }

    .publish-textarea textarea::placeholder {
      color: #999;
    }

    .text-count {
      position: absolute;
      bottom: 8px;
      right: 12px;
      font-size: 12px;
      color: #999;
    }

    .publish-images {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }

    .image-upload {
      width: 70px;
      height: 70px;
      border: 1px dashed #d9d9d9;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #999;
      font-size: 18px;
      background: #fafafa;
      transition: all 0.2s;
    }

    .image-upload:hover {
      border-color: #ff6633;
      color: #ff6633;
    }

    .image-preview {
      position: relative;
      width: 70px;
      height: 70px;
      border-radius: 6px;
      overflow: hidden;
      border: 1px solid #f0f0f0;
    }

    .image-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .image-remove {
      position: absolute;
      top: 2px;
      right: 2px;
      width: 18px;
      height: 18px;
      background: rgba(0,0,0,0.7);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      cursor: pointer;
      line-height: 1;
    }

    .publish-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 12px;
      border-top: 1px solid #f8f8f8;
    }

    .action-left {
      display: flex;
      align-items: center;
    }

    .rate-section {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .action-right {
      display: flex;
      gap: 8px;
    }

    .publish-btn {
      padding: 6px 16px;
      border: none;
      border-radius: 16px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .cancel-btn {
      background: #f5f5f5;
      color: #666;
    }

    .cancel-btn:hover {
      background: #e8e8e8;
    }

    .submit-btn {
      background: #ff6633;
      color: white;
    }

    .submit-btn:hover {
      background: #ff854d;
    }

    .submit-btn.disabled {
      background: #ffb399;
      cursor: not-allowed;
    }

    .comment-publish {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }

    .publish-header {
      align-items: flex-start;
    }

    .publish-user {
      flex: 1;
    }

    @media (max-width: 375px) {
      .comment-publish {
        padding: 12px 15px;
      }

      .publish-content {
        margin-left: 40px;
      }

      .image-upload,
      .image-preview {
        width: 65px;
        height: 65px;
      }

      /* 移动端适配：底部按钮文字缩小 */
      .foot-item .foot-text {
        font-size: 10px;
      }

      /* 移动端适配：底部栏高度调整（与main.css一致） */
      .foot-bar {
        height: 65px;
      }
    }

    .comment-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      display: flex;
      align-items: flex-end;
      justify-content: center;
    }

    .comment-modal-content {
      width: 100%;
      max-width: 100%;
      background: white;
      border-radius: 16px 16px 0 0;
      max-height: 80vh;
      overflow-y: auto;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from {
        transform: translateY(100%);
      }
      to {
        transform: translateY(0);
      }
    }

    .comment-modal .comment-publish {
      border-radius: 16px 16px 0 0;
      padding: 20px 15px;
    }

    .comment-modal .publish-header {
      position: relative;
      margin-bottom: 15px;
    }

    .close-btn {
      position: absolute;
      right: 0;
      top: 0;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #f5f5f5;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #666;
    }

    .close-btn:hover {
      background: #e8e8e8;
    }

    .comment-modal .publish-textarea textarea {
      min-height: 100px;
      background: #fff;
      border: 1px solid #e0e0e0;
    }

    .comment-modal .publish-actions {
      padding-top: 15px;
      border-top: 1px solid #f0f0f0;
      margin-top: 15px;
    }

    .comment-publish:not(.comment-modal .comment-publish) {
      display: none;
    }

    .image-preview-layer {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .preview-container {
      width: 90%;
      max-width: 800px;
      height: 80%;
      background: #fff;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      border-bottom: 1px solid #eee;
      background: #f8f8f8;
    }

    .preview-title {
      font-size: 16px;
      font-weight: bold;
      color: #333;
    }

    .close-btn {
      font-size: 18px;
      color: #666;
      cursor: pointer;
      padding: 5px;
    }

    .close-btn:hover {
      color: #ff6633;
    }

    .preview-content {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      overflow: hidden;
    }

    .preview-image {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .preview-footer {
      padding: 15px 20px;
      border-top: 1px solid #eee;
      background: #f8f8f8;
    }

    .preview-nav {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
    }

    .nav-btn {
      width: 40px;
      height: 40px;
      border: 1px solid #ddd;
      border-radius: 50%;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .nav-btn:hover:not(:disabled) {
      border-color: #ff6633;
      color: #ff6633;
    }

    .nav-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .preview-counter {
      font-size: 14px;
      color: #666;
      min-width: 60px;
      text-align: center;
    }

    .ai-generated-comment {
      background: linear-gradient(135deg, #f8fbff 0%, #f0f7ff 100%);
      border: 1px solid #e1eeff;
      border-radius: 12px;
      margin: 12px 0;
      padding: 16px;
      position: relative;
      box-shadow: 0 2px 8px rgba(74, 108, 247, 0.08);
    }

    .ai-generated-badge {
      position: absolute;
      top: 12px;
      right: 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 10px;
      font-weight: 600;
      letter-spacing: 0.5px;
      box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
    }

    .ai-comment-icon {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 14px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      overflow: hidden;
      margin-right: 10px;
      flex-shrink: 0;
      box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
    }

    .ai-comment-icon::before {
      content: '';
      position: absolute;
      top: -10px;
      left: -10px;
      right: -10px;
      bottom: -10px;
      background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.2) 50%, transparent 70%);
      animation: shine 3s infinite linear;
    }

    @keyframes shine {
      0% {
        transform: translateX(-100%);
      }
      100% {
        transform: translateX(100%);
      }
    }

    .ai-comment-icon i {
      position: relative;
      z-index: 2;
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2));
    }

    .ai-comment-info .comment-user {
      color: #2d3748;
      font-weight: 600;
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .ai-verified {
      color: #667eea;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 4px;
      background: rgba(102, 126, 234, 0.1);
      padding: 2px 6px;
      border-radius: 8px;
    }

    .ai-comment-info .comment-content {
      color: #4a5568;
      line-height: 1.6;
      font-size: 14px;
      margin: 0;
      padding: 8px 0;
    }

    .ai-comment-info .comment-stats {
      color: #718096;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .ai-highlight {
      color: #667eea;
      font-weight: 600;
    }

    .ai-generated-comment:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(74, 108, 247, 0.15);
      transition: all 0.3s ease;
    }

    .ai-comment-icon:hover {
      transform: scale(1.05);
      transition: transform 0.3s ease;
    }
  </style>
</head>
<body>
<div id="app">
  <!-- 新增：加载遮罩层 -->
  <div class="loading-mask" :class="{ hidden: !isLoading }">
    <div class="loading-spinner"></div>
    <div class="loading-text">正在加载店铺详情</div>
    <div class="loading-subtext">请稍候...</div>
  </div>

  <div class="header">
    <div class="header-back-btn" @click="goBack"><i class="el-icon-arrow-left"></i></div>
    <div class="header-title"></div>
    <div class="header-share">...</div>
  </div>
  <div style="height: calc(100% - 70px); overflow-y: scroll; overflow-x: hidden;">
    <!-- 内容区高度 = 屏幕高度 - 底部栏高度（70px），避免被底部栏遮挡 -->
    <div class="top-bar"></div>
    <div class="shop-info-box">
      <div class="shop-title">{{shop.name}}</div>
      <div class="shop-rate">
        <el-rate
                disabled v-model="shop.score/10"
                text-color="#F63"
                show-score
        ></el-rate>
        <span>{{shop.comments}}条</span>
      </div>
      <div class="shop-rate-info"> 口味:4.9  环境:4.8  服务:4.7 </div>
      <div class="shop-rank">
        <img src="/imgs/bd.png" width="63" height="20" alt="">
        <span>拱墅区好评榜第3名</span>
        <div><i class="el-icon-arrow-right"></i></div>
      </div>
      <div class="shop-images">
        <div v-for="(s,i) in shop.images" :key="i">
          <img :src="s" alt="">
        </div>
      </div>
      <div class="shop-address">
        <div><i class="el-icon-map-location"></i></div>
        <span>{{shop.address}}</span>
        <div style="width: 10px; flex-grow: 2; text-align: center; color: #e1e2e3">|</div>
        <div style="margin: 0 5px"><img src="https://p0.meituan.net/travelcube/bf684aa196c870810655e45b1e52ce843484.png@24w_16h_40q" alt=""></div>
        <div><img src="https://p0.meituan.net/travelcube/9277ace32123e0c9f59dedf4407892221566.png@24w_24h_40q" alt=""></div>
      </div>
    </div>
    <div class="shop-divider"></div>
    <div class="shop-open-time">
      <span><i class="el-icon-watch"></i></span>
      <div>营业时间</div>
      <div>{{shop.openHours}}</div>
      <span class="line-right">查看详情 <i class="el-icon-arrow-right"></i></span>
    </div>
    <div class="shop-divider"></div>
    <div class="shop-voucher">
      <div>
        <span class="voucher-icon">券</span>
        <span style="font-weight: bold;">代金券</span>
      </div>
      <div class="voucher-box" v-for="v in vouchers" :key="v.id" v-if="!isEnd(v)">
        <div class="voucher-circle">
          <div class="voucher-b"></div>
          <div class="voucher-b"></div>
          <div class="voucher-b"></div>
        </div>
        <div class="voucher-left">
          <div class="voucher-title">{{v.title}}</div>
          <div class="voucher-subtitle">{{v.subTitle}}</div>
          <div class="voucher-price"><div>￥ {{util.formatPrice(v.payValue)}}</div>  <span>{{(v.payValue*10)/v.actualValue}}折</span></div>
        </div>
        <div class="voucher-right">
          <div v-if="v.type==1" class="seckill-box">
            <div class="voucher-btn" :class="{'disable-btn': isNotBegin(v) || v.stock < 1}" @click="seckill(v)">限时抢购</div>
            <div class="seckill-stock">剩余 <span>{{v.stock}}</span> 张</div>
            <div class="seckill-time">{{formatTime(v)}}</div>
          </div>
          <div class="voucher-btn" v-else @click="buy(v)">抢购</div>
        </div>
      </div>
    </div>
    <div class="shop-divider"></div>
    <div class="shop-comments" v-show="this.comments!=0" >
      <div class="comments-head" >
        <div>网友评价 <span>({{shop.comments || 119}})</span></div>
      </div>
      <div class="comment-tags">
        <div class="tag">味道赞(19)</div>
        <div class="tag">牛肉赞(16)</div>
        <div class="tag">菜品不错(11)</div>
        <div class="tag">回头客(4)</div>
        <div class="tag">分量足(4)</div>
        <div class="tag">停车方便(3)</div>
        <div class="tag">海鲜棒(3)</div>
        <div class="tag">饮品赞(3)</div>
        <div class="tag">朋友聚餐(6)</div>
      </div>
      <div class="comment-list">
        <!-- AI生成的评论 -->
        <div class="comment-box ai-generated-comment" v-if="aiComment && aiComment.content">
          <div class="comment-icon ai-comment-icon">
            <i class="el-icon-magic"></i>
          </div>
          <div class="comment-info ai-comment-info">
            <div class="comment-user">
              智评助手
              <span class="ai-verified">
              <i class="el-icon-check"></i>
              官方认证
            </span>
            </div>
            <div class="comment-content">{{aiComment.content}}</div>
            <div class="comment-stats">
              <span class="ai-highlight">{{aiComment.createTime}}</span>
            </div>
          </div>
          <div class="ai-generated-badge">AI生成</div>
        </div>

        <!-- 普通用户评论 -->
        <div class="comment-box" v-for="comment in comments" :key="comment">
          <div class="comment-icon">
            <img :src="comment.userIcon || '/imgs/icons/default-icon.png'" alt="">
          </div>
          <div class="comment-info">
            <div class="comment-user">
              {{comment.nickName || '匿名用户'}}
              <span>Lv{{comment.userLevel || 1}}</span>
            </div>
            <div style="display: flex; align-items: center; margin-bottom: 8px;">
              <el-rate disabled v-model="comment.rating" style="margin-right: 8px;"></el-rate>
              <span style="font-size: 12px; color: #ff6633;">{{comment.rating}}分</span>
            </div>
            <div class="comment-content">{{comment.content}}</div>

            <div class="comment-images" v-if="comment.images && comment.images.length > 0">
              <img
                      v-for="(img, index) in comment.images"
                      :key="index"
                      :src="img"
                      alt="评论图片"
                      @click="previewImage(comment.images, index)"
              >
            </div>

            <div class="comment-stats">
              {{comment.createTime}} ·
              浏览{{comment.viewCount || 0}} ·
              评论{{comment.replyCount || 0}}
            </div>
          </div>
        </div>
        <div
                style="display: flex; justify-content: space-between;padding: 15px 0; border-top: 1px solid #f1f1f1; margin-top: 10px;">
          <div @click="viewAllComments">查看全部{{shop.comments || 119}}条评价</div>
          <div><i class="el-icon-arrow-right"></i></div>
        </div>
      </div>
    </div>
    <div v-show="this.comments==0" class="shop-comments" >
      暂无评论，快来发表第一条评论吧～
    </div>
    <div class="shop-divider"></div>
    <div class="copyright">
      copyright ©2021 mumulin.com
    </div>
  </div>

  <!-- ====================================== 核心修改：底部栏（使用main.css.foot-bar结构） ====================================== -->
  <div class="foot-bar">
    <!-- 收藏按钮（原关注按钮，适配main.css样式） -->
    <div
            class="foot-item follow-btn"
            @click="toggleFollowShop"
            :class="{active: isShopFollowed, loading: isFollowLoading}"
            :disabled="isFollowLoading"
    >
      <div class="foot-icon">
        <i class="el-icon-star-off" v-if="!isShopFollowed && !isFollowLoading"></i>
        <i class="el-icon-star-on" v-if="isShopFollowed && !isFollowLoading"></i>
        <i class="el-icon-loading" v-if="isFollowLoading"></i>
      </div>
      <div class="foot-text" v-if="!isFollowLoading">
        {{isShopFollowed ? '已收藏' : '收藏'}}
      </div>
      <div class="foot-text" v-if="isFollowLoading">
        {{isShopFollowed ? '取消中...' : '收藏中...'}}
      </div>
    </div>

    <!-- 评论按钮（适配main.css样式） -->
    <div
            class="foot-item comment-btn"
            @click="checkLogin"
            :class="{disabled: !token}"
    >
      <div class="foot-icon">
        <i class="el-icon-edit"></i>
      </div>
      <div class="foot-text">
        发表评价
      </div>
    </div>
  </div>

  <!-- 评论模态框（原有代码未修改） -->
  <div class="comment-modal" v-if="showCommentPublish" @click="closeCommentModal">
    <div class="comment-modal-content" @click.stop>
      <div class="comment-publish">
        <div class="publish-header">
          <div class="publish-avatar">
            <img :src="user.icon || '/imgs/icons/default-icon.png'" alt="头像">
          </div>
          <div class="publish-user">
            <div class="username">{{user.nickName || '我'}}</div>
          </div>
          <div class="close-btn" @click="closeCommentModal">
            <i class="el-icon-close"></i>
          </div>
        </div>

        <div class="publish-content">
          <div class="publish-textarea">
          <textarea
                  v-model="commentText"
                  placeholder="说点什么..."
                  rows="4"
                  maxlength="500"
                  @focus="onTextareaFocus"
                  @blur="onTextareaBlur"
          ></textarea>
            <div class="text-count">{{commentText.length}}/500</div>
          </div>

          <div class="publish-images" v-if="selectedImages.length > 0 || isTextareaFocused">
            <div class="image-upload" @click="triggerImageUpload">
              <i class="el-icon-plus"></i>
              <input
                      type="file"
                      ref="imageInput"
                      multiple
                      accept="image/*"
                      @change="handleImageUpload"
                      style="display: none"
              >
            </div>

            <div
                    class="image-preview"
                    v-for="(image, index) in selectedImages"
                    :key="index"
            >
              <img :src="image.url" alt="预览图片" @click="previewImage(selectedImages.map(image => image.url).join(','),index)">
              <div class="image-remove" @click.stop="removeImage(index)">
                <i class="el-icon-close"></i>
              </div>
            </div>
          </div>

          <div class="publish-actions">
            <div class="action-left">
              <div class="rate-section">
                <span style="margin-right: 8px; color: #666; font-size: 14px;">打分</span>
                <el-rate
                        v-model="commentRating"
                        :colors="['#99A9BF', '#F7BA2A', '#FF9900']"
                ></el-rate>
              </div>
            </div>

            <div class="action-right">
              <button
                      class="publish-btn cancel-btn"
                      @click="cancelPublish"
              >
                取消
              </button>
              <button
                      class="publish-btn submit-btn"
                      :class="{disabled: !commentText.trim()}"
                      :disabled="!commentText.trim()"
                      @click="publishComment"
              >
                发布
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 图片预览层（原有代码未修改） -->
  <div class="image-preview-layer" v-if="showImagePreview" @click="closeImagePreview">
    <div class="preview-container" @click.stop>
      <div class="preview-header">
        <span class="preview-title">图片预览</span>
        <i class="el-icon-close close-btn" @click="closeImagePreview"></i>
      </div>
      <div class="preview-content">
        <img :src="currentPreviewImage" alt="预览图片" class="preview-image">
      </div>
      <div class="preview-footer">
        <div class="preview-nav">
          <button class="nav-btn" @click="prevImage" :disabled="currentPreviewIndex === 0">
            <i class="el-icon-arrow-left"></i>
          </button>
          <span class="preview-counter">{{ currentPreviewIndex + 1 }} / {{ previewImages.length }}</span>
          <button class="nav-btn" @click="nextImage" :disabled="currentPreviewIndex === previewImages.length - 1">
            <i class="el-icon-arrow-right"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

</div>
</body>
<script src="./js/vue.js"></script>
<script src="./js/axios.min.js"></script>
<!-- 引入组件库 -->
<script src="./js/element.js"></script>
<script src="./js/common.js"></script>
<script>
  const app = new Vue({
    el: "#app",
    data: {
      util,
      shop: {},
      vouchers: [],
      showCommentPublish: false,
      commentText: '',
      commentRating: 5,
      selectedImages: [],
      isTextareaFocused: false,
      comment: {
        sourceId: null,
        sourceType: null,
        content: '',
        userId: null,
        parentId: null,
        answerId: null,
        images: '',
        rating: null,
      },
      aiComment: {},
      comments: [],
      user: {},
      // 图片预览相关
      showImagePreview: false,
      previewImages: [],
      currentPreviewIndex: 0,
      currentPreviewImage: '',
      // 收藏按钮相关（原关注按钮，名称适配）
      isShopFollowed: false,
      isFollowLoading: false,
      // 登录状态
      token: sessionStorage.getItem("token") || '',
      // 分页加载相关（补充缺失变量）
      loading: false,
      noMore: false,
      page: 1,
      // 新增：加载状态控制
      isLoading: true,
      // 数据加载完成计数器
      dataLoadedCount: 0,
      // 需要加载的数据总数
      totalDataToLoad: 3 // 店铺信息、优惠券、评论
    },
    created() {
      // 获取参数
      let shopId = util.getUrlParam("id");

      // 查询所有数据
      this.queryShopById(shopId);
      this.queryVoucher(shopId);
      this.loadComments(shopId);
      this.isLogin();
    },
    methods: {
      isLogin(){
        if (this.token) {
          this.queryLoginUser();
          setTimeout(() => {
            this.isFollowed();
          }, 100);        }
      },
      // 新增：数据加载完成回调
      onDataLoaded() {
        this.dataLoadedCount++;
        console.log(`数据加载进度: ${this.dataLoadedCount}/${this.totalDataToLoad}`);

        // 当所有数据加载完成时隐藏遮罩层
        if (this.dataLoadedCount >= this.totalDataToLoad) {
          setTimeout(() => {
            this.isLoading = false;
            console.log('所有数据加载完成，隐藏遮罩层');
          }, 500); // 延迟500ms隐藏，让用户看到加载完成
        }
      },

      goBack() {
        history.back();
      },
      queryLoginUser(){
        // 查询用户信息
        axios.get("/app/user/me")
                .then(({ data }) => {
                  this.user = data;
                  this.user.icon=fileURL+this.user.icon;
                })
                .catch(error => {
                  console.log('获取用户信息失败:', error);
                })
      },
      queryShopById(shopId) {
        axios.get("/app/shop/" + shopId)
                .then(({data}) => {
                  data.images = data.images.split(",")
                  data.images = data.images.map(image => fileURL + image);
                  this.shop = data
                  this.onDataLoaded(); // 新增：数据加载完成回调
                })
                .catch(error => {
                  this.$message.error('获取店铺信息失败');
                  this.onDataLoaded(); // 新增：即使失败也回调
                })
      },
      queryVoucher(shopId) {
        axios.get("/app/marketing/voucher/list/" + shopId)
                .then(({data}) => {
                  this.vouchers = data;
                  this.onDataLoaded(); // 新增：数据加载完成回调
                })
                .catch(error => {
                  this.$message.error('获取优惠券失败');
                  this.onDataLoaded(); // 新增：即使失败也回调
                })
      },
      formatTime(v) {
        let b = new Date(v.beginTime);
        let e = new Date(v.endTime);
        return b.getMonth() + 1 + "月" + b.getDate() + "日 "
                + b.getHours() + ":" + this.formatMinutes(b.getMinutes())
                + " ~ " + (e.getMonth() + 1) + "月" + e.getDate() + "日 "
                + e.getHours() + ":" + this.formatMinutes(e.getMinutes());
      },
      formatMinutes(m) {
        if (m < 10) m = "0" + m
        return m;
      },
      isNotBegin(v) {
        return new Date(v.beginTime).getTime() > new Date().getTime();
      },
      isEnd(v) {
        return new Date(v.endTime).getTime() < new Date().getTime();
      },
      seckill(v) {
        if (!this.token) {
          this.$message.error("请先登录")
          setTimeout(() => {
            location.href = "/login.html"
          }, 200);
          return;
        }
        if (this.isNotBegin(v)) {
          this.$message.error("优惠券抢购尚未开始！")
          return;
        }
        if (this.isEnd(v)) {
          this.$message.error("优惠券抢购已经结束！")
          return;
        }
        if (v.stock < 1) {
          this.$message.error("库存不足，请刷新再试试！")
          return;
        }
        let id = v.id;
        axios.post("/app/marketing/voucher/seckill/" + id)
                .then(({data}) => {
                  this.$message.success("抢购成功，订单id：" + data)
                })
                .catch(this.$message.error)
      },
      buy(v) {
        if (!this.token) {
          this.$message.error("请先登录")
          setTimeout(() => {
            location.href = "/login.html"
          }, 200);
          return;
        }
        axios.post("/app/marketing/voucher/buy/" + v.id)
                .then(({data}) => {
                  this.$message.success("抢购成功，订单id：" + data)
                })
                .catch(this.$message.error)
      },
      viewAllComments() {
        location.href = "/comment-list.html?shopId=" + this.shop.id;
      },
      triggerImageUpload() {
        this.$refs.imageInput.click();
      },
      async handleImageUpload(event) {
        const files = event.target.files;
        if (files.length + this.selectedImages.length > 9) {
          this.$message.error('最多只能上传9张图片');
          return;
        }

        for (let file of files) {
          if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            let url=await this.fileSelected(file)
            reader.onload = (e) => {
              this.selectedImages.push({
                file: file,
                url: url
              });
            };
            reader.readAsDataURL(file);
          }
        }
      },
      removeImage(index) {
        this.selectedImages.splice(index, 1);
      },
      onTextareaFocus() {
        this.isTextareaFocused = true;
      },
      onTextareaBlur() {
        setTimeout(() => {
          if (!this.commentText) {
            this.isTextareaFocused = false;
          }
        }, 200);
      },
      previewImage(images, index) {
        console.log('预览图片:', images, '类型:', typeof images);
        let imageArray = [];

        if (Array.isArray(images)) {
          imageArray = images;
        } else if (typeof images === 'string' && images.trim() !== '') {
          imageArray = images.split(',').map(img => img.trim()).filter(img => img !== '');
        }

        if (!imageArray || imageArray.length === 0) {
          this.$message.warning('没有可预览的图片');
          return;
        }

        this.previewImages = imageArray.map(img => {
          if (img.startsWith('http')) {
            return img;
          } else {
            return `http://192.168.182.20:9000${img.startsWith('/') ? '' : '/'}${img}`;
          }
        });
        this.currentPreviewIndex = index;
        this.currentPreviewImage = this.previewImages[index];
        this.showImagePreview = true;
      },
      closeImagePreview() {
        this.showImagePreview = false;
        this.previewImages = [];
        this.currentPreviewIndex = 0;
        this.currentPreviewImage = '';
      },
      prevImage() {
        if (this.currentPreviewIndex > 0) {
          this.currentPreviewIndex--;
          this.currentPreviewImage = this.previewImages[this.currentPreviewIndex];
        }
      },
      nextImage() {
        if (this.currentPreviewIndex < this.previewImages.length - 1) {
          this.currentPreviewIndex++;
          this.currentPreviewImage = this.previewImages[this.currentPreviewIndex];
        }
      },
      closeCommentModal() {
        this.showCommentPublish = false;
        this.cancelPublish();
      },
      publishComment() {
        if (!this.commentText.trim()) {
          this.$message.error('请输入评价内容');
          return;
        }

        this.comment.content=this.commentText
        this.comment.rating=this.commentRating
        this.comment.sourceId=this.shop.id
        this.comment.sourceType=2
        this.comment.userId=this.user.id
        this.comment.parentId=0
        this.comment.answerId=0
        this.comment.images=this.selectedImages.map(image => image.url.split(filePrefix)[1] || image.url).join(',');
        axios.post('/app/comment/addComment', this.comment)
                .then(({data}) => {
                  this.$message.success('评价发布成功');
                  this.commentText = '';
                  this.commentRating = 5;
                  this.selectedImages = [];
                  this.showCommentPublish = false;
                  this.loadComments(this.shop.id);
                  this.queryShopById(this.shop.id);
                })
                .catch(error => {
                  this.$message.error('发布失败，请重试');
                  console.error(error);
                });
      },
      cancelPublish() {
        this.commentText = '';
        this.commentRating = 5;
        this.selectedImages = [];
        this.isTextareaFocused = false;
        this.showCommentPublish = false;
      },
      async fileSelected(file) {
        let formData = new FormData();
        formData.append("file", file);

        const config = {
          headers: {
          },
          timeout: 30000
        };
        let url
        await axios.post("/app/file/appUpload", formData, config)
                .then(({data}) =>url=data)
                .catch(this.$message.error);
        return url
      },
      async loadComments(id) {
        if (this.loading || this.noMore) return;

        this.loading = true;
        try {
          const response = await axios.get("/app/comment/listComment", {
            params: {
              sourceId: id,
              sourceType: 2,
              current: this.page
            }
          });

          const newComments = response.data.list || response.data;
          newComments.forEach(comment => {
            comment.userIcon=fileURL+comment.userIcon
            if (comment.images != "" && comment.images != null) {
              comment.images = comment.images.split(",")
              comment.images=comment.images.map(image => fileURL + image);

            }});
          if (newComments.length === 0) {
            this.noMore = true;
          } else {
            this.comments = [...this.comments, ...newComments];
            this.comments.forEach(comment => {
              if(comment.isAIGenerated===true){
                this.aiComment= comment
              }
            })
            this.comments = this.comments.slice(0, 3)
            this.page++;
          }
          this.onDataLoaded(); // 新增：数据加载完成回调
        } catch (error) {
          console.error('加载评论失败:', error);
          this.$message.error('加载评论失败');
          this.onDataLoaded(); // 新增：即使失败也回调
        } finally {
          this.loading = false;
        }
      },
      checkLogin() {
        if (!this.token) {
          this.$message.error("请先登录");
          setTimeout(() => {
            location.href = "login.html"
          }, 200);
          return;
        }
        this.showCommentPublish = true
      },
      isFollowed(){
        if (!this.shop.id) return; // 确保shop.id已存在
        axios.get("/app/follow/followShop/isFollow/" + this.shop.id)
                .then(({data}) => {
                  this.isShopFollowed = data;
                })
                .catch(error => {
                })
      },
      // 收藏按钮逻辑
      toggleFollowShop() {
        if (!this.token) {
          this.$message.error("请先登录");
          setTimeout(() => {
            location.href = "/login.html";
          }, 200);
          return;
        }

        if (this.isFollowLoading) return;

        const shopId = this.shop.id;
        const followStatus = !this.isShopFollowed;

        this.isFollowLoading = true;

        axios.put('/app/follow/followShop/'+ shopId + "/" + followStatus)
                .then(({data}) => {
                  // 文案改为"收藏"相关，适配按钮功能
                  const successMsg = followStatus ? '收藏店铺成功，已添加到你的收藏夹～' : '已取消店铺收藏';
                  this.$message.success(successMsg);
                  this.isShopFollowed = followStatus;
                })
                .catch(error => {
                  const errorMsg = followStatus ? '收藏失败，请重试' : '取消收藏失败，请重试';
                  this.$message.error(errorMsg);
                  console.error(error);
                })
                .finally(() => {
                  this.isFollowLoading = false;
                });
      }
    }
  })
</script>
</body>
</html>