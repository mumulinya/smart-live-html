<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <title>智评生活 - 私聊</title>
  <link rel="stylesheet" href="./css/element.css">
  <link href="./css/main.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style type="text/css">
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; padding: 0; background-color: #f5f5f5; }
    .header { display: flex; align-items: center; justify-content: space-between; padding: 15px; border-bottom: 1px solid #e1e1e1; background-color: #f7f7f7; position: sticky; top: 0; z-index: 100; }
    .header-back-btn { font-size: 20px; color: #333; cursor: pointer; display: flex; align-items: center; }
    .header-title { font-size: 18px; font-weight: bold; flex: 1; text-align: center; }
    .chat-messages { height: calc(100vh - 210px); padding: 15px; overflow-y: auto; display: flex; flex-direction: column; background-color: #eaeaea; }
    .message-container { display: flex; margin-bottom: 15px; max-width: 100%; }
    .message-container-left { flex-direction: row; }
    .message-container-right { flex-direction: row-reverse; }
    .avatar { width: 40px; height: 40px; border-radius: 50%; margin: 0 10px; background-color: #ddd; display: flex; align-items: center; justify-content: center; color: #fff; font-weight: bold; font-size: 16px; overflow: hidden; flex-shrink: 0; }
    .avatar img { width: 100%; height: 100%; object-fit: cover; }
    .avatar-fallback { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background-color: #07c160; color: white; }
    .avatar-left .avatar-fallback { background-color: #07c160; }
    .avatar-right .avatar-fallback { background-color: #ff6633; }
    .message-content { display: flex; flex-direction: column; max-width: 70%; }
    .message { padding: 10px 15px; border-radius: 5px; word-wrap: break-word; position: relative; font-size: 16px; line-height: 1.4; }
    .message-left { background-color: #fff; border-top-left-radius: 0; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }
    .message-right { background-color: #95ec69; border-top-right-radius: 0; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }
    .time-separator { text-align: center; margin: 15px 0; position: relative; }
    .time-separator::before { content: ""; position: absolute; top: 50%; left: 0; right: 0; height: 1px; background-color: #e0e0e0; z-index: 1; }
    .time-label { display: inline-block; background-color: #d8d8d8; padding: 3px 10px; border-radius: 10px; font-size: 12px; color: #666; position: relative; z-index: 2; }
    .system-message { background-color: #f0f0f0; align-self: center; max-width: 80%; border-radius: 10px; margin: 5px 0; padding: 5px 10px; font-size: 12px; text-align: center; color: #999; }
    .chat-input { padding: 10px 15px; border-top: 1px solid #e1e1e1; display: flex; background-color: #f7f7f7; }
    .chat-input input { flex: 1; padding: 10px 15px; border: 1px solid #ddd; border-radius: 20px; margin-right: 10px; font-size: 16px; outline: none; }
    .chat-input button { padding: 10px 20px; background-color: #07c160; color: white; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; font-size: 16px; }
    .chat-input button:disabled { background-color: #cccccc; cursor: not-allowed; opacity: 0.6; }
    .global-loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; font-size: 16px; color: #666; }
    .loading-spinner { width: 40px; height: 40px; border: 3px solid #f3f3f3; border-top: 3px solid #07c160; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 16px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .loading-text { margin-top: 12px; font-size: 14px; color: #999; }
    .refresh-loading { position: sticky; top: 60px; background: #fff; padding: 12px; text-align: center; border-bottom: 1px solid #f0f0f0; z-index: 100; font-size: 14px; color: #666; }
    .refresh-loading .el-icon-loading { margin-right: 8px; color: #07c160; }
    .loading { text-align: center; padding: 20px; color: #999; font-size: 14px; }
    .no-more { text-align: center; padding: 20px; color: #999; font-size: 14px; }
    .empty-messages { text-align: center; padding: 60px 20px; color: #999; }
    .empty-messages i { font-size: 48px; margin-bottom: 16px; color: #ddd; }
  </style>
</head>
<body>
<div id="app">
  <div class="global-loading" v-if="pageLoading">
    <div class="loading-spinner"></div>
    <div class="loading-text">{{loadingText}}</div>
  </div>

  <div class="refresh-loading" v-if="refreshLoading && !pageLoading">
    <i class="el-icon-loading"></i> {{loadingText}}
  </div>

  <div class="header">
    <div class="header-back-btn" @click="goBack">
      <i class="el-icon-arrow-left"></i>
      <span style="margin-left: 5px; font-size: 16px;"></span>
    </div>
    <div class="header-title">{{contactName}}</div>
    <div style="width: 20px;"></div>
  </div>

  <div class="chat-messages" ref="chatMessages" @scroll="handleScroll">
    <div v-if="messages.length === 0 && !loading" class="empty-messages">
      <i class="el-icon-chat-round"></i>
      <div>暂无消息，开始聊天吧～</div>
    </div>

    <template v-for="(msgGroup, index) in groupedMessages">
      <div v-if="msgGroup.showTime" :key="'time-' + index" class="time-separator">
        <span class="time-label">{{ formatGroupTime(msgGroup.time) }}</span>
      </div>

      <div v-for="msg in msgGroup.messages" :key="msg.id"
           class="message-container"
           :class="{'message-container-left': !msg.isSelf, 'message-container-right': msg.isSelf}">

        <div class="avatar" :class="{'avatar-left': !msg.isSelf, 'avatar-right': msg.isSelf}">
          <img v-if="msg.isSelf" class="avatar-image" :src="user.icon" :alt="user.icon" @error="handleAvatarError">
          <img v-else class="avatar-image" :src="contactAvatar" :alt="contactAvatar" @error="handleAvatarError">
        </div>

        <div class="message-content">
          <div v-if="!msg.isSystem" class="message" :class="{'message-left': !msg.isSelf, 'message-right': msg.isSelf}">
            {{msg.content}}
          </div>
        </div>
      </div>
    </template>

    <div v-if="msg.isSystem" class="system-message" v-for="msg in systemMessages" :key="msg.id">
      {{msg.content}}
    </div>

    <div v-if="loading" class="loading">
      <i class="el-icon-loading"></i> 加载中...
    </div>
  </div>

  <div class="chat-input">
    <input type="text" v-model="messageInput" @keyup.enter="sendMessage" placeholder="输入消息...">
    <button @click="sendMessage" :disabled="isSendDisabled">发送</button>
  </div>

  <foot-bar :active-btn="3"></foot-bar>
</div>

<script src="./js/vue.js"></script>
<script src="./js/axios.min.js"></script>
<script src="./js/element.js"></script>
<script src="./js/common.js"></script>
<script src="./js/footer.js"></script>
<script>
  const app = new Vue({
    el: "#app",
    data: {
      sessionId: 0,
      fromUid: 0,
      toUid: 0,
      contactName: "加载中...",
      contactAvatar: "",
      messages: [],
      messageInput: "",
      loading: false,
      noMore: false,
      current: 1,
      pageLoading: false,
      refreshLoading: false,
      firstLoad: true,
      loadingText: '正在加载...',
      user: {},
      contactUser: {},
      userAvatarMap: new Map(),
      isSending: false,
      autoScroll: true,
      isAtBottom: true, // 新增：判断是否在底部
    },
    mounted() {
      // 首次加载后滚动到底部
      this.loadChatMessagesWithLoading();
    },
    computed: {
      groupedMessages() {
        const groups = [];
        let currentGroup = null;
        const normalMessages = this.messages.filter(msg => !msg.isSystem);
        normalMessages.forEach(msg => {
          const groupTime = this.getGroupTime(msg.createTime);
          if (!currentGroup || currentGroup.time !== groupTime) {
            currentGroup = {
              time: groupTime,
              messages: [],
              showTime: true
            };
            groups.push(currentGroup);
          }
          currentGroup.messages.push(msg);
        });
        return groups;
      },
      systemMessages() {
        return this.messages.filter(msg => msg.isSystem);
      },
      isSendDisabled() {
        return !this.messageInput || this.messageInput.trim() === '' || this.isSending;
      }
    },
    created() {
      this.sessionId = util.getUrlParam("sessionId");
      this.getChatSession();
      this.handlePageRefresh();
      this.queryLoginUser();
    },
    mounted() {
      this.scrollToBottom();
    },
    methods: {
      showPageLoading(text = '正在加载...') {
        this.pageLoading = true;
        this.loadingText = text;
      },
      hidePageLoading() {
        this.pageLoading = false;
        this.refreshLoading = false;
      },
      showRefreshLoading(text = '正在刷新...') {
        this.refreshLoading = true;
        this.loadingText = text;
      },
      handlePageRefresh() {
        if (this.firstLoad) {
          this.showPageLoading('正在加载聊天消息...');
          this.firstLoad = false;
        } else {
          this.showRefreshLoading('正在刷新...');
        }
        setTimeout(() => {
          this.hidePageLoading();
        }, 800);
      },
      async queryLoginUser() {
        try {
          await axios.get("/app/user/me")
                  .then(({ data }) => {
                    this.user = data;
                  });
        } catch (error) {
          console.log(error);
          this.hidePageLoading();
        }
      },
      async loadChatMessagesWithLoading() {
        if (this.loading) return;

        this.loading = true;

        try {
          const response = await axios.get('/app/chat/message/list', {
            params: {
              sessionId: this.sessionId,
              current: 1
            }
          });

          const newMessages = response.data || [];

          if (newMessages.length === 0) {
            this.messages = [];
            this.noMore = true;
          } else {
            const processedMessages = newMessages.map(msg => ({
              ...msg,
              isSelf: msg.fromUid === this.user.id,
              isSystem: msg.messageType === 'system'
            }));

            this.messages = processedMessages;
            this.current = 1;
            this.noMore = false;

            // 首次加载后滚动到底部
            this.scrollToBottom();
          }
        } catch (error) {
          console.error('加载聊天消息失败:', error);
        } finally {
          this.loading = false;
          this.hidePageLoading();
        }
      },
      async getChatSession() {
        try {
          const response = await axios.get('/app/chat/chatSession', {
            params: {
              sessionId: this.sessionId
            }
          });
          const sessionInfo = response.data;
          this.contactName = sessionInfo.contactName || '未知用户';
          this.contactAvatar = sessionInfo.contactAvatar;
          this.fromUid = sessionInfo.fromUid;
          this.toUid = sessionInfo.toUid;

          await this.loadChatMessagesWithLoading();
        } catch (error) {
          console.error('获取会话信息失败:', error);
          this.$message.error('获取会话信息失败');
          this.hidePageLoading();
        }
      },
      getGroupTime(timeStr) {
        if (!timeStr) return '';
        try {
          const date = new Date(timeStr);
          const now = new Date();
          const diff = now - date;

          if (date.toDateString() === now.toDateString()) {
            return date.getHours().toString().padStart(2, '0') + ':' + date.getMinutes().toString().padStart(2, '0');
          } else if (date.toDateString() === new Date(now - 86400000).toDateString()) {
            return '昨天 ' + date.getHours().toString().padStart(2, '0') + ':' + date.getMinutes().toString().padStart(2, '0');
          } else {
            return date.getFullYear() + '年' + (date.getMonth() + 1) + '月' + date.getDate() + '日';
          }
        } catch (e) {
          return timeStr;
        }
      },
      formatGroupTime(groupTime) {
        return groupTime;
      },
      scrollToBottom() {
        this.$nextTick(() => {
          const container = this.$refs.chatMessages;
          if (container) {
            container.scrollTop = container.scrollHeight;
            this.isAtBottom = true;
          }
        });
      },
      async sendMessage() {
        // 检查禁用状态
        if (this.isSendDisabled) {
          console.log('发送按钮被禁用');
          return;
        }

        const content = this.messageInput.trim();
        if (!content) {
          console.log('消息内容为空');
          return;
        }

        console.log('开始发送消息:', content);
        this.isSending = true;

        try {
          // 立即更新UI，提升用户体验
          const tempMessage = {
            id: Date.now(),
            sessionId: this.sessionId,
            fromUid: this.user.id,
            toUid: this.toUid,
            content: content,
            createTime: new Date().toISOString(),
            isSelf: true,
            isSystem: false
          };

          this.messages.push(tempMessage);
          this.messageInput = '';

          // 滚动到底部
          this.$nextTick(() => {
            this.scrollToBottom();
          });

          // 发送请求到后端
          console.log('发送请求到后端...');
          const response = await axios.post('/app/chat/message/send', {
            sessionId: this.sessionId,
            fromUid: this.user.id,
            toUid: this.toUid,
            content: content,
            messageType: 'text'
          });

          console.log('收到响应:', response);

          if (response && response.data) {
            if (response.data.code === 200) {
              this.$message.success('消息发送成功');
            } else {
              const errorMsg = response.data.msg || '发送失败';
              this.$message.error(errorMsg);
            }
          } else {
            console.error('响应数据异常:', response);
            this.$message.error('服务器响应异常');
          }

        } catch (error) {
          console.error('发送消息捕获到错误:', error);
          this.$message.error('发送消息失败: ' + (error.message || '未知错误'));
        } finally {
          this.isSending = false;
          console.log('发送流程结束');
        }
      },
      goBack() {
        location.href = "/chat-list.html";
      },
      handleScroll() {
        const container = this.$refs.chatMessages;
        if (!container) return;

        const scrollTop = container.scrollTop;
        const scrollHeight = container.scrollHeight;
        const clientHeight = container.clientHeight;

        // 判断是否在底部
        this.isAtBottom = (scrollHeight - scrollTop - clientHeight) <= 50;

        // 滚动到顶部时加载更多历史消息
        if (scrollTop === 0 && !this.loading && !this.noMore) {
          this.loadMoreMessages();
        }
      },
      async loadMoreMessages() {
        if (this.loading || this.noMore) return;

        this.loading = true;
        const oldScrollHeight = this.$refs.chatMessages.scrollHeight;

        try {
          const nextPage = this.current + 1;
          const response = await axios.get('/app/chat/message/list', {
            params: {
              sessionId: this.sessionId,
              current: nextPage
            }
          });

          const newMessages = response.data || [];

          if (newMessages.length === 0) {
            this.noMore = true;
            return;
          }

          const processedMessages = newMessages.map(msg => ({
            ...msg,
            isSelf: msg.fromUid === this.user.id,
            isSystem: msg.messageType === 'system'
          }));

          // 历史消息插入到列表开头
          this.messages = [...processedMessages, ...this.messages];
          this.current = nextPage;

          // 保持滚动位置
          this.$nextTick(() => {
            const container = this.$refs.chatMessages;
            const newScrollHeight = container.scrollHeight;
            container.scrollTop = newScrollHeight - oldScrollHeight;
          });

        } catch (error) {
          console.error('加载历史消息失败:', error);
        } finally {
          this.loading = false;
        }
      },
      refreshMessages() {
        this.messages = [];
        this.current = 1;
        this.noMore = false;
        this.loadChatMessagesWithLoading();
      },
      handleAvatarError(event) {
        event.target.style.display = 'none';
        const avatarElement = event.target.parentElement;
        const fallback = document.createElement('div');
        fallback.className = 'avatar-fallback';
        const displayName = event.target.alt || '用户';
        fallback.textContent = displayName.charAt(0).toUpperCase();
        avatarElement.appendChild(fallback);
      }
    }
  });
</script>
</body>
</html>